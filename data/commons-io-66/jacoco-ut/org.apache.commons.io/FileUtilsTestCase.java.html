<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>FileUtilsTestCase.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">commons_io$Test.exec</a> &gt; <a href="index.source.html" class="el_package">org.apache.commons.io</a> &gt; <span class="el_source">FileUtilsTestCase.java</span></div><h1>FileUtilsTestCase.java</h1><pre class="source lang-java linenums">/*
 * Licensed to the Apache Software Foundation (ASF) under one or more
 * contributor license agreements.  See the NOTICE file distributed with
 * this work for additional information regarding copyright ownership.
 * The ASF licenses this file to You under the Apache License, Version 2.0
 * (the &quot;License&quot;); you may not use this file except in compliance with
 * the License.  You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package org.apache.commons.io;

import static org.junit.Assert.assertEquals;
import static org.junit.Assert.assertFalse;
import static org.junit.Assert.assertNotNull;
import static org.junit.Assert.assertNull;
import static org.junit.Assert.assertSame;
import static org.junit.Assert.assertTrue;
import static org.junit.Assert.fail;

import java.io.BufferedOutputStream;
import java.io.ByteArrayOutputStream;
import java.io.File;
import java.io.FileInputStream;
import java.io.FileNotFoundException;
import java.io.FileOutputStream;
import java.io.IOException;
import java.io.OutputStream;
import java.math.BigInteger;
import java.net.URL;
import java.nio.charset.Charset;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Collection;
import java.util.Collections;
import java.util.Date;
import java.util.GregorianCalendar;
import java.util.HashMap;
import java.util.Iterator;
import java.util.List;
import java.util.Map;
import java.util.zip.CRC32;
import java.util.zip.Checksum;

import org.apache.commons.io.filefilter.NameFileFilter;
import org.apache.commons.io.filefilter.WildcardFileFilter;
import org.apache.commons.io.testtools.TestUtils;
import org.junit.Assert;
import org.junit.Before;
import org.junit.Ignore;
import org.junit.Rule;
import org.junit.Test;
import org.junit.rules.TemporaryFolder;

/**
 * This is used to test FileUtils for correctness.
 *
 * @see FileUtils
 */
@SuppressWarnings({&quot;deprecation&quot;, &quot;ResultOfMethodCallIgnored&quot;}) // unit tests include tests of many deprecated methods
<span class="fc" id="L67">public class FileUtilsTestCase {</span>

<span class="fc" id="L69">    @Rule</span>
    public TemporaryFolder temporaryFolder = new TemporaryFolder();

    private File getTestDirectory() {
<span class="fc" id="L73">        return temporaryFolder.getRoot();</span>
    }

    // Test data

    /**
     * Size of test directory.
     */
    private static final int TEST_DIRECTORY_SIZE = 0;

    /**
     * Size of test directory.
     */
<span class="fc" id="L86">    private static final BigInteger TEST_DIRECTORY_SIZE_BI = BigInteger.ZERO;</span>

    /**
     * Size (greater of zero) of test file.
     */
<span class="fc" id="L91">    private static final BigInteger TEST_DIRECTORY_SIZE_GT_ZERO_BI = BigInteger.valueOf(100);</span>

    /**
     * List files recursively
     */
<span class="fc" id="L96">    private static final ListDirectoryWalker LIST_WALKER = new ListDirectoryWalker();</span>

    /**
     * Delay in milliseconds to make sure test for &quot;last modified date&quot; are accurate
     */
    //private static final int LAST_MODIFIED_DELAY = 600;

    private File testFile1;
    private File testFile2;

    private int testFile1Size;
    private int testFile2Size;

    @Before
    public void setUp() throws Exception {
<span class="fc" id="L111">        testFile1 = new File(getTestDirectory(), &quot;file1-test.txt&quot;);</span>
<span class="fc" id="L112">        testFile2 = new File(getTestDirectory(), &quot;file1a-test.txt&quot;);</span>

<span class="fc" id="L114">        testFile1Size = (int) testFile1.length();</span>
<span class="fc" id="L115">        testFile2Size = (int) testFile2.length();</span>
<span class="pc bpc" id="L116" title="1 of 2 branches missed.">        if (!testFile1.getParentFile().exists()) {</span>
<span class="nc" id="L117">            throw new IOException(&quot;Cannot create file &quot; + testFile1</span>
                    + &quot; as the parent directory does not exist&quot;);
        }
<span class="fc" id="L120">        try (final BufferedOutputStream output3 =</span>
                new BufferedOutputStream(new FileOutputStream(testFile1))) {
<span class="fc" id="L122">            TestUtils.generateTestData(output3, testFile1Size);</span>
        }
<span class="pc bpc" id="L124" title="1 of 2 branches missed.">        if (!testFile2.getParentFile().exists()) {</span>
<span class="nc" id="L125">            throw new IOException(&quot;Cannot create file &quot; + testFile2</span>
                    + &quot; as the parent directory does not exist&quot;);
        }
<span class="fc" id="L128">        try (final BufferedOutputStream output2 =</span>
                new BufferedOutputStream(new FileOutputStream(testFile2))) {
<span class="fc" id="L130">            TestUtils.generateTestData(output2, testFile2Size);</span>
        }
<span class="fc" id="L132">        FileUtils.deleteDirectory(getTestDirectory());</span>
<span class="fc" id="L133">        getTestDirectory().mkdirs();</span>
<span class="pc bpc" id="L134" title="1 of 2 branches missed.">        if (!testFile1.getParentFile().exists()) {</span>
<span class="nc" id="L135">            throw new IOException(&quot;Cannot create file &quot; + testFile1</span>
                    + &quot; as the parent directory does not exist&quot;);
        }
<span class="fc" id="L138">        try (final BufferedOutputStream output1 =</span>
                new BufferedOutputStream(new FileOutputStream(testFile1))) {
<span class="fc" id="L140">            TestUtils.generateTestData(output1, testFile1Size);</span>
        }
<span class="pc bpc" id="L142" title="1 of 2 branches missed.">        if (!testFile2.getParentFile().exists()) {</span>
<span class="nc" id="L143">            throw new IOException(&quot;Cannot create file &quot; + testFile2</span>
                    + &quot; as the parent directory does not exist&quot;);
        }
<span class="fc" id="L146">        try (final BufferedOutputStream output =</span>
                new BufferedOutputStream(new FileOutputStream(testFile2))) {
<span class="fc" id="L148">            TestUtils.generateTestData(output, testFile2Size);</span>
        }
<span class="fc" id="L150">    }</span>

    private String getName() {
<span class="fc" id="L153">        return this.getClass().getSimpleName();</span>
    }

    //-----------------------------------------------------------------------
    @Test
    public void testGetFile() {
<span class="fc" id="L159">        final File expected_A = new File(&quot;src&quot;);</span>
<span class="fc" id="L160">        final File expected_B = new File(expected_A, &quot;main&quot;);</span>
<span class="fc" id="L161">        final File expected_C = new File(expected_B, &quot;java&quot;);</span>
<span class="fc" id="L162">        assertEquals(&quot;A&quot;, expected_A, FileUtils.getFile(&quot;src&quot;));</span>
<span class="fc" id="L163">        assertEquals(&quot;B&quot;, expected_B, FileUtils.getFile(&quot;src&quot;, &quot;main&quot;));</span>
<span class="fc" id="L164">        assertEquals(&quot;C&quot;, expected_C, FileUtils.getFile(&quot;src&quot;, &quot;main&quot;, &quot;java&quot;));</span>
        try {
<span class="nc" id="L166">            FileUtils.getFile((String[]) null);</span>
<span class="nc" id="L167">            fail(&quot;Expected NullPointerException&quot;);</span>
<span class="fc" id="L168">        } catch (final NullPointerException e) {</span>
            // expected
<span class="nc" id="L170">        }</span>
<span class="fc" id="L171">    }</span>

    @Test
    public void testGetFile_Parent() {
<span class="fc" id="L175">        final File parent = new File(&quot;parent&quot;);</span>
<span class="fc" id="L176">        final File expected_A = new File(parent, &quot;src&quot;);</span>
<span class="fc" id="L177">        final File expected_B = new File(expected_A, &quot;main&quot;);</span>
<span class="fc" id="L178">        final File expected_C = new File(expected_B, &quot;java&quot;);</span>
<span class="fc" id="L179">        assertEquals(&quot;A&quot;, expected_A, FileUtils.getFile(parent, &quot;src&quot;));</span>
<span class="fc" id="L180">        assertEquals(&quot;B&quot;, expected_B, FileUtils.getFile(parent, &quot;src&quot;, &quot;main&quot;));</span>
<span class="fc" id="L181">        assertEquals(&quot;C&quot;, expected_C, FileUtils.getFile(parent, &quot;src&quot;, &quot;main&quot;, &quot;java&quot;));</span>
        try {
<span class="nc" id="L183">            FileUtils.getFile(parent, (String[]) null);</span>
<span class="nc" id="L184">            fail(&quot;Expected NullPointerException&quot;);</span>
<span class="fc" id="L185">        } catch (final NullPointerException e) {</span>
            // expected
<span class="nc" id="L187">        }</span>
        try {
<span class="nc" id="L189">            FileUtils.getFile((File) null, &quot;src&quot;);</span>
<span class="nc" id="L190">            fail(&quot;Expected NullPointerException&quot;);</span>
<span class="fc" id="L191">        } catch (final NullPointerException e) {</span>
            // expected
<span class="nc" id="L193">        }</span>
<span class="fc" id="L194">    }</span>

    @Test
    public void testGetTempDirectoryPath() {
<span class="fc" id="L198">        assertEquals(System.getProperty(&quot;java.io.tmpdir&quot;),</span>
<span class="fc" id="L199">                FileUtils.getTempDirectoryPath());</span>
<span class="fc" id="L200">    }</span>

    @Test
    public void testGetTempDirectory() {
<span class="fc" id="L204">        final File tempDirectory = new File(System.getProperty(&quot;java.io.tmpdir&quot;));</span>
<span class="fc" id="L205">        assertEquals(tempDirectory, FileUtils.getTempDirectory());</span>
<span class="fc" id="L206">    }</span>

    @Test
    public void testGetUserDirectoryPath() {
<span class="fc" id="L210">        assertEquals(System.getProperty(&quot;user.home&quot;),</span>
<span class="fc" id="L211">                FileUtils.getUserDirectoryPath());</span>
<span class="fc" id="L212">    }</span>

    @Test
    public void testGetUserDirectory() {
<span class="fc" id="L216">        final File userDirectory = new File(System.getProperty(&quot;user.home&quot;));</span>
<span class="fc" id="L217">        assertEquals(userDirectory, FileUtils.getUserDirectory());</span>
<span class="fc" id="L218">    }</span>

    //-----------------------------------------------------------------------
    @Test
    public void test_openInputStream_exists() throws Exception {
<span class="fc" id="L223">        final File file = new File(getTestDirectory(), &quot;test.txt&quot;);</span>
<span class="fc" id="L224">        TestUtils.createLineBasedFile(file, new String[]{&quot;Hello&quot;});</span>
<span class="fc" id="L225">        try (FileInputStream in = FileUtils.openInputStream(file)) {</span>
<span class="fc" id="L226">            assertEquals('H', in.read());</span>
        }
<span class="fc" id="L228">    }</span>

    @Test
    public void test_openInputStream_existsButIsDirectory() throws Exception {
<span class="fc" id="L232">        final File directory = new File(getTestDirectory(), &quot;subdir&quot;);</span>
<span class="fc" id="L233">        directory.mkdirs();</span>
<span class="nc" id="L234">        try (FileInputStream in = FileUtils.openInputStream(directory)) {</span>
<span class="nc" id="L235">            fail();</span>
<span class="fc" id="L236">        } catch (final IOException ioe) {</span>
            // expected
<span class="nc" id="L238">        }</span>
<span class="fc" id="L239">    }</span>

    @Test
    public void test_openInputStream_notExists() throws Exception {
<span class="fc" id="L243">        final File directory = new File(getTestDirectory(), &quot;test.txt&quot;);</span>
<span class="nc" id="L244">        try (FileInputStream in = FileUtils.openInputStream(directory)) {</span>
<span class="nc" id="L245">            fail();</span>
<span class="fc" id="L246">        } catch (final IOException ioe) {</span>
            // expected
<span class="nc" id="L248">        }</span>
<span class="fc" id="L249">    }</span>

    //-----------------------------------------------------------------------
    void openOutputStream_noParent(final boolean createFile) throws Exception {
<span class="fc" id="L253">        final File file = new File(&quot;test.txt&quot;);</span>
<span class="fc" id="L254">        assertNull(file.getParentFile());</span>
        try {
<span class="fc bfc" id="L256" title="All 2 branches covered.">            if (createFile) {</span>
<span class="fc" id="L257">                TestUtils.createLineBasedFile(file, new String[]{&quot;Hello&quot;});</span>
            }
<span class="fc" id="L259">            try (FileOutputStream out = FileUtils.openOutputStream(file)) {</span>
<span class="fc" id="L260">                out.write(0);</span>
            }
<span class="fc" id="L262">            assertTrue(file.exists());</span>
        } finally {
<span class="pc bpc" id="L264" title="1 of 2 branches missed.">            if (!file.delete()) {</span>
<span class="nc" id="L265">                file.deleteOnExit();</span>
            }
        }
<span class="fc" id="L268">    }</span>

    @Test
    public void test_openOutputStream_noParentCreateFile() throws Exception {
<span class="fc" id="L272">        openOutputStream_noParent(true);</span>
<span class="fc" id="L273">    }</span>

    @Test
    public void test_openOutputStream_noParentNoFile() throws Exception {
<span class="fc" id="L277">        openOutputStream_noParent(false);</span>
<span class="fc" id="L278">    }</span>

    @Test
    public void test_openOutputStream_exists() throws Exception {
<span class="fc" id="L282">        final File file = new File(getTestDirectory(), &quot;test.txt&quot;);</span>
<span class="fc" id="L283">        TestUtils.createLineBasedFile(file, new String[]{&quot;Hello&quot;});</span>
<span class="fc" id="L284">        try (FileOutputStream out = FileUtils.openOutputStream(file)) {</span>
<span class="fc" id="L285">            out.write(0);</span>
        }
<span class="fc" id="L287">        assertTrue(file.exists());</span>
<span class="fc" id="L288">    }</span>

    @Test
    public void test_openOutputStream_existsButIsDirectory() throws Exception {
<span class="fc" id="L292">        final File directory = new File(getTestDirectory(), &quot;subdir&quot;);</span>
<span class="fc" id="L293">        directory.mkdirs();</span>
<span class="nc" id="L294">        try (FileOutputStream out = FileUtils.openOutputStream(directory)) {</span>
<span class="nc" id="L295">            fail();</span>
<span class="fc" id="L296">        } catch (final IOException ioe) {</span>
            // expected
<span class="nc" id="L298">        }</span>
<span class="fc" id="L299">    }</span>

    @Test
    public void test_openOutputStream_notExists() throws Exception {
<span class="fc" id="L303">        final File file = new File(getTestDirectory(), &quot;a/test.txt&quot;);</span>
<span class="fc" id="L304">        try (FileOutputStream out = FileUtils.openOutputStream(file)) {</span>
<span class="fc" id="L305">            out.write(0);</span>
        }
<span class="fc" id="L307">        assertTrue(file.exists());</span>
<span class="fc" id="L308">    }</span>

    @Test
    public void test_openOutputStream_notExistsCannotCreate() throws Exception {
        // according to Wikipedia, most filing systems have a 256 limit on filename
<span class="fc" id="L313">        final String longStr =</span>
                &quot;abcdevwxyzabcdevwxyzabcdevwxyzabcdevwxyzabcdevwxyz&quot; +
                        &quot;abcdevwxyzabcdevwxyzabcdevwxyzabcdevwxyzabcdevwxyz&quot; +
                        &quot;abcdevwxyzabcdevwxyzabcdevwxyzabcdevwxyzabcdevwxyz&quot; +
                        &quot;abcdevwxyzabcdevwxyzabcdevwxyzabcdevwxyzabcdevwxyz&quot; +
                        &quot;abcdevwxyzabcdevwxyzabcdevwxyzabcdevwxyzabcdevwxyz&quot; +
                        &quot;abcdevwxyzabcdevwxyzabcdevwxyzabcdevwxyzabcdevwxyz&quot;;  // 300 chars
<span class="fc" id="L320">        final File file = new File(getTestDirectory(), &quot;a/&quot; + longStr + &quot;/test.txt&quot;);</span>
<span class="nc" id="L321">        try (FileOutputStream out = FileUtils.openOutputStream(file)) {</span>
<span class="nc" id="L322">            fail();</span>
<span class="fc" id="L323">        } catch (final IOException ioe) {</span>
            // expected
<span class="nc" id="L325">        }</span>
<span class="fc" id="L326">    }</span>

    //-----------------------------------------------------------------------
    // byteCountToDisplaySize
    @Test
    public void testByteCountToDisplaySizeBigInteger() {
<span class="fc" id="L332">        final BigInteger b1023 = BigInteger.valueOf(1023);</span>
<span class="fc" id="L333">        final BigInteger b1025 = BigInteger.valueOf(1025);</span>
<span class="fc" id="L334">        final BigInteger KB1 = BigInteger.valueOf(1024);</span>
<span class="fc" id="L335">        final BigInteger MB1 = KB1.multiply(KB1);</span>
<span class="fc" id="L336">        final BigInteger GB1 = MB1.multiply(KB1);</span>
<span class="fc" id="L337">        final BigInteger GB2 = GB1.add(GB1);</span>
<span class="fc" id="L338">        final BigInteger TB1 = GB1.multiply(KB1);</span>
<span class="fc" id="L339">        final BigInteger PB1 = TB1.multiply(KB1);</span>
<span class="fc" id="L340">        final BigInteger EB1 = PB1.multiply(KB1);</span>
<span class="fc" id="L341">        assertEquals(FileUtils.byteCountToDisplaySize(BigInteger.ZERO), &quot;0 bytes&quot;);</span>
<span class="fc" id="L342">        assertEquals(FileUtils.byteCountToDisplaySize(BigInteger.ONE), &quot;1 bytes&quot;);</span>
<span class="fc" id="L343">        assertEquals(FileUtils.byteCountToDisplaySize(b1023), &quot;1023 bytes&quot;);</span>
<span class="fc" id="L344">        assertEquals(FileUtils.byteCountToDisplaySize(KB1), &quot;1 KB&quot;);</span>
<span class="fc" id="L345">        assertEquals(FileUtils.byteCountToDisplaySize(b1025), &quot;1 KB&quot;);</span>
<span class="fc" id="L346">        assertEquals(FileUtils.byteCountToDisplaySize(MB1.subtract(BigInteger.ONE)), &quot;1023 KB&quot;);</span>
<span class="fc" id="L347">        assertEquals(FileUtils.byteCountToDisplaySize(MB1), &quot;1 MB&quot;);</span>
<span class="fc" id="L348">        assertEquals(FileUtils.byteCountToDisplaySize(MB1.add(BigInteger.ONE)), &quot;1 MB&quot;);</span>
<span class="fc" id="L349">        assertEquals(FileUtils.byteCountToDisplaySize(GB1.subtract(BigInteger.ONE)), &quot;1023 MB&quot;);</span>
<span class="fc" id="L350">        assertEquals(FileUtils.byteCountToDisplaySize(GB1), &quot;1 GB&quot;);</span>
<span class="fc" id="L351">        assertEquals(FileUtils.byteCountToDisplaySize(GB1.add(BigInteger.ONE)), &quot;1 GB&quot;);</span>
<span class="fc" id="L352">        assertEquals(FileUtils.byteCountToDisplaySize(GB2), &quot;2 GB&quot;);</span>
<span class="fc" id="L353">        assertEquals(FileUtils.byteCountToDisplaySize(GB2.subtract(BigInteger.ONE)), &quot;1 GB&quot;);</span>
<span class="fc" id="L354">        assertEquals(FileUtils.byteCountToDisplaySize(TB1), &quot;1 TB&quot;);</span>
<span class="fc" id="L355">        assertEquals(FileUtils.byteCountToDisplaySize(PB1), &quot;1 PB&quot;);</span>
<span class="fc" id="L356">        assertEquals(FileUtils.byteCountToDisplaySize(EB1), &quot;1 EB&quot;);</span>
<span class="fc" id="L357">        assertEquals(FileUtils.byteCountToDisplaySize(Long.MAX_VALUE), &quot;7 EB&quot;);</span>
        // Other MAX_VALUEs
<span class="fc" id="L359">        assertEquals(FileUtils.byteCountToDisplaySize(BigInteger.valueOf(Character.MAX_VALUE)), &quot;63 KB&quot;);</span>
<span class="fc" id="L360">        assertEquals(FileUtils.byteCountToDisplaySize(BigInteger.valueOf(Short.MAX_VALUE)), &quot;31 KB&quot;);</span>
<span class="fc" id="L361">        assertEquals(FileUtils.byteCountToDisplaySize(BigInteger.valueOf(Integer.MAX_VALUE)), &quot;1 GB&quot;);</span>
<span class="fc" id="L362">    }</span>

    @SuppressWarnings(&quot;NumericOverflow&quot;)
    @Test
    public void testByteCountToDisplaySizeLong() {
<span class="fc" id="L367">        assertEquals(FileUtils.byteCountToDisplaySize(0), &quot;0 bytes&quot;);</span>
<span class="fc" id="L368">        assertEquals(FileUtils.byteCountToDisplaySize(1), &quot;1 bytes&quot;);</span>
<span class="fc" id="L369">        assertEquals(FileUtils.byteCountToDisplaySize(1023), &quot;1023 bytes&quot;);</span>
<span class="fc" id="L370">        assertEquals(FileUtils.byteCountToDisplaySize(1024), &quot;1 KB&quot;);</span>
<span class="fc" id="L371">        assertEquals(FileUtils.byteCountToDisplaySize(1025), &quot;1 KB&quot;);</span>
<span class="fc" id="L372">        assertEquals(FileUtils.byteCountToDisplaySize(1024 * 1023), &quot;1023 KB&quot;);</span>
<span class="fc" id="L373">        assertEquals(FileUtils.byteCountToDisplaySize(1024 * 1024), &quot;1 MB&quot;);</span>
<span class="fc" id="L374">        assertEquals(FileUtils.byteCountToDisplaySize(1024 * 1025), &quot;1 MB&quot;);</span>
<span class="fc" id="L375">        assertEquals(FileUtils.byteCountToDisplaySize(1024 * 1024 * 1023), &quot;1023 MB&quot;);</span>
<span class="fc" id="L376">        assertEquals(FileUtils.byteCountToDisplaySize(1024 * 1024 * 1024), &quot;1 GB&quot;);</span>
<span class="fc" id="L377">        assertEquals(FileUtils.byteCountToDisplaySize(1024 * 1024 * 1025), &quot;1 GB&quot;);</span>
<span class="fc" id="L378">        assertEquals(FileUtils.byteCountToDisplaySize(1024L * 1024 * 1024 * 2), &quot;2 GB&quot;);</span>
<span class="fc" id="L379">        assertEquals(FileUtils.byteCountToDisplaySize(1024 * 1024 * 1024 * 2 - 1), &quot;1 GB&quot;);</span>
<span class="fc" id="L380">        assertEquals(FileUtils.byteCountToDisplaySize(1024L * 1024 * 1024 * 1024), &quot;1 TB&quot;);</span>
<span class="fc" id="L381">        assertEquals(FileUtils.byteCountToDisplaySize(1024L * 1024 * 1024 * 1024 * 1024), &quot;1 PB&quot;);</span>
<span class="fc" id="L382">        assertEquals(FileUtils.byteCountToDisplaySize(1024L * 1024 * 1024 * 1024 * 1024 * 1024), &quot;1 EB&quot;);</span>
<span class="fc" id="L383">        assertEquals(FileUtils.byteCountToDisplaySize(Long.MAX_VALUE), &quot;7 EB&quot;);</span>
        // Other MAX_VALUEs
<span class="fc" id="L385">        assertEquals(FileUtils.byteCountToDisplaySize(Character.MAX_VALUE), &quot;63 KB&quot;);</span>
<span class="fc" id="L386">        assertEquals(FileUtils.byteCountToDisplaySize(Short.MAX_VALUE), &quot;31 KB&quot;);</span>
<span class="fc" id="L387">        assertEquals(FileUtils.byteCountToDisplaySize(Integer.MAX_VALUE), &quot;1 GB&quot;);</span>
<span class="fc" id="L388">    }</span>

    //-----------------------------------------------------------------------
    @Test
    public void testToFile1() throws Exception {
<span class="fc" id="L393">        final URL url = new URL(&quot;file&quot;, null, &quot;a/b/c/file.txt&quot;);</span>
<span class="fc" id="L394">        final File file = FileUtils.toFile(url);</span>
<span class="fc" id="L395">        assertTrue(file.toString().contains(&quot;file.txt&quot;));</span>
<span class="fc" id="L396">    }</span>

    @Test
    public void testToFile2() throws Exception {
<span class="fc" id="L400">        final URL url = new URL(&quot;file&quot;, null, &quot;a/b/c/file%20n%61me%2520.tx%74&quot;);</span>
<span class="fc" id="L401">        final File file = FileUtils.toFile(url);</span>
<span class="fc" id="L402">        assertTrue(file.toString().contains(&quot;file name%20.txt&quot;));</span>
<span class="fc" id="L403">    }</span>

    @Test
    public void testToFile3() throws Exception {
<span class="fc" id="L407">        assertEquals(null, FileUtils.toFile(null));</span>
<span class="fc" id="L408">        assertEquals(null, FileUtils.toFile(new URL(&quot;http://jakarta.apache.org&quot;)));</span>
<span class="fc" id="L409">    }</span>

    @Test
    public void testToFile4() throws Exception {
<span class="fc" id="L413">        final URL url = new URL(&quot;file&quot;, null, &quot;a/b/c/file%%20%me.txt%&quot;);</span>
<span class="fc" id="L414">        final File file = FileUtils.toFile(url);</span>
<span class="fc" id="L415">        assertTrue(file.toString().contains(&quot;file% %me.txt%&quot;));</span>
<span class="fc" id="L416">    }</span>

    /* IO-252 */
    @Test
    public void testToFile5() throws Exception {
<span class="fc" id="L421">        final URL url = new URL(&quot;file&quot;, null, &quot;both%20are%20100%20%25%20true&quot;);</span>
<span class="fc" id="L422">        final File file = FileUtils.toFile(url);</span>
<span class="fc" id="L423">        assertEquals(&quot;both are 100 % true&quot;, file.toString());</span>
<span class="fc" id="L424">    }</span>

    @Test
    public void testToFileUtf8() throws Exception {
<span class="fc" id="L428">        final URL url = new URL(&quot;file&quot;, null, &quot;/home/%C3%A4%C3%B6%C3%BC%C3%9F&quot;);</span>
<span class="fc" id="L429">        final File file = FileUtils.toFile(url);</span>
<span class="fc" id="L430">        assertTrue(file.toString().contains(&quot;\u00E4\u00F6\u00FC\u00DF&quot;));</span>
<span class="fc" id="L431">    }</span>

    @Test
    public void testDecodeUrl() {
<span class="fc" id="L435">        assertEquals(&quot;&quot;, FileUtils.decodeUrl(&quot;&quot;));</span>
<span class="fc" id="L436">        assertEquals(&quot;foo&quot;, FileUtils.decodeUrl(&quot;foo&quot;));</span>
<span class="fc" id="L437">        assertEquals(&quot;+&quot;, FileUtils.decodeUrl(&quot;+&quot;));</span>
<span class="fc" id="L438">        assertEquals(&quot;% &quot;, FileUtils.decodeUrl(&quot;%25%20&quot;));</span>
<span class="fc" id="L439">        assertEquals(&quot;%20&quot;, FileUtils.decodeUrl(&quot;%2520&quot;));</span>
<span class="fc" id="L440">        assertEquals(&quot;jar:file:/C:/dir/sub dir/1.0/foo-1.0.jar!/org/Bar.class&quot;, FileUtils</span>
<span class="fc" id="L441">                .decodeUrl(&quot;jar:file:/C:/dir/sub%20dir/1.0/foo-1.0.jar!/org/Bar.class&quot;));</span>
<span class="fc" id="L442">    }</span>

    @Test
    public void testDecodeUrlLenient() {
<span class="fc" id="L446">        assertEquals(&quot; &quot;, FileUtils.decodeUrl(&quot; &quot;));</span>
<span class="fc" id="L447">        assertEquals(&quot;\u00E4\u00F6\u00FC\u00DF&quot;, FileUtils.decodeUrl(&quot;\u00E4\u00F6\u00FC\u00DF&quot;));</span>
<span class="fc" id="L448">        assertEquals(&quot;%&quot;, FileUtils.decodeUrl(&quot;%&quot;));</span>
<span class="fc" id="L449">        assertEquals(&quot;% &quot;, FileUtils.decodeUrl(&quot;%%20&quot;));</span>
<span class="fc" id="L450">        assertEquals(&quot;%2&quot;, FileUtils.decodeUrl(&quot;%2&quot;));</span>
<span class="fc" id="L451">        assertEquals(&quot;%2G&quot;, FileUtils.decodeUrl(&quot;%2G&quot;));</span>
<span class="fc" id="L452">    }</span>

    @Test
    public void testDecodeUrlNullSafe() {
<span class="fc" id="L456">        assertNull(FileUtils.decodeUrl(null));</span>
<span class="fc" id="L457">    }</span>

    @Test
    public void testDecodeUrlEncodingUtf8() {
<span class="fc" id="L461">        assertEquals(&quot;\u00E4\u00F6\u00FC\u00DF&quot;, FileUtils.decodeUrl(&quot;%C3%A4%C3%B6%C3%BC%C3%9F&quot;));</span>
<span class="fc" id="L462">    }</span>

    // toFiles

    @Test
    public void testToFiles1() throws Exception {
<span class="fc" id="L468">        final URL[] urls = new URL[]{</span>
                new URL(&quot;file&quot;, null, &quot;file1.txt&quot;),
                new URL(&quot;file&quot;, null, &quot;file2.txt&quot;),
        };
<span class="fc" id="L472">        final File[] files = FileUtils.toFiles(urls);</span>

<span class="fc" id="L474">        assertEquals(urls.length, files.length);</span>
<span class="fc" id="L475">        assertEquals(&quot;File: &quot; + files[0], true, files[0].toString().contains(&quot;file1.txt&quot;));</span>
<span class="fc" id="L476">        assertEquals(&quot;File: &quot; + files[1], true, files[1].toString().contains(&quot;file2.txt&quot;));</span>
<span class="fc" id="L477">    }</span>

    @Test
    public void testToFiles2() throws Exception {
<span class="fc" id="L481">        final URL[] urls = new URL[]{</span>
                new URL(&quot;file&quot;, null, &quot;file1.txt&quot;),
                null,
        };
<span class="fc" id="L485">        final File[] files = FileUtils.toFiles(urls);</span>

<span class="fc" id="L487">        assertEquals(urls.length, files.length);</span>
<span class="fc" id="L488">        assertEquals(&quot;File: &quot; + files[0], true, files[0].toString().contains(&quot;file1.txt&quot;));</span>
<span class="fc" id="L489">        assertEquals(&quot;File: &quot; + files[1], null, files[1]);</span>
<span class="fc" id="L490">    }</span>

    @Test
    public void testToFiles3() throws Exception {
<span class="fc" id="L494">        final URL[] urls = null;</span>
<span class="fc" id="L495">        final File[] files = FileUtils.toFiles(urls);</span>

<span class="fc" id="L497">        assertEquals(0, files.length);</span>
<span class="fc" id="L498">    }</span>

    @Test
    public void testToFiles3a() throws Exception {
<span class="fc" id="L502">        final URL[] urls = new URL[0]; // empty array</span>
<span class="fc" id="L503">        final File[] files = FileUtils.toFiles(urls);</span>

<span class="fc" id="L505">        assertEquals(0, files.length);</span>
<span class="fc" id="L506">    }</span>

    @Test
    public void testToFiles4() throws Exception {
<span class="fc" id="L510">        final URL[] urls = new URL[]{</span>
                new URL(&quot;file&quot;, null, &quot;file1.txt&quot;),
                new URL(&quot;http&quot;, &quot;jakarta.apache.org&quot;, &quot;file1.txt&quot;),
        };
        try {
<span class="nc" id="L515">            FileUtils.toFiles(urls);</span>
<span class="nc" id="L516">            fail();</span>
<span class="fc" id="L517">        } catch (final IllegalArgumentException ignore) {</span>
<span class="nc" id="L518">        }</span>
<span class="fc" id="L519">    }</span>

    // toURLs

    @Test
    public void testToURLs1() throws Exception {
<span class="fc" id="L525">        final File[] files = new File[]{</span>
<span class="fc" id="L526">                new File(getTestDirectory(), &quot;file1.txt&quot;),</span>
<span class="fc" id="L527">                new File(getTestDirectory(), &quot;file2.txt&quot;),</span>
<span class="fc" id="L528">                new File(getTestDirectory(), &quot;test file.txt&quot;),</span>
        };
<span class="fc" id="L530">        final URL[] urls = FileUtils.toURLs(files);</span>

<span class="fc" id="L532">        assertEquals(files.length, urls.length);</span>
<span class="fc" id="L533">        assertTrue(urls[0].toExternalForm().startsWith(&quot;file:&quot;));</span>
<span class="fc" id="L534">        assertTrue(urls[0].toExternalForm().contains(&quot;file1.txt&quot;));</span>
<span class="fc" id="L535">        assertTrue(urls[1].toExternalForm().startsWith(&quot;file:&quot;));</span>
<span class="fc" id="L536">        assertTrue(urls[1].toExternalForm().contains(&quot;file2.txt&quot;));</span>

        // Test escaped char
<span class="fc" id="L539">        assertTrue(urls[2].toExternalForm().startsWith(&quot;file:&quot;));</span>
<span class="fc" id="L540">        assertTrue(urls[2].toExternalForm().contains(&quot;test%20file.txt&quot;));</span>
<span class="fc" id="L541">    }</span>

//   @Test public void testToURLs2() throws Exception {
//        File[] files = new File[] {
//            new File(getTestDirectory(), &quot;file1.txt&quot;),
//            null,
//        };
//        URL[] urls = FileUtils.toURLs(files);
//
//        assertEquals(files.length, urls.length);
//        assertTrue(urls[0].toExternalForm().startsWith(&quot;file:&quot;));
//        assertTrue(urls[0].toExternalForm().indexOf(&quot;file1.txt&quot;) &gt; 0);
//        assertEquals(null, urls[1]);
//    }
//
//   @Test public void testToURLs3() throws Exception {
//        File[] files = null;
//        URL[] urls = FileUtils.toURLs(files);
//
//        assertEquals(0, urls.length);
//    }

    @Test
    public void testToURLs3a() throws Exception {
<span class="fc" id="L565">        final File[] files = new File[0]; // empty array</span>
<span class="fc" id="L566">        final URL[] urls = FileUtils.toURLs(files);</span>

<span class="fc" id="L568">        assertEquals(0, urls.length);</span>
<span class="fc" id="L569">    }</span>

    // contentEquals

    @Test
    public void testContentEquals() throws Exception {
        // Non-existent files
<span class="fc" id="L576">        final File file = new File(getTestDirectory(), getName());</span>
<span class="fc" id="L577">        final File file2 = new File(getTestDirectory(), getName() + &quot;2&quot;);</span>
        // both don't  exist
<span class="fc" id="L579">        assertTrue(FileUtils.contentEquals(file, file));</span>
<span class="fc" id="L580">        assertTrue(FileUtils.contentEquals(file, file2));</span>
<span class="fc" id="L581">        assertTrue(FileUtils.contentEquals(file2, file2));</span>
<span class="fc" id="L582">        assertTrue(FileUtils.contentEquals(file2, file));</span>

        // Directories
        try {
<span class="nc" id="L586">            FileUtils.contentEquals(getTestDirectory(), getTestDirectory());</span>
<span class="nc" id="L587">            fail(&quot;Comparing directories should fail with an IOException&quot;);</span>
<span class="fc" id="L588">        } catch (final IOException ioe) {</span>
            //expected
<span class="nc" id="L590">        }</span>

        // Different files
<span class="fc" id="L593">        final File objFile1 =</span>
<span class="fc" id="L594">                new File(getTestDirectory(), getName() + &quot;.object&quot;);</span>
<span class="fc" id="L595">        objFile1.deleteOnExit();</span>
<span class="fc" id="L596">        FileUtils.copyURLToFile(</span>
<span class="fc" id="L597">                getClass().getResource(&quot;/java/lang/Object.class&quot;),</span>
                objFile1);

<span class="fc" id="L600">        final File objFile1b =</span>
<span class="fc" id="L601">                new File(getTestDirectory(), getName() + &quot;.object2&quot;);</span>
<span class="fc" id="L602">        objFile1.deleteOnExit();</span>
<span class="fc" id="L603">        FileUtils.copyURLToFile(</span>
<span class="fc" id="L604">                getClass().getResource(&quot;/java/lang/Object.class&quot;),</span>
                objFile1b);

<span class="fc" id="L607">        final File objFile2 =</span>
<span class="fc" id="L608">                new File(getTestDirectory(), getName() + &quot;.collection&quot;);</span>
<span class="fc" id="L609">        objFile2.deleteOnExit();</span>
<span class="fc" id="L610">        FileUtils.copyURLToFile(</span>
<span class="fc" id="L611">                getClass().getResource(&quot;/java/util/Collection.class&quot;),</span>
                objFile2);

<span class="fc" id="L614">        assertFalse(FileUtils.contentEquals(objFile1, objFile2));</span>
<span class="fc" id="L615">        assertFalse(FileUtils.contentEquals(objFile1b, objFile2));</span>
<span class="fc" id="L616">        assertTrue(FileUtils.contentEquals(objFile1, objFile1b));</span>

<span class="fc" id="L618">        assertTrue(FileUtils.contentEquals(objFile1, objFile1));</span>
<span class="fc" id="L619">        assertTrue(FileUtils.contentEquals(objFile1b, objFile1b));</span>
<span class="fc" id="L620">        assertTrue(FileUtils.contentEquals(objFile2, objFile2));</span>

        // Equal files
<span class="fc" id="L623">        file.createNewFile();</span>
<span class="fc" id="L624">        file2.createNewFile();</span>
<span class="fc" id="L625">        assertTrue(FileUtils.contentEquals(file, file));</span>
<span class="fc" id="L626">        assertTrue(FileUtils.contentEquals(file, file2));</span>
<span class="fc" id="L627">    }</span>

    @Test
    public void testContentEqualsIgnoreEOL() throws Exception {
        // Non-existent files
<span class="fc" id="L632">        final File file1 = new File(getTestDirectory(), getName());</span>
<span class="fc" id="L633">        final File file2 = new File(getTestDirectory(), getName() + &quot;2&quot;);</span>
        // both don't  exist
<span class="fc" id="L635">        assertTrue(FileUtils.contentEqualsIgnoreEOL(file1, file1, null));</span>
<span class="fc" id="L636">        assertTrue(FileUtils.contentEqualsIgnoreEOL(file1, file2, null));</span>
<span class="fc" id="L637">        assertTrue(FileUtils.contentEqualsIgnoreEOL(file2, file2, null));</span>
<span class="fc" id="L638">        assertTrue(FileUtils.contentEqualsIgnoreEOL(file2, file1, null));</span>

        // Directories
        try {
<span class="nc" id="L642">            FileUtils.contentEqualsIgnoreEOL(getTestDirectory(), getTestDirectory(), null);</span>
<span class="nc" id="L643">            fail(&quot;Comparing directories should fail with an IOException&quot;);</span>
<span class="fc" id="L644">        } catch (final IOException ioe) {</span>
            //expected
<span class="nc" id="L646">        }</span>

        // Different files
<span class="fc" id="L649">        final File tfile1 = new File(getTestDirectory(), getName() + &quot;.txt1&quot;);</span>
<span class="fc" id="L650">        tfile1.deleteOnExit();</span>
<span class="fc" id="L651">        FileUtils.write(tfile1, &quot;123\r&quot;);</span>

<span class="fc" id="L653">        final File tfile2 = new File(getTestDirectory(), getName() + &quot;.txt2&quot;);</span>
<span class="fc" id="L654">        tfile1.deleteOnExit();</span>
<span class="fc" id="L655">        FileUtils.write(tfile2, &quot;123\n&quot;);</span>

<span class="fc" id="L657">        final File tfile3 = new File(getTestDirectory(), getName() + &quot;.collection&quot;);</span>
<span class="fc" id="L658">        tfile3.deleteOnExit();</span>
<span class="fc" id="L659">        FileUtils.write(tfile3, &quot;123\r\n2&quot;);</span>

<span class="fc" id="L661">        assertTrue(FileUtils.contentEqualsIgnoreEOL(tfile1, tfile1, null));</span>
<span class="fc" id="L662">        assertTrue(FileUtils.contentEqualsIgnoreEOL(tfile2, tfile2, null));</span>
<span class="fc" id="L663">        assertTrue(FileUtils.contentEqualsIgnoreEOL(tfile3, tfile3, null));</span>

<span class="fc" id="L665">        assertTrue(FileUtils.contentEqualsIgnoreEOL(tfile1, tfile2, null));</span>
<span class="fc" id="L666">        assertFalse(FileUtils.contentEqualsIgnoreEOL(tfile1, tfile3, null));</span>
<span class="fc" id="L667">        assertFalse(FileUtils.contentEqualsIgnoreEOL(tfile2, tfile3, null));</span>

<span class="fc" id="L669">        final URL urlCR = getClass().getResource(&quot;FileUtilsTestDataCR.dat&quot;);</span>
<span class="fc" id="L670">        assertNotNull(urlCR);</span>
<span class="fc" id="L671">        final File cr = new File(urlCR.toURI());</span>
<span class="fc" id="L672">        assertTrue(cr.exists());</span>

<span class="fc" id="L674">        final URL urlCRLF = getClass().getResource(&quot;FileUtilsTestDataCRLF.dat&quot;);</span>
<span class="fc" id="L675">        assertNotNull(urlCRLF);</span>
<span class="fc" id="L676">        final File crlf = new File(urlCRLF.toURI());</span>
<span class="fc" id="L677">        assertTrue(crlf.exists());</span>

<span class="fc" id="L679">        final URL urlLF = getClass().getResource(&quot;FileUtilsTestDataLF.dat&quot;);</span>
<span class="fc" id="L680">        assertNotNull(urlLF);</span>
<span class="fc" id="L681">        final File lf = new File(urlLF.toURI());</span>
<span class="fc" id="L682">        assertTrue(lf.exists());</span>

<span class="fc" id="L684">        assertTrue(FileUtils.contentEqualsIgnoreEOL(cr, cr, null));</span>
<span class="fc" id="L685">        assertTrue(FileUtils.contentEqualsIgnoreEOL(crlf, crlf, null));</span>
<span class="fc" id="L686">        assertTrue(FileUtils.contentEqualsIgnoreEOL(lf, lf, null));</span>

<span class="fc" id="L688">        assertTrue(FileUtils.contentEqualsIgnoreEOL(cr, crlf, null));</span>
<span class="fc" id="L689">        assertTrue(FileUtils.contentEqualsIgnoreEOL(cr, lf, null));</span>
<span class="fc" id="L690">        assertTrue(FileUtils.contentEqualsIgnoreEOL(crlf, lf, null));</span>

        // Check the files behave OK when EOL is not ignored
<span class="fc" id="L693">        assertTrue(FileUtils.contentEquals(cr, cr));</span>
<span class="fc" id="L694">        assertTrue(FileUtils.contentEquals(crlf, crlf));</span>
<span class="fc" id="L695">        assertTrue(FileUtils.contentEquals(lf, lf));</span>

<span class="fc" id="L697">        assertFalse(FileUtils.contentEquals(cr, crlf));</span>
<span class="fc" id="L698">        assertFalse(FileUtils.contentEquals(cr, lf));</span>
<span class="fc" id="L699">        assertFalse(FileUtils.contentEquals(crlf, lf));</span>

        // Equal files
<span class="fc" id="L702">        file1.createNewFile();</span>
<span class="fc" id="L703">        file2.createNewFile();</span>
<span class="fc" id="L704">        assertTrue(FileUtils.contentEqualsIgnoreEOL(file1, file1, null));</span>
<span class="fc" id="L705">        assertTrue(FileUtils.contentEqualsIgnoreEOL(file1, file2, null));</span>
<span class="fc" id="L706">    }</span>

    // copyURLToFile

    @Test
    public void testCopyURLToFile() throws Exception {
        // Creates file
<span class="fc" id="L713">        final File file = new File(getTestDirectory(), getName());</span>
<span class="fc" id="L714">        file.deleteOnExit();</span>

        // Loads resource
<span class="fc" id="L717">        final String resourceName = &quot;/java/lang/Object.class&quot;;</span>
<span class="fc" id="L718">        FileUtils.copyURLToFile(getClass().getResource(resourceName), file);</span>

        // Tests that resuorce was copied correctly
<span class="fc" id="L721">        try (FileInputStream fis = new FileInputStream(file)) {</span>
<span class="fc" id="L722">            assertTrue(</span>
                    &quot;Content is not equal.&quot;,
<span class="fc" id="L724">                    IOUtils.contentEquals(</span>
<span class="fc" id="L725">                            getClass().getResourceAsStream(resourceName),</span>
                            fis));
        }
        //TODO Maybe test copy to itself like for copyFile()
<span class="fc" id="L729">    }</span>

    @Test
    public void testCopyURLToFileWithTimeout() throws Exception {
        // Creates file
<span class="fc" id="L734">        final File file = new File(getTestDirectory(), &quot;testCopyURLToFileWithTimeout&quot;);</span>
<span class="fc" id="L735">        file.deleteOnExit();</span>

        // Loads resource
<span class="fc" id="L738">        final String resourceName = &quot;/java/lang/Object.class&quot;;</span>
<span class="fc" id="L739">        FileUtils.copyURLToFile(getClass().getResource(resourceName), file, 500, 500);</span>

        // Tests that resuorce was copied correctly
<span class="fc" id="L742">        try (FileInputStream fis = new FileInputStream(file)) {</span>
<span class="fc" id="L743">            assertTrue(</span>
                    &quot;Content is not equal.&quot;,
<span class="fc" id="L745">                    IOUtils.contentEquals(</span>
<span class="fc" id="L746">                            getClass().getResourceAsStream(resourceName),</span>
                            fis));
        }
        //TODO Maybe test copy to itself like for copyFile()
<span class="fc" id="L750">    }</span>

    // forceMkdir

    @Test
    public void testForceMkdir() throws Exception {
        // Tests with existing directory
<span class="fc" id="L757">        FileUtils.forceMkdir(getTestDirectory());</span>

        // Creates test file
<span class="fc" id="L760">        final File testFile = new File(getTestDirectory(), getName());</span>
<span class="fc" id="L761">        testFile.deleteOnExit();</span>
<span class="fc" id="L762">        testFile.createNewFile();</span>
<span class="fc" id="L763">        assertTrue(&quot;Test file does not exist.&quot;, testFile.exists());</span>

        // Tests with existing file
        try {
<span class="nc" id="L767">            FileUtils.forceMkdir(testFile);</span>
<span class="nc" id="L768">            fail(&quot;Exception expected.&quot;);</span>
<span class="fc" id="L769">        } catch (final IOException ignore) {</span>
<span class="nc" id="L770">        }</span>

<span class="fc" id="L772">        testFile.delete();</span>

        // Tests with non-existent directory
<span class="fc" id="L775">        FileUtils.forceMkdir(testFile);</span>
<span class="fc" id="L776">        assertTrue(&quot;Directory was not created.&quot;, testFile.exists());</span>
<span class="fc" id="L777">    }</span>

    @Test
    public void testForceMkdirParent() throws Exception {
        // Tests with existing directory
<span class="fc" id="L782">        assertTrue(getTestDirectory().exists());</span>
<span class="fc" id="L783">        final File testParentDir = new File(getTestDirectory(), &quot;testForceMkdirParent&quot;);</span>
<span class="fc" id="L784">        testParentDir.delete();</span>
<span class="fc" id="L785">        assertFalse(testParentDir.exists());</span>
<span class="fc" id="L786">        final File testFile = new File(testParentDir, &quot;test.txt&quot;);</span>
<span class="fc" id="L787">        assertFalse(testParentDir.exists());</span>
<span class="fc" id="L788">        assertFalse(testFile.exists());</span>
        // Create
<span class="fc" id="L790">        FileUtils.forceMkdirParent(testFile);</span>
<span class="fc" id="L791">        assertTrue(testParentDir.exists());</span>
<span class="fc" id="L792">        assertFalse(testFile.exists());</span>
        // Again
<span class="fc" id="L794">        FileUtils.forceMkdirParent(testFile);</span>
<span class="fc" id="L795">        assertTrue(testParentDir.exists());</span>
<span class="fc" id="L796">        assertFalse(testFile.exists());</span>
<span class="fc" id="L797">    }</span>

    // sizeOfDirectory

    @Test
    public void testSizeOfDirectory() throws Exception {
<span class="fc" id="L803">        final File file = new File(getTestDirectory(), getName());</span>

        // Non-existent file
        try {
<span class="nc" id="L807">            FileUtils.sizeOfDirectory(file);</span>
<span class="nc" id="L808">            fail(&quot;Exception expected.&quot;);</span>
<span class="fc" id="L809">        } catch (final IllegalArgumentException ignore) {</span>
<span class="nc" id="L810">        }</span>

        // Creates file
<span class="fc" id="L813">        file.createNewFile();</span>

        // Existing file
        try {
<span class="nc" id="L817">            FileUtils.sizeOfDirectory(file);</span>
<span class="nc" id="L818">            fail(&quot;Exception expected.&quot;);</span>
<span class="fc" id="L819">        } catch (final IllegalArgumentException ignore) {</span>
<span class="nc" id="L820">        }</span>

        // Existing directory
<span class="fc" id="L823">        file.delete();</span>
<span class="fc" id="L824">        file.mkdir();</span>

        // Create a cyclic symlink
<span class="fc" id="L827">        this.createCircularSymLink(file);</span>

<span class="fc" id="L829">        assertEquals(</span>
                &quot;Unexpected directory size&quot;,
                TEST_DIRECTORY_SIZE,
<span class="fc" id="L832">                FileUtils.sizeOfDirectory(file));</span>
<span class="fc" id="L833">    }</span>

    private void createCircularSymLink(final File file) throws IOException {
<span class="pc bpc" id="L836" title="1 of 2 branches missed.">        if (!FilenameUtils.isSystemWindows()) {</span>
<span class="fc" id="L837">            Runtime.getRuntime()</span>
<span class="fc" id="L838">                    .exec(&quot;ln -s &quot; + file + &quot;/.. &quot; + file + &quot;/cycle&quot;);</span>
        } else {
            try {
<span class="nc" id="L841">                Runtime.getRuntime()</span>
<span class="nc" id="L842">                        .exec(&quot;mklink /D &quot; + file + &quot;/cycle&quot; + file + &quot;/.. &quot;);</span>
<span class="nc" id="L843">            } catch (final IOException ioe) { // So that tests run in FAT filesystems</span>
                //don't fail
<span class="nc" id="L845">            }</span>
        }
<span class="fc" id="L847">    }</span>

    @Test
    public void testSizeOfDirectoryAsBigInteger() throws Exception {
<span class="fc" id="L851">        final File file = new File(getTestDirectory(), getName());</span>

        // Non-existent file
        try {
<span class="nc" id="L855">            FileUtils.sizeOfDirectoryAsBigInteger(file);</span>
<span class="nc" id="L856">            fail(&quot;Exception expected.&quot;);</span>
<span class="fc" id="L857">        } catch (final IllegalArgumentException ignore) {</span>
<span class="nc" id="L858">        }</span>

        // Creates file
<span class="fc" id="L861">        file.createNewFile();</span>
<span class="fc" id="L862">        file.deleteOnExit();</span>

        // Existing file
        try {
<span class="nc" id="L866">            FileUtils.sizeOfDirectoryAsBigInteger(file);</span>
<span class="nc" id="L867">            fail(&quot;Exception expected.&quot;);</span>
<span class="fc" id="L868">        } catch (final IllegalArgumentException ignore) {</span>
<span class="nc" id="L869">        }</span>

        // Existing directory
<span class="fc" id="L872">        file.delete();</span>
<span class="fc" id="L873">        file.mkdir();</span>

<span class="fc" id="L875">        this.createCircularSymLink(file);</span>

<span class="fc" id="L877">        assertEquals(&quot;Unexpected directory size&quot;, TEST_DIRECTORY_SIZE_BI, FileUtils.sizeOfDirectoryAsBigInteger(file));</span>

        // Existing directory which size is greater than zero
<span class="fc" id="L880">        file.delete();</span>
<span class="fc" id="L881">        file.mkdir();</span>

<span class="fc" id="L883">        final File nonEmptyFile = new File(file, &quot;nonEmptyFile&quot; + System.nanoTime());</span>
<span class="pc bpc" id="L884" title="1 of 2 branches missed.">        if (!nonEmptyFile.getParentFile().exists()) {</span>
<span class="nc" id="L885">            throw new IOException(&quot;Cannot create file &quot; + nonEmptyFile</span>
                    + &quot; as the parent directory does not exist&quot;);
        }
<span class="fc" id="L888">        final BufferedOutputStream output =</span>
                new BufferedOutputStream(new FileOutputStream(nonEmptyFile));
        try {
<span class="fc" id="L891">            TestUtils.generateTestData(output, TEST_DIRECTORY_SIZE_GT_ZERO_BI.longValue());</span>
        } finally {
<span class="fc" id="L893">            IOUtils.closeQuietly(output);</span>
        }
<span class="fc" id="L895">        nonEmptyFile.deleteOnExit();</span>

<span class="fc" id="L897">        assertEquals(&quot;Unexpected directory size&quot;, TEST_DIRECTORY_SIZE_GT_ZERO_BI,</span>
<span class="fc" id="L898">                FileUtils.sizeOfDirectoryAsBigInteger(file));</span>

<span class="fc" id="L900">        nonEmptyFile.delete();</span>
<span class="fc" id="L901">        file.delete();</span>
<span class="fc" id="L902">    }</span>

    // Compare sizes of a directory tree using long and BigInteger methods
    @Test
    public void testCompareSizeOf() {
<span class="fc" id="L907">        final File start = new File(&quot;src/test/java&quot;);</span>
<span class="fc" id="L908">        final long sizeLong1 = FileUtils.sizeOf(start);</span>
<span class="fc" id="L909">        final BigInteger sizeBig = FileUtils.sizeOfAsBigInteger(start);</span>
<span class="fc" id="L910">        final long sizeLong2 = FileUtils.sizeOf(start);</span>
<span class="fc" id="L911">        assertEquals(&quot;Size should not change&quot;, sizeLong1, sizeLong2);</span>
<span class="fc" id="L912">        assertEquals(&quot;longSize should equal BigSize&quot;, sizeLong1, sizeBig.longValue());</span>
<span class="fc" id="L913">    }</span>

    @Test
    public void testSizeOf() throws Exception {
<span class="fc" id="L917">        final File file = new File(getTestDirectory(), getName());</span>

        // Null argument
        try {
<span class="nc" id="L921">            FileUtils.sizeOf(null);</span>
<span class="nc" id="L922">            fail(&quot;Exception expected.&quot;);</span>
<span class="fc" id="L923">        } catch (final NullPointerException ignore) {</span>
<span class="nc" id="L924">        }</span>

        // Non-existent file
        try {
<span class="nc" id="L928">            FileUtils.sizeOf(file);</span>
<span class="nc" id="L929">            fail(&quot;Exception expected.&quot;);</span>
<span class="fc" id="L930">        } catch (final IllegalArgumentException ignore) {</span>
<span class="nc" id="L931">        }</span>

        // Creates file
<span class="fc" id="L934">        file.createNewFile();</span>
<span class="fc" id="L935">        file.deleteOnExit();</span>

        // New file
<span class="fc" id="L938">        assertEquals(0, FileUtils.sizeOf(file));</span>
<span class="fc" id="L939">        file.delete();</span>

        // Existing file
<span class="fc" id="L942">        assertEquals(&quot;Unexpected files size&quot;,</span>
                testFile1Size,
<span class="fc" id="L944">                FileUtils.sizeOf(testFile1));</span>

        // Existing directory
<span class="fc" id="L947">        assertEquals(&quot;Unexpected directory size&quot;,</span>
                TEST_DIRECTORY_SIZE,
<span class="fc" id="L949">                FileUtils.sizeOf(getTestDirectory()));</span>
<span class="fc" id="L950">    }</span>

    @Test
    public void testSizeOfAsBigInteger() throws Exception {
<span class="fc" id="L954">        final File file = new File(getTestDirectory(), getName());</span>

        // Null argument
        try {
<span class="nc" id="L958">            FileUtils.sizeOfAsBigInteger(null);</span>
<span class="nc" id="L959">            fail(&quot;Exception expected.&quot;);</span>
<span class="fc" id="L960">        } catch (final NullPointerException ignore) {</span>
<span class="nc" id="L961">        }</span>

        // Non-existent file
        try {
<span class="nc" id="L965">            FileUtils.sizeOfAsBigInteger(file);</span>
<span class="nc" id="L966">            fail(&quot;Exception expected.&quot;);</span>
<span class="fc" id="L967">        } catch (final IllegalArgumentException ignore) {</span>
<span class="nc" id="L968">        }</span>

        // Creates file
<span class="fc" id="L971">        file.createNewFile();</span>
<span class="fc" id="L972">        file.deleteOnExit();</span>

        // New file
<span class="fc" id="L975">        assertEquals(BigInteger.ZERO, FileUtils.sizeOfAsBigInteger(file));</span>
<span class="fc" id="L976">        file.delete();</span>

        // Existing file
<span class="fc" id="L979">        assertEquals(&quot;Unexpected files size&quot;,</span>
<span class="fc" id="L980">                BigInteger.valueOf(testFile1Size),</span>
<span class="fc" id="L981">                FileUtils.sizeOfAsBigInteger(testFile1));</span>

        // Existing directory
<span class="fc" id="L984">        assertEquals(&quot;Unexpected directory size&quot;,</span>
                TEST_DIRECTORY_SIZE_BI,
<span class="fc" id="L986">                FileUtils.sizeOfAsBigInteger(getTestDirectory()));</span>
<span class="fc" id="L987">    }</span>

    // isFileNewer / isFileOlder
    @Test
    public void testIsFileNewerOlder() throws Exception {
<span class="fc" id="L992">        final File reference = new File(getTestDirectory(), &quot;FileUtils-reference.txt&quot;);</span>
<span class="fc" id="L993">        final File oldFile = new File(getTestDirectory(), &quot;FileUtils-old.txt&quot;);</span>
<span class="fc" id="L994">        final File newFile = new File(getTestDirectory(), &quot;FileUtils-new.txt&quot;);</span>
<span class="fc" id="L995">        final File invalidFile = new File(getTestDirectory(), &quot;FileUtils-invalid-file.txt&quot;);</span>

        // Create Files
<span class="pc bpc" id="L998" title="1 of 2 branches missed.">        if (!oldFile.getParentFile().exists()) {</span>
<span class="nc" id="L999">            throw new IOException(&quot;Cannot create file &quot; + oldFile</span>
                    + &quot; as the parent directory does not exist&quot;);
        }
<span class="fc" id="L1002">        final BufferedOutputStream output1 =</span>
                new BufferedOutputStream(new FileOutputStream(oldFile));
        try {
<span class="fc" id="L1005">            TestUtils.generateTestData(output1, 0);</span>
        } finally {
<span class="fc" id="L1007">            IOUtils.closeQuietly(output1);</span>
        }

        do {
            try {
<span class="fc" id="L1012">                TestUtils.sleep(1000);</span>
<span class="nc" id="L1013">            } catch (final InterruptedException ie) {</span>
                // ignore
<span class="fc" id="L1015">            }</span>
<span class="pc bpc" id="L1016" title="1 of 2 branches missed.">            if (!reference.getParentFile().exists()) {</span>
<span class="nc" id="L1017">                throw new IOException(&quot;Cannot create file &quot; + reference</span>
                        + &quot; as the parent directory does not exist&quot;);
            }
<span class="fc" id="L1020">            final BufferedOutputStream output =</span>
                    new BufferedOutputStream(new FileOutputStream(reference));
            try {
<span class="fc" id="L1023">                TestUtils.generateTestData(output, 0);</span>
            } finally {
<span class="fc" id="L1025">                IOUtils.closeQuietly(output);</span>
            }
<span class="pc bpc" id="L1027" title="1 of 2 branches missed.">        } while (oldFile.lastModified() == reference.lastModified());</span>

<span class="fc" id="L1029">        final Date date = new Date();</span>
<span class="fc" id="L1030">        final long now = date.getTime();</span>

        do {
            try {
<span class="fc" id="L1034">                TestUtils.sleep(1000);</span>
<span class="nc" id="L1035">            } catch (final InterruptedException ie) {</span>
                // ignore
<span class="fc" id="L1037">            }</span>
<span class="pc bpc" id="L1038" title="1 of 2 branches missed.">            if (!newFile.getParentFile().exists()) {</span>
<span class="nc" id="L1039">                throw new IOException(&quot;Cannot create file &quot; + newFile</span>
                        + &quot; as the parent directory does not exist&quot;);
            }
<span class="fc" id="L1042">            final BufferedOutputStream output =</span>
                    new BufferedOutputStream(new FileOutputStream(newFile));
            try {
<span class="fc" id="L1045">                TestUtils.generateTestData(output, 0);</span>
            } finally {
<span class="fc" id="L1047">                IOUtils.closeQuietly(output);</span>
            }
<span class="pc bpc" id="L1049" title="1 of 2 branches missed.">        } while (reference.lastModified() == newFile.lastModified());</span>

        // Test isFileNewer()
<span class="fc" id="L1052">        assertFalse(&quot;Old File - Newer - File&quot;, FileUtils.isFileNewer(oldFile, reference));</span>
<span class="fc" id="L1053">        assertFalse(&quot;Old File - Newer - Date&quot;, FileUtils.isFileNewer(oldFile, date));</span>
<span class="fc" id="L1054">        assertFalse(&quot;Old File - Newer - Mili&quot;, FileUtils.isFileNewer(oldFile, now));</span>
<span class="fc" id="L1055">        assertTrue(&quot;New File - Newer - File&quot;, FileUtils.isFileNewer(newFile, reference));</span>
<span class="fc" id="L1056">        assertTrue(&quot;New File - Newer - Date&quot;, FileUtils.isFileNewer(newFile, date));</span>
<span class="fc" id="L1057">        assertTrue(&quot;New File - Newer - Mili&quot;, FileUtils.isFileNewer(newFile, now));</span>
<span class="fc" id="L1058">        assertFalse(&quot;Invalid - Newer - File&quot;, FileUtils.isFileNewer(invalidFile, reference));</span>
<span class="fc" id="L1059">        final String invalidFileName = invalidFile.getName();</span>
        try {
<span class="nc" id="L1061">            FileUtils.isFileNewer(newFile, invalidFile);</span>
<span class="nc" id="L1062">            fail(&quot;Should have cause IllegalArgumentException&quot;);</span>
<span class="fc" id="L1063">        } catch (final IllegalArgumentException iae) {</span>
<span class="fc" id="L1064">            final String message = iae.getMessage();</span>
<span class="fc" id="L1065">            assertTrue(&quot;Message should contain: &quot; + invalidFileName + &quot; but was: &quot; + message, message.contains(invalidFileName));</span>
<span class="nc" id="L1066">        }</span>

        // Test isFileOlder()
<span class="fc" id="L1069">        assertTrue(&quot;Old File - Older - File&quot;, FileUtils.isFileOlder(oldFile, reference));</span>
<span class="fc" id="L1070">        assertTrue(&quot;Old File - Older - Date&quot;, FileUtils.isFileOlder(oldFile, date));</span>
<span class="fc" id="L1071">        assertTrue(&quot;Old File - Older - Mili&quot;, FileUtils.isFileOlder(oldFile, now));</span>
<span class="fc" id="L1072">        assertFalse(&quot;New File - Older - File&quot;, FileUtils.isFileOlder(newFile, reference));</span>
<span class="fc" id="L1073">        assertFalse(&quot;New File - Older - Date&quot;, FileUtils.isFileOlder(newFile, date));</span>
<span class="fc" id="L1074">        assertFalse(&quot;New File - Older - Mili&quot;, FileUtils.isFileOlder(newFile, now));</span>
<span class="fc" id="L1075">        assertFalse(&quot;Invalid - Older - File&quot;, FileUtils.isFileOlder(invalidFile, reference));</span>
        try {
<span class="nc" id="L1077">            FileUtils.isFileOlder(newFile, invalidFile);</span>
<span class="nc" id="L1078">            fail(&quot;Should have cause IllegalArgumentException&quot;);</span>
<span class="fc" id="L1079">        } catch (final IllegalArgumentException iae) {</span>
<span class="fc" id="L1080">            final String message = iae.getMessage();</span>
<span class="fc" id="L1081">            assertTrue(&quot;Message should contain: &quot; + invalidFileName + &quot; but was: &quot; + message, message.contains(invalidFileName));</span>
<span class="nc" id="L1082">        }</span>


        // ----- Test isFileNewer() exceptions -----
        // Null File
        try {
<span class="nc" id="L1088">            FileUtils.isFileNewer(null, now);</span>
<span class="nc" id="L1089">            fail(&quot;Newer Null, expected IllegalArgumentExcepion&quot;);</span>
<span class="fc" id="L1090">        } catch (final IllegalArgumentException expected) {</span>
            // expected result
<span class="nc" id="L1092">        }</span>

        // Null reference File
        try {
<span class="nc" id="L1096">            FileUtils.isFileNewer(oldFile, (File) null);</span>
<span class="nc" id="L1097">            fail(&quot;Newer Null reference, expected IllegalArgumentExcepion&quot;);</span>
<span class="fc" id="L1098">        } catch (final IllegalArgumentException ignore) {</span>
            // expected result
<span class="nc" id="L1100">        }</span>

        // Invalid reference File
        try {
<span class="nc" id="L1104">            FileUtils.isFileNewer(oldFile, invalidFile);</span>
<span class="nc" id="L1105">            fail(&quot;Newer invalid reference, expected IllegalArgumentExcepion&quot;);</span>
<span class="fc" id="L1106">        } catch (final IllegalArgumentException ignore) {</span>
            // expected result
<span class="nc" id="L1108">        }</span>

        // Null reference Date
        try {
<span class="nc" id="L1112">            FileUtils.isFileNewer(oldFile, (Date) null);</span>
<span class="nc" id="L1113">            fail(&quot;Newer Null date, expected IllegalArgumentExcepion&quot;);</span>
<span class="fc" id="L1114">        } catch (final IllegalArgumentException ignore) {</span>
            // expected result
<span class="nc" id="L1116">        }</span>


        // ----- Test isFileOlder() exceptions -----
        // Null File
        try {
<span class="nc" id="L1122">            FileUtils.isFileOlder(null, now);</span>
<span class="nc" id="L1123">            fail(&quot;Older Null, expected IllegalArgumentExcepion&quot;);</span>
<span class="fc" id="L1124">        } catch (final IllegalArgumentException ignore) {</span>
            // expected result
<span class="nc" id="L1126">        }</span>

        // Null reference File
        try {
<span class="nc" id="L1130">            FileUtils.isFileOlder(oldFile, (File) null);</span>
<span class="nc" id="L1131">            fail(&quot;Older Null reference, expected IllegalArgumentExcepion&quot;);</span>
<span class="fc" id="L1132">        } catch (final IllegalArgumentException ignore) {</span>
            // expected result
<span class="nc" id="L1134">        }</span>

        // Invalid reference File
        try {
<span class="nc" id="L1138">            FileUtils.isFileOlder(oldFile, invalidFile);</span>
<span class="nc" id="L1139">            fail(&quot;Older invalid reference, expected IllegalArgumentExcepion&quot;);</span>
<span class="fc" id="L1140">        } catch (final IllegalArgumentException ignore) {</span>
            // expected result
<span class="nc" id="L1142">        }</span>

        // Null reference Date
        try {
<span class="nc" id="L1146">            FileUtils.isFileOlder(oldFile, (Date) null);</span>
<span class="nc" id="L1147">            fail(&quot;Older Null date, expected IllegalArgumentExcepion&quot;);</span>
<span class="fc" id="L1148">        } catch (final IllegalArgumentException ignore) {</span>
            // expected result
<span class="nc" id="L1150">        }</span>

<span class="fc" id="L1152">    }</span>

    // copyFile

    @Test
    public void testCopyFile1() throws Exception {
<span class="fc" id="L1158">        final File destination = new File(getTestDirectory(), &quot;copy1.txt&quot;);</span>

        //Thread.sleep(LAST_MODIFIED_DELAY);
        //This is to slow things down so we can catch if
        //the lastModified date is not ok

<span class="fc" id="L1164">        FileUtils.copyFile(testFile1, destination);</span>
<span class="fc" id="L1165">        assertTrue(&quot;Check Exist&quot;, destination.exists());</span>
<span class="fc" id="L1166">        assertEquals(&quot;Check Full copy&quot;, testFile1Size, destination.length());</span>
        /* disabled: Thread.sleep doesn't work reliantly for this case
        assertTrue(&quot;Check last modified date preserved&quot;,
            testFile1.lastModified() == destination.lastModified());*/
<span class="fc" id="L1170">    }</span>

    @Test
    public void testCopyFileToOutputStream() throws Exception {
<span class="fc" id="L1174">        final ByteArrayOutputStream destination = new ByteArrayOutputStream();</span>
<span class="fc" id="L1175">        FileUtils.copyFile(testFile1, destination);</span>
<span class="fc" id="L1176">        assertEquals(&quot;Check Full copy size&quot;, testFile1Size, destination.size());</span>
<span class="fc" id="L1177">        final byte[] expected = FileUtils.readFileToByteArray(testFile1);</span>
<span class="fc" id="L1178">        Assert.assertArrayEquals(&quot;Check Full copy&quot;, expected, destination.toByteArray());</span>
<span class="fc" id="L1179">    }</span>

    @Test
    @Ignore
    public void testCopyFileLarge() throws Exception {

<span class="nc" id="L1185">        final File largeFile = new File(getTestDirectory(), &quot;large.txt&quot;);</span>
<span class="nc" id="L1186">        final File destination = new File(getTestDirectory(), &quot;copylarge.txt&quot;);</span>

<span class="nc" id="L1188">        System.out.println(&quot;START:   &quot; + new java.util.Date());</span>
<span class="nc bnc" id="L1189" title="All 2 branches missed.">        if (!largeFile.getParentFile().exists()) {</span>
<span class="nc" id="L1190">            throw new IOException(&quot;Cannot create file &quot; + largeFile</span>
                    + &quot; as the parent directory does not exist&quot;);
        }
<span class="nc" id="L1193">        final BufferedOutputStream output =</span>
                new BufferedOutputStream(new FileOutputStream(largeFile));
        try {
<span class="nc" id="L1196">            TestUtils.generateTestData(output, FileUtils.ONE_GB);</span>
        } finally {
<span class="nc" id="L1198">            IOUtils.closeQuietly(output);</span>
        }
<span class="nc" id="L1200">        System.out.println(&quot;CREATED: &quot; + new java.util.Date());</span>
<span class="nc" id="L1201">        FileUtils.copyFile(largeFile, destination);</span>
<span class="nc" id="L1202">        System.out.println(&quot;COPIED:  &quot; + new java.util.Date());</span>

<span class="nc" id="L1204">        assertTrue(&quot;Check Exist&quot;, destination.exists());</span>
<span class="nc" id="L1205">        assertEquals(&quot;Check Full copy&quot;, largeFile.length(), destination.length());</span>
<span class="nc" id="L1206">    }</span>

    @Test
    public void testCopyFile2() throws Exception {
<span class="fc" id="L1210">        final File destination = new File(getTestDirectory(), &quot;copy2.txt&quot;);</span>

        //Thread.sleep(LAST_MODIFIED_DELAY);
        //This is to slow things down so we can catch if
        //the lastModified date is not ok

<span class="fc" id="L1216">        FileUtils.copyFile(testFile1, destination);</span>
<span class="fc" id="L1217">        assertTrue(&quot;Check Exist&quot;, destination.exists());</span>
<span class="fc" id="L1218">        assertEquals(&quot;Check Full copy&quot;, testFile2Size, destination.length());</span>
        /* disabled: Thread.sleep doesn't work reliably for this case
        assertTrue(&quot;Check last modified date preserved&quot;,
            testFile1.lastModified() == destination.lastModified());*/
<span class="fc" id="L1222">    }</span>

    @Test
    public void testCopyToSelf() throws Exception {
<span class="fc" id="L1226">        final File destination = new File(getTestDirectory(), &quot;copy3.txt&quot;);</span>
        //Prepare a test file
<span class="fc" id="L1228">        FileUtils.copyFile(testFile1, destination);</span>

        try {
<span class="nc" id="L1231">            FileUtils.copyFile(destination, destination);</span>
<span class="nc" id="L1232">            fail(&quot;file copy to self should not be possible&quot;);</span>
<span class="fc" id="L1233">        } catch (final IOException ioe) {</span>
            //we want the exception, copy to self should be illegal
<span class="nc" id="L1235">        }</span>
<span class="fc" id="L1236">    }</span>

    @Test
    public void testCopyFile2WithoutFileDatePreservation() throws Exception {
<span class="fc" id="L1240">        final File destination = new File(getTestDirectory(), &quot;copy2.txt&quot;);</span>

        //Thread.sleep(LAST_MODIFIED_DELAY);
        //This is to slow things down so we can catch if
        //the lastModified date is not ok

<span class="fc" id="L1246">        FileUtils.copyFile(testFile1, destination, false);</span>
<span class="fc" id="L1247">        assertTrue(&quot;Check Exist&quot;, destination.exists());</span>
<span class="fc" id="L1248">        assertEquals(&quot;Check Full copy&quot;, testFile2Size, destination.length());</span>
        /* disabled: Thread.sleep doesn't work reliantly for this case
        assertTrue(&quot;Check last modified date modified&quot;,
            testFile1.lastModified() != destination.lastModified());*/
<span class="fc" id="L1252">    }</span>

    @Test
    public void testCopyDirectoryToDirectory_NonExistingDest() throws Exception {
<span class="pc bpc" id="L1256" title="1 of 2 branches missed.">        if (!testFile1.getParentFile().exists()) {</span>
<span class="nc" id="L1257">            throw new IOException(&quot;Cannot create file &quot; + testFile1</span>
                    + &quot; as the parent directory does not exist&quot;);
        }
<span class="fc" id="L1260">        final BufferedOutputStream output1 =</span>
                new BufferedOutputStream(new FileOutputStream(testFile1));
        try {
<span class="fc" id="L1263">            TestUtils.generateTestData(output1, 1234);</span>
        } finally {
<span class="fc" id="L1265">            IOUtils.closeQuietly(output1);</span>
        }
<span class="pc bpc" id="L1267" title="1 of 2 branches missed.">        if (!testFile2.getParentFile().exists()) {</span>
<span class="nc" id="L1268">            throw new IOException(&quot;Cannot create file &quot; + testFile2</span>
                    + &quot; as the parent directory does not exist&quot;);
        }
<span class="fc" id="L1271">        final BufferedOutputStream output =</span>
                new BufferedOutputStream(new FileOutputStream(testFile2));
        try {
<span class="fc" id="L1274">            TestUtils.generateTestData(output, 4321);</span>
        } finally {
<span class="fc" id="L1276">            IOUtils.closeQuietly(output);</span>
        }
<span class="fc" id="L1278">        final File srcDir = getTestDirectory();</span>
<span class="fc" id="L1279">        final File subDir = new File(srcDir, &quot;sub&quot;);</span>
<span class="fc" id="L1280">        subDir.mkdir();</span>
<span class="fc" id="L1281">        final File subFile = new File(subDir, &quot;A.txt&quot;);</span>
<span class="fc" id="L1282">        FileUtils.writeStringToFile(subFile, &quot;HELLO WORLD&quot;, &quot;UTF8&quot;);</span>
<span class="fc" id="L1283">        final File destDir = new File(System.getProperty(&quot;java.io.tmpdir&quot;), &quot;tmp-FileUtilsTestCase&quot;);</span>
<span class="fc" id="L1284">        FileUtils.deleteDirectory(destDir);</span>
<span class="fc" id="L1285">        final File actualDestDir = new File(destDir, srcDir.getName());</span>

<span class="fc" id="L1287">        FileUtils.copyDirectoryToDirectory(srcDir, destDir);</span>

<span class="fc" id="L1289">        assertTrue(&quot;Check exists&quot;, destDir.exists());</span>
<span class="fc" id="L1290">        assertTrue(&quot;Check exists&quot;, actualDestDir.exists());</span>
<span class="fc" id="L1291">        final long srcSize = FileUtils.sizeOfDirectory(srcDir);</span>
<span class="pc bpc" id="L1292" title="1 of 2 branches missed.">        assertTrue(&quot;Size &gt; 0&quot;, srcSize &gt; 0);</span>
<span class="fc" id="L1293">        assertEquals(&quot;Check size&quot;, srcSize, FileUtils.sizeOfDirectory(actualDestDir));</span>
<span class="fc" id="L1294">        assertTrue(new File(actualDestDir, &quot;sub/A.txt&quot;).exists());</span>
<span class="fc" id="L1295">        FileUtils.deleteDirectory(destDir);</span>
<span class="fc" id="L1296">    }</span>

    @Test
    public void testCopyDirectoryToNonExistingDest() throws Exception {
<span class="pc bpc" id="L1300" title="1 of 2 branches missed.">        if (!testFile1.getParentFile().exists()) {</span>
<span class="nc" id="L1301">            throw new IOException(&quot;Cannot create file &quot; + testFile1</span>
                    + &quot; as the parent directory does not exist&quot;);
        }
<span class="fc" id="L1304">        final BufferedOutputStream output1 =</span>
                new BufferedOutputStream(new FileOutputStream(testFile1));
        try {
<span class="fc" id="L1307">            TestUtils.generateTestData(output1, 1234);</span>
        } finally {
<span class="fc" id="L1309">            IOUtils.closeQuietly(output1);</span>
        }
<span class="pc bpc" id="L1311" title="1 of 2 branches missed.">        if (!testFile2.getParentFile().exists()) {</span>
<span class="nc" id="L1312">            throw new IOException(&quot;Cannot create file &quot; + testFile2</span>
                    + &quot; as the parent directory does not exist&quot;);
        }
<span class="fc" id="L1315">        final BufferedOutputStream output =</span>
                new BufferedOutputStream(new FileOutputStream(testFile2));
        try {
<span class="fc" id="L1318">            TestUtils.generateTestData(output, 4321);</span>
        } finally {
<span class="fc" id="L1320">            IOUtils.closeQuietly(output);</span>
        }
<span class="fc" id="L1322">        final File srcDir = getTestDirectory();</span>
<span class="fc" id="L1323">        final File subDir = new File(srcDir, &quot;sub&quot;);</span>
<span class="fc" id="L1324">        subDir.mkdir();</span>
<span class="fc" id="L1325">        final File subFile = new File(subDir, &quot;A.txt&quot;);</span>
<span class="fc" id="L1326">        FileUtils.writeStringToFile(subFile, &quot;HELLO WORLD&quot;, &quot;UTF8&quot;);</span>
<span class="fc" id="L1327">        final File destDir = new File(System.getProperty(&quot;java.io.tmpdir&quot;), &quot;tmp-FileUtilsTestCase&quot;);</span>
<span class="fc" id="L1328">        FileUtils.deleteDirectory(destDir);</span>

<span class="fc" id="L1330">        FileUtils.copyDirectory(srcDir, destDir);</span>

<span class="fc" id="L1332">        assertTrue(&quot;Check exists&quot;, destDir.exists());</span>
<span class="fc" id="L1333">        final long sizeOfSrcDirectory = FileUtils.sizeOfDirectory(srcDir);</span>
<span class="pc bpc" id="L1334" title="1 of 2 branches missed.">        assertTrue(&quot;Size &gt; 0&quot;, sizeOfSrcDirectory &gt; 0);</span>
<span class="fc" id="L1335">        assertEquals(&quot;Check size&quot;, sizeOfSrcDirectory, FileUtils.sizeOfDirectory(destDir));</span>
<span class="fc" id="L1336">        assertTrue(new File(destDir, &quot;sub/A.txt&quot;).exists());</span>
<span class="fc" id="L1337">        FileUtils.deleteDirectory(destDir);</span>
<span class="fc" id="L1338">    }</span>

    @Test
    public void testCopyDirectoryToExistingDest() throws Exception {
<span class="pc bpc" id="L1342" title="1 of 2 branches missed.">        if (!testFile1.getParentFile().exists()) {</span>
<span class="nc" id="L1343">            throw new IOException(&quot;Cannot create file &quot; + testFile1</span>
                    + &quot; as the parent directory does not exist&quot;);
        }
<span class="fc" id="L1346">        final BufferedOutputStream output1 =</span>
                new BufferedOutputStream(new FileOutputStream(testFile1));
        try {
<span class="fc" id="L1349">            TestUtils.generateTestData(output1, 1234);</span>
        } finally {
<span class="fc" id="L1351">            IOUtils.closeQuietly(output1);</span>
        }
<span class="pc bpc" id="L1353" title="1 of 2 branches missed.">        if (!testFile2.getParentFile().exists()) {</span>
<span class="nc" id="L1354">            throw new IOException(&quot;Cannot create file &quot; + testFile2</span>
                    + &quot; as the parent directory does not exist&quot;);
        }
<span class="fc" id="L1357">        final BufferedOutputStream output =</span>
                new BufferedOutputStream(new FileOutputStream(testFile2));
        try {
<span class="fc" id="L1360">            TestUtils.generateTestData(output, 4321);</span>
        } finally {
<span class="fc" id="L1362">            IOUtils.closeQuietly(output);</span>
        }
<span class="fc" id="L1364">        final File srcDir = getTestDirectory();</span>
<span class="fc" id="L1365">        final File subDir = new File(srcDir, &quot;sub&quot;);</span>
<span class="fc" id="L1366">        subDir.mkdir();</span>
<span class="fc" id="L1367">        final File subFile = new File(subDir, &quot;A.txt&quot;);</span>
<span class="fc" id="L1368">        FileUtils.writeStringToFile(subFile, &quot;HELLO WORLD&quot;, &quot;UTF8&quot;);</span>
<span class="fc" id="L1369">        final File destDir = new File(System.getProperty(&quot;java.io.tmpdir&quot;), &quot;tmp-FileUtilsTestCase&quot;);</span>
<span class="fc" id="L1370">        FileUtils.deleteDirectory(destDir);</span>
<span class="fc" id="L1371">        destDir.mkdirs();</span>

<span class="fc" id="L1373">        FileUtils.copyDirectory(srcDir, destDir);</span>

<span class="fc" id="L1375">        final long srcSize = FileUtils.sizeOfDirectory(srcDir);</span>
<span class="pc bpc" id="L1376" title="1 of 2 branches missed.">        assertTrue(&quot;Size &gt; 0&quot;, srcSize &gt; 0);</span>
<span class="fc" id="L1377">        assertEquals(srcSize, FileUtils.sizeOfDirectory(destDir));</span>
<span class="fc" id="L1378">        assertTrue(new File(destDir, &quot;sub/A.txt&quot;).exists());</span>
<span class="fc" id="L1379">    }</span>

    @Test
    public void testCopyDirectoryFiltered() throws Exception {
<span class="fc" id="L1383">        final File grandParentDir = new File(getTestDirectory(), &quot;grandparent&quot;);</span>
<span class="fc" id="L1384">        final File parentDir = new File(grandParentDir, &quot;parent&quot;);</span>
<span class="fc" id="L1385">        final File childDir = new File(parentDir, &quot;child&quot;);</span>
<span class="fc" id="L1386">        createFilesForTestCopyDirectory(grandParentDir, parentDir, childDir);</span>

<span class="fc" id="L1388">        final NameFileFilter filter = new NameFileFilter(new String[]{&quot;parent&quot;, &quot;child&quot;, &quot;file3.txt&quot;});</span>
<span class="fc" id="L1389">        final File destDir = new File(getTestDirectory(), &quot;copydest&quot;);</span>

<span class="fc" id="L1391">        FileUtils.copyDirectory(grandParentDir, destDir, filter);</span>
<span class="fc" id="L1392">        final List&lt;File&gt; files = LIST_WALKER.list(destDir);</span>
<span class="fc" id="L1393">        assertEquals(3, files.size());</span>
<span class="fc" id="L1394">        assertEquals(&quot;parent&quot;, files.get(0).getName());</span>
<span class="fc" id="L1395">        assertEquals(&quot;child&quot;, files.get(1).getName());</span>
<span class="fc" id="L1396">        assertEquals(&quot;file3.txt&quot;, files.get(2).getName());</span>
<span class="fc" id="L1397">    }</span>

    @Test
    public void testCopyDirectoryPreserveDates() throws Exception {
<span class="fc" id="L1401">        final File source = new File(getTestDirectory(), &quot;source&quot;);</span>
<span class="fc" id="L1402">        final File sourceDirectory = new File(source, &quot;directory&quot;);</span>
<span class="fc" id="L1403">        final File sourceFile = new File(sourceDirectory, &quot;hello.txt&quot;);</span>

        // Prepare source data
<span class="fc" id="L1406">        source.mkdirs();</span>
<span class="fc" id="L1407">        sourceDirectory.mkdir();</span>
<span class="fc" id="L1408">        FileUtils.writeStringToFile(sourceFile, &quot;HELLO WORLD&quot;, &quot;UTF8&quot;);</span>
        // Set dates in reverse order to avoid overwriting previous values
        // Also, use full seconds (arguments are in ms) close to today
        // but still highly unlikely to occur in the real world
<span class="fc" id="L1412">        sourceFile.setLastModified(1000000002000L);</span>
<span class="fc" id="L1413">        sourceDirectory.setLastModified(1000000001000L);</span>
<span class="fc" id="L1414">        source.setLastModified(1000000000000L);</span>

<span class="fc" id="L1416">        final File target = new File(getTestDirectory(), &quot;target&quot;);</span>
<span class="fc" id="L1417">        final File targetDirectory = new File(target, &quot;directory&quot;);</span>
<span class="fc" id="L1418">        final File targetFile = new File(targetDirectory, &quot;hello.txt&quot;);</span>

        // Test with preserveFileDate disabled
<span class="fc" id="L1421">        FileUtils.copyDirectory(source, target, false);</span>
<span class="pc bpc" id="L1422" title="1 of 2 branches missed.">        assertTrue(1000000000000L != target.lastModified());</span>
<span class="pc bpc" id="L1423" title="1 of 2 branches missed.">        assertTrue(1000000001000L != targetDirectory.lastModified());</span>
<span class="pc bpc" id="L1424" title="1 of 2 branches missed.">        assertTrue(1000000002000L != targetFile.lastModified());</span>
<span class="fc" id="L1425">        FileUtils.deleteDirectory(target);</span>

        // Test with preserveFileDate enabled
<span class="fc" id="L1428">        FileUtils.copyDirectory(source, target, true);</span>
<span class="fc" id="L1429">        assertEquals(1000000000000L, target.lastModified());</span>
<span class="fc" id="L1430">        assertEquals(1000000001000L, targetDirectory.lastModified());</span>
<span class="fc" id="L1431">        assertEquals(1000000002000L, targetFile.lastModified());</span>
<span class="fc" id="L1432">        FileUtils.deleteDirectory(target);</span>

        // also if the target directory already exists (IO-190)
<span class="fc" id="L1435">        target.mkdirs();</span>
<span class="fc" id="L1436">        FileUtils.copyDirectory(source, target, true);</span>
<span class="fc" id="L1437">        assertEquals(1000000000000L, target.lastModified());</span>
<span class="fc" id="L1438">        assertEquals(1000000001000L, targetDirectory.lastModified());</span>
<span class="fc" id="L1439">        assertEquals(1000000002000L, targetFile.lastModified());</span>
<span class="fc" id="L1440">        FileUtils.deleteDirectory(target);</span>

        // also if the target subdirectory already exists (IO-190)
<span class="fc" id="L1443">        targetDirectory.mkdirs();</span>
<span class="fc" id="L1444">        FileUtils.copyDirectory(source, target, true);</span>
<span class="fc" id="L1445">        assertEquals(1000000000000L, target.lastModified());</span>
<span class="fc" id="L1446">        assertEquals(1000000001000L, targetDirectory.lastModified());</span>
<span class="fc" id="L1447">        assertEquals(1000000002000L, targetFile.lastModified());</span>
<span class="fc" id="L1448">        FileUtils.deleteDirectory(target);</span>
<span class="fc" id="L1449">    }</span>

    /* Test for IO-141 */
    @Test
    public void testCopyDirectoryToChild() throws Exception {
<span class="fc" id="L1454">        final File grandParentDir = new File(getTestDirectory(), &quot;grandparent&quot;);</span>
<span class="fc" id="L1455">        final File parentDir = new File(grandParentDir, &quot;parent&quot;);</span>
<span class="fc" id="L1456">        final File childDir = new File(parentDir, &quot;child&quot;);</span>
<span class="fc" id="L1457">        createFilesForTestCopyDirectory(grandParentDir, parentDir, childDir);</span>

<span class="fc" id="L1459">        final long expectedCount = LIST_WALKER.list(grandParentDir).size() +</span>
<span class="fc" id="L1460">                LIST_WALKER.list(parentDir).size();</span>
<span class="fc" id="L1461">        final long expectedSize = FileUtils.sizeOfDirectory(grandParentDir) +</span>
<span class="fc" id="L1462">                FileUtils.sizeOfDirectory(parentDir);</span>
<span class="fc" id="L1463">        FileUtils.copyDirectory(parentDir, childDir);</span>
<span class="fc" id="L1464">        assertEquals(expectedCount, LIST_WALKER.list(grandParentDir).size());</span>
<span class="fc" id="L1465">        assertEquals(expectedSize, FileUtils.sizeOfDirectory(grandParentDir));</span>
<span class="pc bpc" id="L1466" title="1 of 2 branches missed.">        assertTrue(&quot;Count &gt; 0&quot;, expectedCount &gt; 0);</span>
<span class="pc bpc" id="L1467" title="1 of 2 branches missed.">        assertTrue(&quot;Size &gt; 0&quot;, expectedSize &gt; 0);</span>
<span class="fc" id="L1468">    }</span>

    /* Test for IO-141 */
    @Test
    public void testCopyDirectoryToGrandChild() throws Exception {
<span class="fc" id="L1473">        final File grandParentDir = new File(getTestDirectory(), &quot;grandparent&quot;);</span>
<span class="fc" id="L1474">        final File parentDir = new File(grandParentDir, &quot;parent&quot;);</span>
<span class="fc" id="L1475">        final File childDir = new File(parentDir, &quot;child&quot;);</span>
<span class="fc" id="L1476">        createFilesForTestCopyDirectory(grandParentDir, parentDir, childDir);</span>

<span class="fc" id="L1478">        final long expectedCount = LIST_WALKER.list(grandParentDir).size() * 2;</span>
<span class="fc" id="L1479">        final long expectedSize = FileUtils.sizeOfDirectory(grandParentDir) * 2;</span>
<span class="fc" id="L1480">        FileUtils.copyDirectory(grandParentDir, childDir);</span>
<span class="fc" id="L1481">        assertEquals(expectedCount, LIST_WALKER.list(grandParentDir).size());</span>
<span class="fc" id="L1482">        assertEquals(expectedSize, FileUtils.sizeOfDirectory(grandParentDir));</span>
<span class="pc bpc" id="L1483" title="1 of 2 branches missed.">        assertTrue(&quot;Size &gt; 0&quot;, expectedSize &gt; 0);</span>
<span class="fc" id="L1484">    }</span>

    /* Test for IO-217 FileUtils.copyDirectoryToDirectory makes infinite loops */
    @Test
    public void testCopyDirectoryToItself() throws Exception {
<span class="fc" id="L1489">        final File dir = new File(getTestDirectory(), &quot;itself&quot;);</span>
<span class="fc" id="L1490">        dir.mkdirs();</span>
<span class="fc" id="L1491">        FileUtils.copyDirectoryToDirectory(dir, dir);</span>
<span class="fc" id="L1492">        assertEquals(1, LIST_WALKER.list(dir).size());</span>
<span class="fc" id="L1493">    }</span>

    private void createFilesForTestCopyDirectory(final File grandParentDir, final File parentDir, final File childDir) throws Exception {
<span class="fc" id="L1496">        final File childDir2 = new File(parentDir, &quot;child2&quot;);</span>
<span class="fc" id="L1497">        final File grandChildDir = new File(childDir, &quot;grandChild&quot;);</span>
<span class="fc" id="L1498">        final File grandChild2Dir = new File(childDir2, &quot;grandChild2&quot;);</span>
<span class="fc" id="L1499">        final File file1 = new File(grandParentDir, &quot;file1.txt&quot;);</span>
<span class="fc" id="L1500">        final File file2 = new File(parentDir, &quot;file2.txt&quot;);</span>
<span class="fc" id="L1501">        final File file3 = new File(childDir, &quot;file3.txt&quot;);</span>
<span class="fc" id="L1502">        final File file4 = new File(childDir2, &quot;file4.txt&quot;);</span>
<span class="fc" id="L1503">        final File file5 = new File(grandChildDir, &quot;file5.txt&quot;);</span>
<span class="fc" id="L1504">        final File file6 = new File(grandChild2Dir, &quot;file6.txt&quot;);</span>
<span class="fc" id="L1505">        FileUtils.deleteDirectory(grandParentDir);</span>
<span class="fc" id="L1506">        grandChildDir.mkdirs();</span>
<span class="fc" id="L1507">        grandChild2Dir.mkdirs();</span>
<span class="fc" id="L1508">        FileUtils.writeStringToFile(file1, &quot;File 1 in grandparent&quot;, &quot;UTF8&quot;);</span>
<span class="fc" id="L1509">        FileUtils.writeStringToFile(file2, &quot;File 2 in parent&quot;, &quot;UTF8&quot;);</span>
<span class="fc" id="L1510">        FileUtils.writeStringToFile(file3, &quot;File 3 in child&quot;, &quot;UTF8&quot;);</span>
<span class="fc" id="L1511">        FileUtils.writeStringToFile(file4, &quot;File 4 in child2&quot;, &quot;UTF8&quot;);</span>
<span class="fc" id="L1512">        FileUtils.writeStringToFile(file5, &quot;File 5 in grandChild&quot;, &quot;UTF8&quot;);</span>
<span class="fc" id="L1513">        FileUtils.writeStringToFile(file6, &quot;File 6 in grandChild2&quot;, &quot;UTF8&quot;);</span>
<span class="fc" id="L1514">    }</span>

    @Test
    public void testCopyDirectoryErrors() throws Exception {
        try {
<span class="nc" id="L1519">            FileUtils.copyDirectory(null, null);</span>
<span class="nc" id="L1520">            fail();</span>
<span class="fc" id="L1521">        } catch (final NullPointerException ignore) {</span>
<span class="nc" id="L1522">        }</span>
        try {
<span class="nc" id="L1524">            FileUtils.copyDirectory(new File(&quot;a&quot;), null);</span>
<span class="nc" id="L1525">            fail();</span>
<span class="fc" id="L1526">        } catch (final NullPointerException ignore) {</span>
<span class="nc" id="L1527">        }</span>
        try {
<span class="nc" id="L1529">            FileUtils.copyDirectory(null, new File(&quot;a&quot;));</span>
<span class="nc" id="L1530">            fail();</span>
<span class="fc" id="L1531">        } catch (final NullPointerException ignore) {</span>
<span class="nc" id="L1532">        }</span>
        try {
<span class="nc" id="L1534">            FileUtils.copyDirectory(new File(&quot;doesnt-exist&quot;), new File(&quot;a&quot;));</span>
<span class="nc" id="L1535">            fail();</span>
<span class="fc" id="L1536">        } catch (final IOException ignore) {</span>
<span class="nc" id="L1537">        }</span>
        try {
<span class="nc" id="L1539">            FileUtils.copyDirectory(testFile1, new File(&quot;a&quot;));</span>
<span class="nc" id="L1540">            fail();</span>
<span class="fc" id="L1541">        } catch (final IOException ignore) {</span>
<span class="nc" id="L1542">        }</span>
        try {
<span class="nc" id="L1544">            FileUtils.copyDirectory(getTestDirectory(), testFile1);</span>
<span class="nc" id="L1545">            fail();</span>
<span class="fc" id="L1546">        } catch (final IOException ignore) {</span>
<span class="nc" id="L1547">        }</span>
        try {
<span class="nc" id="L1549">            FileUtils.copyDirectory(getTestDirectory(), getTestDirectory());</span>
<span class="nc" id="L1550">            fail();</span>
<span class="fc" id="L1551">        } catch (final IOException ignore) {</span>
<span class="nc" id="L1552">        }</span>
<span class="fc" id="L1553">    }</span>

    // copyToDirectory

    @Test
    public void testCopyToDirectoryWithFile() throws IOException {
<span class="fc" id="L1559">        final File directory = new File(getTestDirectory(), &quot;subdir&quot;);</span>
<span class="pc bpc" id="L1560" title="1 of 2 branches missed.">        if (!directory.exists()) {</span>
<span class="fc" id="L1561">            directory.mkdirs();</span>
        }
<span class="fc" id="L1563">        final File destination = new File(directory, testFile1.getName());</span>

<span class="fc" id="L1565">        FileUtils.copyToDirectory(testFile1, directory);</span>
<span class="fc" id="L1566">        assertTrue(&quot;Check Exists&quot;, destination.exists());</span>
<span class="fc" id="L1567">        assertEquals(&quot;Check Full Copy&quot;, testFile1Size, destination.length());</span>
<span class="fc" id="L1568">    }</span>

    @Test(expected=NullPointerException.class)
    public void testCopyToDirectoryWithFileSourceIsNull() throws IOException {
<span class="nc" id="L1572">        FileUtils.copyToDirectory((File) null, getTestDirectory());</span>
<span class="nc" id="L1573">    }</span>

    @Test(expected=IOException.class)
    public void testCopyToDirectoryWithFileSourceDoesNotExist() throws IOException {
<span class="nc" id="L1577">        FileUtils.copyToDirectory(new File(getTestDirectory(), &quot;doesNotExists&quot;), getTestDirectory());</span>
<span class="nc" id="L1578">    }</span>

    @Test
    public void testCopyToDirectoryWithDirectory() throws IOException {
<span class="fc" id="L1582">        final File destDirectory = new File(getTestDirectory(), &quot;destination&quot;);</span>
<span class="pc bpc" id="L1583" title="1 of 2 branches missed.">        if (!destDirectory.exists()) {</span>
<span class="fc" id="L1584">            destDirectory.mkdirs();</span>
        }

        // Create a test directory
<span class="fc" id="L1588">        final File inputDirectory = new File(getTestDirectory(), &quot;input&quot;);</span>
<span class="pc bpc" id="L1589" title="1 of 2 branches missed.">        if (!inputDirectory.exists()) {</span>
<span class="fc" id="L1590">            inputDirectory.mkdirs();</span>
        }
<span class="fc" id="L1592">        final File outputDirDestination = new File(destDirectory, inputDirectory.getName());</span>
<span class="fc" id="L1593">        FileUtils.copyToDirectory(testFile1, inputDirectory);</span>
<span class="fc" id="L1594">        final File destFile1 = new File(outputDirDestination, testFile1.getName());</span>
<span class="fc" id="L1595">        FileUtils.copyToDirectory(testFile2, inputDirectory);</span>
<span class="fc" id="L1596">        final File destFile2 = new File(outputDirDestination, testFile2.getName());</span>

<span class="fc" id="L1598">        FileUtils.copyToDirectory(inputDirectory, destDirectory);</span>

        // Check the directory was created
<span class="fc" id="L1601">        assertTrue(&quot;Check Exists&quot;, outputDirDestination.exists());</span>
<span class="fc" id="L1602">        assertTrue(&quot;Check Directory&quot;, outputDirDestination.isDirectory());</span>

        // Check each file
<span class="fc" id="L1605">        assertTrue(&quot;Check Exists&quot;, destFile1.exists());</span>
<span class="fc" id="L1606">        assertEquals(&quot;Check Full Copy&quot;, testFile1Size, destFile1.length());</span>
<span class="fc" id="L1607">        assertTrue(&quot;Check Exists&quot;, destFile2.exists());</span>
<span class="fc" id="L1608">        assertEquals(&quot;Check Full Copy&quot;, testFile2Size, destFile2.length());</span>
<span class="fc" id="L1609">    }</span>

    @Test
    public void testCopyToDirectoryWithIterable() throws IOException {
<span class="fc" id="L1613">        final File directory = new File(getTestDirectory(), &quot;subdir&quot;);</span>
<span class="pc bpc" id="L1614" title="1 of 2 branches missed.">        if (!directory.exists()) {</span>
<span class="fc" id="L1615">            directory.mkdirs();</span>
        }

<span class="fc" id="L1618">        final List&lt;File&gt; input = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L1619">        input.add(testFile1);</span>
<span class="fc" id="L1620">        input.add(testFile2);</span>

<span class="fc" id="L1622">        final File destFile1 = new File(directory, testFile1.getName());</span>
<span class="fc" id="L1623">        final File destFile2 = new File(directory, testFile2.getName());</span>

<span class="fc" id="L1625">        FileUtils.copyToDirectory(input, directory);</span>
        // Check each file
<span class="fc" id="L1627">        assertTrue(&quot;Check Exists&quot;, destFile1.exists());</span>
<span class="fc" id="L1628">        assertEquals(&quot;Check Full Copy&quot;, testFile1Size, destFile1.length());</span>
<span class="fc" id="L1629">        assertTrue(&quot;Check Exists&quot;, destFile2.exists());</span>
<span class="fc" id="L1630">        assertEquals(&quot;Check Full Copy&quot;, testFile2Size, destFile2.length());</span>
<span class="fc" id="L1631">    }</span>

    @Test(expected=NullPointerException.class)
    public void testCopyToDirectoryWithIterableSourceIsNull() throws IOException {
<span class="nc" id="L1635">        FileUtils.copyToDirectory((List&lt;File&gt;) null, getTestDirectory());</span>
<span class="nc" id="L1636">    }</span>

    @Test(expected=IOException.class)
    public void testCopyToDirectoryWithIterableSourceDoesNotExist() throws IOException {
<span class="pc" id="L1640">        FileUtils.copyToDirectory(Collections.singleton(new File(getTestDirectory(), &quot;doesNotExists&quot;)),</span>
<span class="fc" id="L1641">                getTestDirectory());</span>
<span class="nc" id="L1642">    }</span>

    // forceDelete

    @Test
    public void testForceDeleteAFile1() throws Exception {
<span class="fc" id="L1648">        final File destination = new File(getTestDirectory(), &quot;copy1.txt&quot;);</span>
<span class="fc" id="L1649">        destination.createNewFile();</span>
<span class="fc" id="L1650">        assertTrue(&quot;Copy1.txt doesn't exist to delete&quot;, destination.exists());</span>
<span class="fc" id="L1651">        FileUtils.forceDelete(destination);</span>
<span class="pc bpc" id="L1652" title="1 of 2 branches missed.">        assertTrue(&quot;Check No Exist&quot;, !destination.exists());</span>
<span class="fc" id="L1653">    }</span>

    @Test
    public void testForceDeleteAFile2() throws Exception {
<span class="fc" id="L1657">        final File destination = new File(getTestDirectory(), &quot;copy2.txt&quot;);</span>
<span class="fc" id="L1658">        destination.createNewFile();</span>
<span class="fc" id="L1659">        assertTrue(&quot;Copy2.txt doesn't exist to delete&quot;, destination.exists());</span>
<span class="fc" id="L1660">        FileUtils.forceDelete(destination);</span>
<span class="pc bpc" id="L1661" title="1 of 2 branches missed.">        assertTrue(&quot;Check No Exist&quot;, !destination.exists());</span>
<span class="fc" id="L1662">    }</span>

    @Test
    public void testForceDeleteAFile3() throws Exception {
<span class="fc" id="L1666">        final File destination = new File(getTestDirectory(), &quot;no_such_file&quot;);</span>
<span class="pc bpc" id="L1667" title="1 of 2 branches missed.">        assertTrue(&quot;Check No Exist&quot;, !destination.exists());</span>
        try {
<span class="nc" id="L1669">            FileUtils.forceDelete(destination);</span>
<span class="nc" id="L1670">            fail(&quot;Should generate FileNotFoundException&quot;);</span>
<span class="fc" id="L1671">        } catch (final FileNotFoundException ignored) {</span>
<span class="nc" id="L1672">        }</span>
<span class="fc" id="L1673">    }</span>

    // copyFileToDirectory

    @Test
    public void testCopyFile1ToDir() throws Exception {
<span class="fc" id="L1679">        final File directory = new File(getTestDirectory(), &quot;subdir&quot;);</span>
<span class="pc bpc" id="L1680" title="1 of 2 branches missed.">        if (!directory.exists()) {</span>
<span class="fc" id="L1681">            directory.mkdirs();</span>
        }
<span class="fc" id="L1683">        final File destination = new File(directory, testFile1.getName());</span>

        //Thread.sleep(LAST_MODIFIED_DELAY);
        //This is to slow things down so we can catch if
        //the lastModified date is not ok

<span class="fc" id="L1689">        FileUtils.copyFileToDirectory(testFile1, directory);</span>
<span class="fc" id="L1690">        assertTrue(&quot;Check Exist&quot;, destination.exists());</span>
<span class="fc" id="L1691">        assertEquals(&quot;Check Full copy&quot;, testFile1Size, destination.length());</span>
        /* disabled: Thread.sleep doesn't work reliantly for this case
        assertTrue(&quot;Check last modified date preserved&quot;,
            testFile1.lastModified() == destination.lastModified());*/

        try {
<span class="nc" id="L1697">            FileUtils.copyFileToDirectory(destination, directory);</span>
<span class="nc" id="L1698">            fail(&quot;Should not be able to copy a file into the same directory as itself&quot;);</span>
<span class="fc" id="L1699">        } catch (final IOException ioe) {</span>
            //we want that, cannot copy to the same directory as the original file
<span class="nc" id="L1701">        }</span>
<span class="fc" id="L1702">    }</span>

    @Test
    public void testCopyFile2ToDir() throws Exception {
<span class="fc" id="L1706">        final File directory = new File(getTestDirectory(), &quot;subdir&quot;);</span>
<span class="pc bpc" id="L1707" title="1 of 2 branches missed.">        if (!directory.exists()) {</span>
<span class="fc" id="L1708">            directory.mkdirs();</span>
        }
<span class="fc" id="L1710">        final File destination = new File(directory, testFile1.getName());</span>

        //Thread.sleep(LAST_MODIFIED_DELAY);
        //This is to slow things down so we can catch if
        //the lastModified date is not ok

<span class="fc" id="L1716">        FileUtils.copyFileToDirectory(testFile1, directory);</span>
<span class="fc" id="L1717">        assertTrue(&quot;Check Exist&quot;, destination.exists());</span>
<span class="fc" id="L1718">        assertEquals(&quot;Check Full copy&quot;, testFile2Size, destination.length());</span>
        /* disabled: Thread.sleep doesn't work reliantly for this case
        assertTrue(&quot;Check last modified date preserved&quot;,
            testFile1.lastModified() == destination.lastModified());*/
<span class="fc" id="L1722">    }</span>

    // forceDelete

    @Test
    public void testForceDeleteDir() throws Exception {
<span class="fc" id="L1728">        final File testDirectory = getTestDirectory();</span>
<span class="fc" id="L1729">        assertTrue(&quot;TestDirectory must exist&quot;, testDirectory.exists());</span>
<span class="fc" id="L1730">        FileUtils.forceDelete(testDirectory);</span>
<span class="fc" id="L1731">        assertFalse(&quot;TestDirectory must not exist&quot;, testDirectory.exists());</span>
<span class="fc" id="L1732">    }</span>

    /*
     *  Test the FileUtils implementation.
     */
    @Test
    public void testFileUtils() throws Exception {
        // Loads file from classpath
<span class="fc" id="L1740">        final File file1 = new File(getTestDirectory(), &quot;test.txt&quot;);</span>
<span class="fc" id="L1741">        final String filename = file1.getAbsolutePath();</span>

        //Create test file on-the-fly (used to be in CVS)
<span class="fc" id="L1744">        try (OutputStream out = new FileOutputStream(file1)) {</span>
<span class="fc" id="L1745">            out.write(&quot;This is a test&quot;.getBytes(&quot;UTF-8&quot;));</span>
        }

<span class="fc" id="L1748">        final File file2 = new File(getTestDirectory(), &quot;test2.txt&quot;);</span>

<span class="fc" id="L1750">        FileUtils.writeStringToFile(file2, filename, &quot;UTF-8&quot;);</span>
<span class="fc" id="L1751">        assertTrue(file2.exists());</span>
<span class="pc bpc" id="L1752" title="1 of 2 branches missed.">        assertTrue(file2.length() &gt; 0);</span>

<span class="fc" id="L1754">        final String file2contents = FileUtils.readFileToString(file2, &quot;UTF-8&quot;);</span>
<span class="fc" id="L1755">        assertTrue(</span>
                &quot;Second file's contents correct&quot;,
<span class="fc" id="L1757">                filename.equals(file2contents));</span>

<span class="fc" id="L1759">        assertTrue(file2.delete());</span>

<span class="fc" id="L1761">        final String contents = FileUtils.readFileToString(new File(filename), &quot;UTF-8&quot;);</span>
<span class="fc" id="L1762">        assertEquals(&quot;FileUtils.fileRead()&quot;, &quot;This is a test&quot;, contents);</span>

<span class="fc" id="L1764">    }</span>

    @Test
    public void testTouch() throws IOException {
<span class="fc" id="L1768">        final File file = new File(getTestDirectory(), &quot;touch.txt&quot;);</span>
<span class="pc bpc" id="L1769" title="1 of 2 branches missed.">        if (file.exists()) {</span>
<span class="nc" id="L1770">            file.delete();</span>
        }
<span class="pc bpc" id="L1772" title="1 of 2 branches missed.">        assertTrue(&quot;Bad test: test file still exists&quot;, !file.exists());</span>
<span class="fc" id="L1773">        FileUtils.touch(file);</span>
<span class="fc" id="L1774">        assertTrue(&quot;FileUtils.touch() created file&quot;, file.exists());</span>
<span class="fc" id="L1775">        final FileOutputStream out = new FileOutputStream(file);</span>
<span class="fc" id="L1776">        assertEquals(&quot;Created empty file.&quot;, 0, file.length());</span>
<span class="fc" id="L1777">        out.write(0);</span>
<span class="fc" id="L1778">        out.close();</span>
<span class="fc" id="L1779">        assertEquals(&quot;Wrote one byte to file&quot;, 1, file.length());</span>
<span class="fc" id="L1780">        final long y2k = new GregorianCalendar(2000, 0, 1).getTime().getTime();</span>
<span class="fc" id="L1781">        final boolean res = file.setLastModified(y2k);  // 0L fails on Win98</span>
<span class="fc" id="L1782">        assertEquals(&quot;Bad test: set lastModified failed&quot;, true, res);</span>
<span class="fc" id="L1783">        assertEquals(&quot;Bad test: set lastModified set incorrect value&quot;, y2k, file.lastModified());</span>
<span class="fc" id="L1784">        final long now = System.currentTimeMillis();</span>
<span class="fc" id="L1785">        FileUtils.touch(file);</span>
<span class="fc" id="L1786">        assertEquals(&quot;FileUtils.touch() didn't empty the file.&quot;, 1, file.length());</span>
<span class="pc bpc" id="L1787" title="1 of 2 branches missed.">        assertEquals(&quot;FileUtils.touch() changed lastModified&quot;, false, y2k == file.lastModified());</span>
<span class="pc bpc" id="L1788" title="1 of 2 branches missed.">        assertEquals(&quot;FileUtils.touch() changed lastModified to more than now-3s&quot;, true, file.lastModified() &gt;= now - 3000);</span>
<span class="pc bpc" id="L1789" title="1 of 2 branches missed.">        assertEquals(&quot;FileUtils.touch() changed lastModified to less than now+3s&quot;, true, file.lastModified() &lt;= now + 3000);</span>
<span class="fc" id="L1790">    }</span>

    @Test
    public void testListFiles() throws Exception {
<span class="fc" id="L1794">        final File srcDir = getTestDirectory();</span>
<span class="fc" id="L1795">        final File subDir = new File(srcDir, &quot;list_test&quot;);</span>
<span class="fc" id="L1796">        subDir.mkdir();</span>

<span class="fc" id="L1798">        final File subDir2 = new File(subDir, &quot;subdir&quot;);</span>
<span class="fc" id="L1799">        subDir2.mkdir();</span>

<span class="fc" id="L1801">        final String[] fileNames = {&quot;a.txt&quot;, &quot;b.txt&quot;, &quot;c.txt&quot;, &quot;d.txt&quot;, &quot;e.txt&quot;, &quot;f.txt&quot;};</span>
<span class="fc" id="L1802">        final int[] fileSizes = {123, 234, 345, 456, 678, 789};</span>

<span class="fc bfc" id="L1804" title="All 2 branches covered.">        for (int i = 0; i &lt; fileNames.length; ++i) {</span>
<span class="fc" id="L1805">            final File theFile = new File(subDir, fileNames[i]);</span>
<span class="pc bpc" id="L1806" title="1 of 2 branches missed.">            if (!theFile.getParentFile().exists()) {</span>
<span class="nc" id="L1807">                throw new IOException(&quot;Cannot create file &quot; + theFile</span>
                        + &quot; as the parent directory does not exist&quot;);
            }
<span class="fc" id="L1810">            final BufferedOutputStream output =</span>
                    new BufferedOutputStream(new FileOutputStream(theFile));
            try {
<span class="fc" id="L1813">                TestUtils.generateTestData(output, fileSizes[i]);</span>
            } finally {
<span class="fc" id="L1815">                IOUtils.closeQuietly(output);</span>
            }
        }

<span class="fc" id="L1819">        final Collection&lt;File&gt; files = FileUtils.listFiles(subDir,</span>
                new WildcardFileFilter(&quot;*.*&quot;),
                new WildcardFileFilter(&quot;*&quot;));

<span class="fc" id="L1823">        final int count = files.size();</span>
<span class="fc" id="L1824">        final Object[] fileObjs = files.toArray();</span>

<span class="fc" id="L1826">        assertEquals(fileNames.length, files.size());</span>

<span class="fc" id="L1828">        final Map&lt;String, String&gt; foundFileNames = new HashMap&lt;&gt;();</span>

<span class="fc bfc" id="L1830" title="All 2 branches covered.">        for (int i = 0; i &lt; count; ++i) {</span>
<span class="fc" id="L1831">            boolean found = false;</span>
<span class="pc bpc" id="L1832" title="1 of 4 branches missed.">            for (int j = 0; !found &amp;&amp; j &lt; fileNames.length; ++j) {</span>
<span class="fc bfc" id="L1833" title="All 2 branches covered.">                if (fileNames[j].equals(((File) fileObjs[i]).getName())) {</span>
<span class="fc" id="L1834">                    foundFileNames.put(fileNames[j], fileNames[j]);</span>
<span class="fc" id="L1835">                    found = true;</span>
                }
            }
        }

<span class="fc" id="L1840">        assertEquals(foundFileNames.size(), fileNames.length);</span>

<span class="fc" id="L1842">        subDir.delete();</span>
<span class="fc" id="L1843">    }</span>

    @Test
    public void testListFilesWithDirs() throws IOException {
<span class="fc" id="L1847">        final File srcDir = getTestDirectory();</span>

<span class="fc" id="L1849">        final File subDir1 = new File(srcDir, &quot;subdir&quot;);</span>
<span class="fc" id="L1850">        subDir1.mkdir();</span>

<span class="fc" id="L1852">        final File subDir2 = new File(subDir1, &quot;subdir2&quot;);</span>
<span class="fc" id="L1853">        subDir2.mkdir();</span>

<span class="fc" id="L1855">        final File someFile = new File(subDir2, &quot;a.txt&quot;);</span>
<span class="pc bpc" id="L1856" title="1 of 2 branches missed.">        if (!someFile.getParentFile().exists()) {</span>
<span class="nc" id="L1857">            throw new IOException(&quot;Cannot create file &quot; + someFile</span>
                    + &quot; as the parent directory does not exist&quot;);
        }
<span class="fc" id="L1860">        final BufferedOutputStream output =</span>
                new BufferedOutputStream(new FileOutputStream(someFile));
        try {
<span class="fc" id="L1863">            TestUtils.generateTestData(output, 100);</span>
        } finally {
<span class="fc" id="L1865">            IOUtils.closeQuietly(output);</span>
        }

<span class="fc" id="L1868">        final File subDir3 = new File(subDir2, &quot;subdir3&quot;);</span>
<span class="fc" id="L1869">        subDir3.mkdir();</span>

<span class="fc" id="L1871">        final Collection&lt;File&gt; files = FileUtils.listFilesAndDirs(subDir1,</span>
                new WildcardFileFilter(&quot;*.*&quot;), new WildcardFileFilter(&quot;*&quot;));

<span class="fc" id="L1874">        assertEquals(4, files.size());</span>
<span class="fc" id="L1875">        assertTrue(&quot;Should contain the directory.&quot;, files.contains(subDir1));</span>
<span class="fc" id="L1876">        assertTrue(&quot;Should contain the directory.&quot;, files.contains(subDir2));</span>
<span class="fc" id="L1877">        assertTrue(&quot;Should contain the file.&quot;, files.contains(someFile));</span>
<span class="fc" id="L1878">        assertTrue(&quot;Should contain the directory.&quot;, files.contains(subDir3));</span>

<span class="fc" id="L1880">        subDir1.delete();</span>
<span class="fc" id="L1881">    }</span>

    @Test
    public void testIterateFiles() throws Exception {
<span class="fc" id="L1885">        final File srcDir = getTestDirectory();</span>
<span class="fc" id="L1886">        final File subDir = new File(srcDir, &quot;list_test&quot;);</span>
<span class="fc" id="L1887">        subDir.mkdir();</span>

<span class="fc" id="L1889">        final String[] fileNames = {&quot;a.txt&quot;, &quot;b.txt&quot;, &quot;c.txt&quot;, &quot;d.txt&quot;, &quot;e.txt&quot;, &quot;f.txt&quot;};</span>
<span class="fc" id="L1890">        final int[] fileSizes = {123, 234, 345, 456, 678, 789};</span>

<span class="fc bfc" id="L1892" title="All 2 branches covered.">        for (int i = 0; i &lt; fileNames.length; ++i) {</span>
<span class="fc" id="L1893">            final File theFile = new File(subDir, fileNames[i]);</span>
<span class="pc bpc" id="L1894" title="1 of 2 branches missed.">            if (!theFile.getParentFile().exists()) {</span>
<span class="nc" id="L1895">                throw new IOException(&quot;Cannot create file &quot; + theFile</span>
                        + &quot; as the parent directory does not exist&quot;);
            }
<span class="fc" id="L1898">            final BufferedOutputStream output =</span>
                    new BufferedOutputStream(new FileOutputStream(theFile));
            try {
<span class="fc" id="L1901">                TestUtils.generateTestData(output, fileSizes[i]);</span>
            } finally {
<span class="fc" id="L1903">                IOUtils.closeQuietly(output);</span>
            }
        }

<span class="fc" id="L1907">        final Iterator&lt;File&gt; files = FileUtils.iterateFiles(subDir,</span>
                new WildcardFileFilter(&quot;*.*&quot;),
                new WildcardFileFilter(&quot;*&quot;));

<span class="fc" id="L1911">        final Map&lt;String, String&gt; foundFileNames = new HashMap&lt;&gt;();</span>

<span class="fc bfc" id="L1913" title="All 2 branches covered.">        while (files.hasNext()) {</span>
<span class="fc" id="L1914">            boolean found = false;</span>
<span class="fc" id="L1915">            final String fileName = files.next().getName();</span>

<span class="pc bpc" id="L1917" title="1 of 4 branches missed.">            for (int j = 0; !found &amp;&amp; j &lt; fileNames.length; ++j) {</span>
<span class="fc bfc" id="L1918" title="All 2 branches covered.">                if (fileNames[j].equals(fileName)) {</span>
<span class="fc" id="L1919">                    foundFileNames.put(fileNames[j], fileNames[j]);</span>
<span class="fc" id="L1920">                    found = true;</span>
                }
            }
<span class="fc" id="L1923">        }</span>

<span class="fc" id="L1925">        assertEquals(foundFileNames.size(), fileNames.length);</span>

<span class="fc" id="L1927">        subDir.delete();</span>
<span class="fc" id="L1928">    }</span>

    @Test
    public void testIterateFilesAndDirs() throws IOException {
<span class="fc" id="L1932">        final File srcDir = getTestDirectory();</span>

<span class="fc" id="L1934">        final File subDir1 = new File(srcDir, &quot;subdir&quot;);</span>
<span class="fc" id="L1935">        subDir1.mkdir();</span>

<span class="fc" id="L1937">        final File subDir2 = new File(subDir1, &quot;subdir2&quot;);</span>
<span class="fc" id="L1938">        subDir2.mkdir();</span>

<span class="fc" id="L1940">        final File someFile = new File(subDir2, &quot;a.txt&quot;);</span>
<span class="pc bpc" id="L1941" title="1 of 2 branches missed.">        if (!someFile.getParentFile().exists()) {</span>
<span class="nc" id="L1942">            throw new IOException(&quot;Cannot create file &quot; + someFile</span>
                    + &quot; as the parent directory does not exist&quot;);
        }
<span class="fc" id="L1945">        final BufferedOutputStream output =</span>
                new BufferedOutputStream(new FileOutputStream(someFile));
        try {
<span class="fc" id="L1948">            TestUtils.generateTestData(output, 100);</span>
        } finally {
<span class="fc" id="L1950">            IOUtils.closeQuietly(output);</span>
        }

<span class="fc" id="L1953">        final File subDir3 = new File(subDir2, &quot;subdir3&quot;);</span>
<span class="fc" id="L1954">        subDir3.mkdir();</span>

<span class="fc" id="L1956">        final Collection&lt;File&gt; filesAndDirs = Arrays.asList(subDir1, subDir2, someFile, subDir3);</span>

<span class="fc" id="L1958">        int filesCount = 0;</span>
<span class="fc" id="L1959">        final Iterator&lt;File&gt; files = FileUtils.iterateFilesAndDirs(subDir1,</span>
                new WildcardFileFilter(&quot;*.*&quot;),
                new WildcardFileFilter(&quot;*&quot;));
<span class="fc bfc" id="L1962" title="All 2 branches covered.">        while (files.hasNext()) {</span>
<span class="fc" id="L1963">            filesCount++;</span>
<span class="fc" id="L1964">            final File file = files.next();</span>
<span class="fc" id="L1965">            assertTrue(&quot;Should contain the directory/file&quot;, filesAndDirs.contains(file));</span>
<span class="fc" id="L1966">        }</span>

<span class="fc" id="L1968">        assertEquals(filesCount, filesAndDirs.size());</span>
<span class="fc" id="L1969">    }</span>

    @Test
    public void testReadFileToStringWithDefaultEncoding() throws Exception {
<span class="fc" id="L1973">        final File file = new File(getTestDirectory(), &quot;read.obj&quot;);</span>
<span class="fc" id="L1974">        final FileOutputStream out = new FileOutputStream(file);</span>
<span class="fc" id="L1975">        final byte[] text = &quot;Hello /u1234&quot;.getBytes();</span>
<span class="fc" id="L1976">        out.write(text);</span>
<span class="fc" id="L1977">        out.close();</span>

<span class="fc" id="L1979">        final String data = FileUtils.readFileToString(file);</span>
<span class="fc" id="L1980">        assertEquals(&quot;Hello /u1234&quot;, data);</span>
<span class="fc" id="L1981">    }</span>

    @Test
    public void testReadFileToStringWithEncoding() throws Exception {
<span class="fc" id="L1985">        final File file = new File(getTestDirectory(), &quot;read.obj&quot;);</span>
<span class="fc" id="L1986">        final FileOutputStream out = new FileOutputStream(file);</span>
<span class="fc" id="L1987">        final byte[] text = &quot;Hello /u1234&quot;.getBytes(&quot;UTF8&quot;);</span>
<span class="fc" id="L1988">        out.write(text);</span>
<span class="fc" id="L1989">        out.close();</span>

<span class="fc" id="L1991">        final String data = FileUtils.readFileToString(file, &quot;UTF8&quot;);</span>
<span class="fc" id="L1992">        assertEquals(&quot;Hello /u1234&quot;, data);</span>
<span class="fc" id="L1993">    }</span>

    @Test
    public void testReadFileToByteArray() throws Exception {
<span class="fc" id="L1997">        final File file = new File(getTestDirectory(), &quot;read.txt&quot;);</span>
<span class="fc" id="L1998">        final FileOutputStream out = new FileOutputStream(file);</span>
<span class="fc" id="L1999">        out.write(11);</span>
<span class="fc" id="L2000">        out.write(21);</span>
<span class="fc" id="L2001">        out.write(31);</span>
<span class="fc" id="L2002">        out.close();</span>

<span class="fc" id="L2004">        final byte[] data = FileUtils.readFileToByteArray(file);</span>
<span class="fc" id="L2005">        assertEquals(3, data.length);</span>
<span class="fc" id="L2006">        assertEquals(11, data[0]);</span>
<span class="fc" id="L2007">        assertEquals(21, data[1]);</span>
<span class="fc" id="L2008">        assertEquals(31, data[2]);</span>
<span class="fc" id="L2009">    }</span>

    @Test
    public void testReadLines() throws Exception {
<span class="fc" id="L2013">        final File file = TestUtils.newFile(getTestDirectory(), &quot;lines.txt&quot;);</span>
        try {
<span class="fc" id="L2015">            final String[] data = new String[]{&quot;hello&quot;, &quot;/u1234&quot;, &quot;&quot;, &quot;this is&quot;, &quot;some text&quot;};</span>
<span class="fc" id="L2016">            TestUtils.createLineBasedFile(file, data);</span>

<span class="fc" id="L2018">            final List&lt;String&gt; lines = FileUtils.readLines(file, &quot;UTF-8&quot;);</span>
<span class="fc" id="L2019">            assertEquals(Arrays.asList(data), lines);</span>
        } finally {
<span class="fc" id="L2021">            TestUtils.deleteFile(file);</span>
        }
<span class="fc" id="L2023">    }</span>

    @Test
    public void testWriteStringToFile1() throws Exception {
<span class="fc" id="L2027">        final File file = new File(getTestDirectory(), &quot;write.txt&quot;);</span>
<span class="fc" id="L2028">        FileUtils.writeStringToFile(file, &quot;Hello /u1234&quot;, &quot;UTF8&quot;);</span>
<span class="fc" id="L2029">        final byte[] text = &quot;Hello /u1234&quot;.getBytes(&quot;UTF8&quot;);</span>
<span class="fc" id="L2030">        TestUtils.assertEqualContent(text, file);</span>
<span class="fc" id="L2031">    }</span>

    @Test
    public void testWriteStringToFile2() throws Exception {
<span class="fc" id="L2035">        final File file = new File(getTestDirectory(), &quot;write.txt&quot;);</span>
<span class="fc" id="L2036">        FileUtils.writeStringToFile(file, &quot;Hello /u1234&quot;, (String) null);</span>
<span class="fc" id="L2037">        final byte[] text = &quot;Hello /u1234&quot;.getBytes();</span>
<span class="fc" id="L2038">        TestUtils.assertEqualContent(text, file);</span>
<span class="fc" id="L2039">    }</span>

    @Test
    public void testWriteStringToFile3() throws Exception {
<span class="fc" id="L2043">        final File file = new File(getTestDirectory(), &quot;write.txt&quot;);</span>
<span class="fc" id="L2044">        FileUtils.writeStringToFile(file, &quot;Hello /u1234&quot;, (Charset) null);</span>
<span class="fc" id="L2045">        final byte[] text = &quot;Hello /u1234&quot;.getBytes();</span>
<span class="fc" id="L2046">        TestUtils.assertEqualContent(text, file);</span>
<span class="fc" id="L2047">    }</span>

    @Test
    public void testWriteCharSequence1() throws Exception {
<span class="fc" id="L2051">        final File file = new File(getTestDirectory(), &quot;write.txt&quot;);</span>
<span class="fc" id="L2052">        FileUtils.write(file, &quot;Hello /u1234&quot;, &quot;UTF8&quot;);</span>
<span class="fc" id="L2053">        final byte[] text = &quot;Hello /u1234&quot;.getBytes(&quot;UTF8&quot;);</span>
<span class="fc" id="L2054">        TestUtils.assertEqualContent(text, file);</span>
<span class="fc" id="L2055">    }</span>

    @Test
    public void testWriteCharSequence2() throws Exception {
<span class="fc" id="L2059">        final File file = new File(getTestDirectory(), &quot;write.txt&quot;);</span>
<span class="fc" id="L2060">        FileUtils.write(file, &quot;Hello /u1234&quot;, (String) null);</span>
<span class="fc" id="L2061">        final byte[] text = &quot;Hello /u1234&quot;.getBytes();</span>
<span class="fc" id="L2062">        TestUtils.assertEqualContent(text, file);</span>
<span class="fc" id="L2063">    }</span>

    @Test
    public void testWriteByteArrayToFile() throws Exception {
<span class="fc" id="L2067">        final File file = new File(getTestDirectory(), &quot;write.obj&quot;);</span>
<span class="fc" id="L2068">        final byte[] data = new byte[]{11, 21, 31};</span>
<span class="fc" id="L2069">        FileUtils.writeByteArrayToFile(file, data);</span>
<span class="fc" id="L2070">        TestUtils.assertEqualContent(data, file);</span>
<span class="fc" id="L2071">    }</span>

    @Test
    public void testWriteByteArrayToFile_WithOffsetAndLength() throws Exception {
<span class="fc" id="L2075">        final File file = new File(getTestDirectory(), &quot;write.obj&quot;);</span>
<span class="fc" id="L2076">        final byte[] data = new byte[]{11, 21, 32, 41, 51};</span>
<span class="fc" id="L2077">        final byte[] writtenData = new byte[3];</span>
<span class="fc" id="L2078">        System.arraycopy(data, 1, writtenData, 0, 3);</span>
<span class="fc" id="L2079">        FileUtils.writeByteArrayToFile(file, data, 1, 3);</span>
<span class="fc" id="L2080">        TestUtils.assertEqualContent(writtenData, file);</span>
<span class="fc" id="L2081">    }</span>

    @Test
    public void testWriteLines_4arg() throws Exception {
<span class="fc" id="L2085">        final Object[] data = new Object[]{</span>
                &quot;hello&quot;, new StringBuffer(&quot;world&quot;), &quot;&quot;, &quot;this is&quot;, null, &quot;some text&quot;};
<span class="fc" id="L2087">        final List&lt;Object&gt; list = Arrays.asList(data);</span>

<span class="fc" id="L2089">        final File file = TestUtils.newFile(getTestDirectory(), &quot;lines.txt&quot;);</span>
<span class="fc" id="L2090">        FileUtils.writeLines(file, &quot;US-ASCII&quot;, list, &quot;*&quot;);</span>

<span class="fc" id="L2092">        final String expected = &quot;hello*world**this is**some text*&quot;;</span>
<span class="fc" id="L2093">        final String actual = FileUtils.readFileToString(file, &quot;US-ASCII&quot;);</span>
<span class="fc" id="L2094">        assertEquals(expected, actual);</span>
<span class="fc" id="L2095">    }</span>

    @Test
    public void testWriteLines_4arg_Writer_nullData() throws Exception {
<span class="fc" id="L2099">        final File file = TestUtils.newFile(getTestDirectory(), &quot;lines.txt&quot;);</span>
<span class="fc" id="L2100">        FileUtils.writeLines(file, &quot;US-ASCII&quot;, null, &quot;*&quot;);</span>

<span class="fc" id="L2102">        assertEquals(&quot;Sizes differ&quot;, 0, file.length());</span>
<span class="fc" id="L2103">    }</span>

    @Test
    public void testWriteLines_4arg_nullSeparator() throws Exception {
<span class="fc" id="L2107">        final Object[] data = new Object[]{</span>
                &quot;hello&quot;, new StringBuffer(&quot;world&quot;), &quot;&quot;, &quot;this is&quot;, null, &quot;some text&quot;};
<span class="fc" id="L2109">        final List&lt;Object&gt; list = Arrays.asList(data);</span>

<span class="fc" id="L2111">        final File file = TestUtils.newFile(getTestDirectory(), &quot;lines.txt&quot;);</span>
<span class="fc" id="L2112">        FileUtils.writeLines(file, &quot;US-ASCII&quot;, list, null);</span>

<span class="fc" id="L2114">        final String expected = &quot;hello&quot; + IOUtils.LINE_SEPARATOR + &quot;world&quot; + IOUtils.LINE_SEPARATOR +</span>
                IOUtils.LINE_SEPARATOR + &quot;this is&quot; + IOUtils.LINE_SEPARATOR +
                IOUtils.LINE_SEPARATOR + &quot;some text&quot; + IOUtils.LINE_SEPARATOR;
<span class="fc" id="L2117">        final String actual = FileUtils.readFileToString(file, &quot;US-ASCII&quot;);</span>
<span class="fc" id="L2118">        assertEquals(expected, actual);</span>
<span class="fc" id="L2119">    }</span>

    @Test
    public void testWriteLines_3arg_nullSeparator() throws Exception {
<span class="fc" id="L2123">        final Object[] data = new Object[]{</span>
                &quot;hello&quot;, new StringBuffer(&quot;world&quot;), &quot;&quot;, &quot;this is&quot;, null, &quot;some text&quot;};
<span class="fc" id="L2125">        final List&lt;Object&gt; list = Arrays.asList(data);</span>

<span class="fc" id="L2127">        final File file = TestUtils.newFile(getTestDirectory(), &quot;lines.txt&quot;);</span>
<span class="fc" id="L2128">        FileUtils.writeLines(file, &quot;US-ASCII&quot;, list);</span>

<span class="fc" id="L2130">        final String expected = &quot;hello&quot; + IOUtils.LINE_SEPARATOR + &quot;world&quot; + IOUtils.LINE_SEPARATOR +</span>
                IOUtils.LINE_SEPARATOR + &quot;this is&quot; + IOUtils.LINE_SEPARATOR +
                IOUtils.LINE_SEPARATOR + &quot;some text&quot; + IOUtils.LINE_SEPARATOR;
<span class="fc" id="L2133">        final String actual = FileUtils.readFileToString(file, &quot;US-ASCII&quot;);</span>
<span class="fc" id="L2134">        assertEquals(expected, actual);</span>
<span class="fc" id="L2135">    }</span>

    @Test
    public void testWriteLines_5argsWithAppendOptionTrue_ShouldNotDeletePreviousFileLines() throws Exception {
<span class="fc" id="L2139">        final File file = TestUtils.newFile(getTestDirectory(), &quot;lines.txt&quot;);</span>
<span class="fc" id="L2140">        FileUtils.writeStringToFile(file, &quot;This line was there before you...&quot;);</span>

<span class="fc" id="L2142">        final List&lt;String&gt; linesToAppend = Arrays.asList(&quot;my first line&quot;, &quot;The second Line&quot;);</span>
<span class="fc" id="L2143">        FileUtils.writeLines(file, null, linesToAppend, null, true);</span>

<span class="fc" id="L2145">        final String expected = &quot;This line was there before you...&quot;</span>
                + &quot;my first line&quot;
                + IOUtils.LINE_SEPARATOR + &quot;The second Line&quot;
                + IOUtils.LINE_SEPARATOR;
<span class="fc" id="L2149">        final String actual = FileUtils.readFileToString(file);</span>
<span class="fc" id="L2150">        assertEquals(expected, actual);</span>
<span class="fc" id="L2151">    }</span>

    @Test
    public void testWriteLines_5argsWithAppendOptionFalse_ShouldDeletePreviousFileLines() throws Exception {
<span class="fc" id="L2155">        final File file = TestUtils.newFile(getTestDirectory(), &quot;lines.txt&quot;);</span>
<span class="fc" id="L2156">        FileUtils.writeStringToFile(file, &quot;This line was there before you...&quot;);</span>

<span class="fc" id="L2158">        final List&lt;String&gt; linesToAppend = Arrays.asList(&quot;my first line&quot;, &quot;The second Line&quot;);</span>
<span class="fc" id="L2159">        FileUtils.writeLines(file, null, linesToAppend, null, false);</span>

<span class="fc" id="L2161">        final String expected = &quot;my first line&quot;</span>
                + IOUtils.LINE_SEPARATOR + &quot;The second Line&quot;
                + IOUtils.LINE_SEPARATOR;
<span class="fc" id="L2164">        final String actual = FileUtils.readFileToString(file);</span>
<span class="fc" id="L2165">        assertEquals(expected, actual);</span>
<span class="fc" id="L2166">    }</span>

    @Test
    public void testWriteLines_4argsWithAppendOptionTrue_ShouldNotDeletePreviousFileLines() throws Exception {
<span class="fc" id="L2170">        final File file = TestUtils.newFile(getTestDirectory(), &quot;lines.txt&quot;);</span>
<span class="fc" id="L2171">        FileUtils.writeStringToFile(file, &quot;This line was there before you...&quot;);</span>

<span class="fc" id="L2173">        final List&lt;String&gt; linesToAppend = Arrays.asList(&quot;my first line&quot;, &quot;The second Line&quot;);</span>
<span class="fc" id="L2174">        FileUtils.writeLines(file, linesToAppend, null, true);</span>

<span class="fc" id="L2176">        final String expected = &quot;This line was there before you...&quot;</span>
                + &quot;my first line&quot;
                + IOUtils.LINE_SEPARATOR + &quot;The second Line&quot;
                + IOUtils.LINE_SEPARATOR;
<span class="fc" id="L2180">        final String actual = FileUtils.readFileToString(file);</span>
<span class="fc" id="L2181">        assertEquals(expected, actual);</span>
<span class="fc" id="L2182">    }</span>

    @Test
    public void testWriteLines_4argsWithAppendOptionFalse_ShouldDeletePreviousFileLines() throws Exception {
<span class="fc" id="L2186">        final File file = TestUtils.newFile(getTestDirectory(), &quot;lines.txt&quot;);</span>
<span class="fc" id="L2187">        FileUtils.writeStringToFile(file, &quot;This line was there before you...&quot;);</span>

<span class="fc" id="L2189">        final List&lt;String&gt; linesToAppend = Arrays.asList(&quot;my first line&quot;, &quot;The second Line&quot;);</span>
<span class="fc" id="L2190">        FileUtils.writeLines(file, linesToAppend, null, false);</span>

<span class="fc" id="L2192">        final String expected = &quot;my first line&quot;</span>
                + IOUtils.LINE_SEPARATOR + &quot;The second Line&quot;
                + IOUtils.LINE_SEPARATOR;
<span class="fc" id="L2195">        final String actual = FileUtils.readFileToString(file);</span>
<span class="fc" id="L2196">        assertEquals(expected, actual);</span>
<span class="fc" id="L2197">    }</span>


    @Test
    public void testWriteLinesEncoding_WithAppendOptionTrue_ShouldNotDeletePreviousFileLines() throws Exception {
<span class="fc" id="L2202">        final File file = TestUtils.newFile(getTestDirectory(), &quot;lines.txt&quot;);</span>
<span class="fc" id="L2203">        FileUtils.writeStringToFile(file, &quot;This line was there before you...&quot;);</span>

<span class="fc" id="L2205">        final List&lt;String&gt; linesToAppend = Arrays.asList(&quot;my first line&quot;, &quot;The second Line&quot;);</span>
<span class="fc" id="L2206">        FileUtils.writeLines(file, null, linesToAppend, true);</span>

<span class="fc" id="L2208">        final String expected = &quot;This line was there before you...&quot;</span>
                + &quot;my first line&quot;
                + IOUtils.LINE_SEPARATOR + &quot;The second Line&quot;
                + IOUtils.LINE_SEPARATOR;
<span class="fc" id="L2212">        final String actual = FileUtils.readFileToString(file);</span>
<span class="fc" id="L2213">        assertEquals(expected, actual);</span>
<span class="fc" id="L2214">    }</span>

    @Test
    public void testWriteLinesEncoding_WithAppendOptionFalse_ShouldDeletePreviousFileLines() throws Exception {
<span class="fc" id="L2218">        final File file = TestUtils.newFile(getTestDirectory(), &quot;lines.txt&quot;);</span>
<span class="fc" id="L2219">        FileUtils.writeStringToFile(file, &quot;This line was there before you...&quot;);</span>

<span class="fc" id="L2221">        final List&lt;String&gt; linesToAppend = Arrays.asList(&quot;my first line&quot;, &quot;The second Line&quot;);</span>
<span class="fc" id="L2222">        FileUtils.writeLines(file, null, linesToAppend, false);</span>

<span class="fc" id="L2224">        final String expected = &quot;my first line&quot;</span>
                + IOUtils.LINE_SEPARATOR + &quot;The second Line&quot;
                + IOUtils.LINE_SEPARATOR;
<span class="fc" id="L2227">        final String actual = FileUtils.readFileToString(file);</span>
<span class="fc" id="L2228">        assertEquals(expected, actual);</span>
<span class="fc" id="L2229">    }</span>

    @Test
    public void testWriteLines_3argsWithAppendOptionTrue_ShouldNotDeletePreviousFileLines() throws Exception {
<span class="fc" id="L2233">        final File file = TestUtils.newFile(getTestDirectory(), &quot;lines.txt&quot;);</span>
<span class="fc" id="L2234">        FileUtils.writeStringToFile(file, &quot;This line was there before you...&quot;);</span>

<span class="fc" id="L2236">        final List&lt;String&gt; linesToAppend = Arrays.asList(&quot;my first line&quot;, &quot;The second Line&quot;);</span>
<span class="fc" id="L2237">        FileUtils.writeLines(file, linesToAppend, true);</span>

<span class="fc" id="L2239">        final String expected = &quot;This line was there before you...&quot;</span>
                + &quot;my first line&quot;
                + IOUtils.LINE_SEPARATOR + &quot;The second Line&quot;
                + IOUtils.LINE_SEPARATOR;
<span class="fc" id="L2243">        final String actual = FileUtils.readFileToString(file);</span>
<span class="fc" id="L2244">        assertEquals(expected, actual);</span>
<span class="fc" id="L2245">    }</span>

    @Test
    public void testWriteLines_3argsWithAppendOptionFalse_ShouldDeletePreviousFileLines() throws Exception {
<span class="fc" id="L2249">        final File file = TestUtils.newFile(getTestDirectory(), &quot;lines.txt&quot;);</span>
<span class="fc" id="L2250">        FileUtils.writeStringToFile(file, &quot;This line was there before you...&quot;);</span>

<span class="fc" id="L2252">        final List&lt;String&gt; linesToAppend = Arrays.asList(&quot;my first line&quot;, &quot;The second Line&quot;);</span>
<span class="fc" id="L2253">        FileUtils.writeLines(file, linesToAppend, false);</span>

<span class="fc" id="L2255">        final String expected = &quot;my first line&quot;</span>
                + IOUtils.LINE_SEPARATOR + &quot;The second Line&quot;
                + IOUtils.LINE_SEPARATOR;
<span class="fc" id="L2258">        final String actual = FileUtils.readFileToString(file);</span>
<span class="fc" id="L2259">        assertEquals(expected, actual);</span>
<span class="fc" id="L2260">    }</span>

    @Test
    public void testWriteStringToFileWithEncoding_WithAppendOptionTrue_ShouldNotDeletePreviousFileLines() throws Exception {
<span class="fc" id="L2264">        final File file = TestUtils.newFile(getTestDirectory(), &quot;lines.txt&quot;);</span>
<span class="fc" id="L2265">        FileUtils.writeStringToFile(file, &quot;This line was there before you...&quot;);</span>

<span class="fc" id="L2267">        FileUtils.writeStringToFile(file, &quot;this is brand new data&quot;, (String) null, true);</span>

<span class="fc" id="L2269">        final String expected = &quot;This line was there before you...&quot;</span>
                + &quot;this is brand new data&quot;;
<span class="fc" id="L2271">        final String actual = FileUtils.readFileToString(file);</span>
<span class="fc" id="L2272">        assertEquals(expected, actual);</span>
<span class="fc" id="L2273">    }</span>

    @Test
    public void testWriteStringToFileWithEncoding_WithAppendOptionFalse_ShouldDeletePreviousFileLines() throws Exception {
<span class="fc" id="L2277">        final File file = TestUtils.newFile(getTestDirectory(), &quot;lines.txt&quot;);</span>
<span class="fc" id="L2278">        FileUtils.writeStringToFile(file, &quot;This line was there before you...&quot;);</span>

<span class="fc" id="L2280">        FileUtils.writeStringToFile(file, &quot;this is brand new data&quot;, (String) null, false);</span>

<span class="fc" id="L2282">        final String expected = &quot;this is brand new data&quot;;</span>
<span class="fc" id="L2283">        final String actual = FileUtils.readFileToString(file);</span>
<span class="fc" id="L2284">        assertEquals(expected, actual);</span>
<span class="fc" id="L2285">    }</span>

    @Test
    public void testWriteStringToFile_WithAppendOptionTrue_ShouldNotDeletePreviousFileLines() throws Exception {
<span class="fc" id="L2289">        final File file = TestUtils.newFile(getTestDirectory(), &quot;lines.txt&quot;);</span>
<span class="fc" id="L2290">        FileUtils.writeStringToFile(file, &quot;This line was there before you...&quot;);</span>

<span class="fc" id="L2292">        FileUtils.writeStringToFile(file, &quot;this is brand new data&quot;, true);</span>

<span class="fc" id="L2294">        final String expected = &quot;This line was there before you...&quot;</span>
                + &quot;this is brand new data&quot;;
<span class="fc" id="L2296">        final String actual = FileUtils.readFileToString(file);</span>
<span class="fc" id="L2297">        assertEquals(expected, actual);</span>
<span class="fc" id="L2298">    }</span>

    @Test
    public void testWriteStringToFile_WithAppendOptionFalse_ShouldDeletePreviousFileLines() throws Exception {
<span class="fc" id="L2302">        final File file = TestUtils.newFile(getTestDirectory(), &quot;lines.txt&quot;);</span>
<span class="fc" id="L2303">        FileUtils.writeStringToFile(file, &quot;This line was there before you...&quot;);</span>

<span class="fc" id="L2305">        FileUtils.writeStringToFile(file, &quot;this is brand new data&quot;, false);</span>

<span class="fc" id="L2307">        final String expected = &quot;this is brand new data&quot;;</span>
<span class="fc" id="L2308">        final String actual = FileUtils.readFileToString(file);</span>
<span class="fc" id="L2309">        assertEquals(expected, actual);</span>
<span class="fc" id="L2310">    }</span>

    @Test
    public void testWriteWithEncoding_WithAppendOptionTrue_ShouldNotDeletePreviousFileLines() throws Exception {
<span class="fc" id="L2314">        final File file = TestUtils.newFile(getTestDirectory(), &quot;lines.txt&quot;);</span>
<span class="fc" id="L2315">        FileUtils.writeStringToFile(file, &quot;This line was there before you...&quot;);</span>

<span class="fc" id="L2317">        FileUtils.write(file, &quot;this is brand new data&quot;, (String) null, true);</span>

<span class="fc" id="L2319">        final String expected = &quot;This line was there before you...&quot;</span>
                + &quot;this is brand new data&quot;;
<span class="fc" id="L2321">        final String actual = FileUtils.readFileToString(file);</span>
<span class="fc" id="L2322">        assertEquals(expected, actual);</span>
<span class="fc" id="L2323">    }</span>

    @Test
    public void testWriteWithEncoding_WithAppendOptionFalse_ShouldDeletePreviousFileLines() throws Exception {
<span class="fc" id="L2327">        final File file = TestUtils.newFile(getTestDirectory(), &quot;lines.txt&quot;);</span>
<span class="fc" id="L2328">        FileUtils.writeStringToFile(file, &quot;This line was there before you...&quot;);</span>

<span class="fc" id="L2330">        FileUtils.write(file, &quot;this is brand new data&quot;, (String) null, false);</span>

<span class="fc" id="L2332">        final String expected = &quot;this is brand new data&quot;;</span>
<span class="fc" id="L2333">        final String actual = FileUtils.readFileToString(file);</span>
<span class="fc" id="L2334">        assertEquals(expected, actual);</span>
<span class="fc" id="L2335">    }</span>

    @Test
    public void testWrite_WithAppendOptionTrue_ShouldNotDeletePreviousFileLines() throws Exception {
<span class="fc" id="L2339">        final File file = TestUtils.newFile(getTestDirectory(), &quot;lines.txt&quot;);</span>
<span class="fc" id="L2340">        FileUtils.writeStringToFile(file, &quot;This line was there before you...&quot;);</span>

<span class="fc" id="L2342">        FileUtils.write(file, &quot;this is brand new data&quot;, true);</span>

<span class="fc" id="L2344">        final String expected = &quot;This line was there before you...&quot;</span>
                + &quot;this is brand new data&quot;;
<span class="fc" id="L2346">        final String actual = FileUtils.readFileToString(file);</span>
<span class="fc" id="L2347">        assertEquals(expected, actual);</span>
<span class="fc" id="L2348">    }</span>

    @Test
    public void testWrite_WithAppendOptionFalse_ShouldDeletePreviousFileLines() throws Exception {
<span class="fc" id="L2352">        final File file = TestUtils.newFile(getTestDirectory(), &quot;lines.txt&quot;);</span>
<span class="fc" id="L2353">        FileUtils.writeStringToFile(file, &quot;This line was there before you...&quot;);</span>

<span class="fc" id="L2355">        FileUtils.write(file, &quot;this is brand new data&quot;, false);</span>

<span class="fc" id="L2357">        final String expected = &quot;this is brand new data&quot;;</span>
<span class="fc" id="L2358">        final String actual = FileUtils.readFileToString(file);</span>
<span class="fc" id="L2359">        assertEquals(expected, actual);</span>
<span class="fc" id="L2360">    }</span>

    @Test
    public void testWriteByteArrayToFile_WithAppendOptionTrue_ShouldNotDeletePreviousFileLines() throws Exception {
<span class="fc" id="L2364">        final File file = TestUtils.newFile(getTestDirectory(), &quot;lines.txt&quot;);</span>
<span class="fc" id="L2365">        FileUtils.writeStringToFile(file, &quot;This line was there before you...&quot;);</span>

<span class="fc" id="L2367">        FileUtils.writeByteArrayToFile(file, &quot;this is brand new data&quot;.getBytes(), true);</span>

<span class="fc" id="L2369">        final String expected = &quot;This line was there before you...&quot;</span>
                + &quot;this is brand new data&quot;;
<span class="fc" id="L2371">        final String actual = FileUtils.readFileToString(file);</span>
<span class="fc" id="L2372">        assertEquals(expected, actual);</span>
<span class="fc" id="L2373">    }</span>

    @Test
    public void testWriteByteArrayToFile_WithAppendOptionFalse_ShouldDeletePreviousFileLines() throws Exception {
<span class="fc" id="L2377">        final File file = TestUtils.newFile(getTestDirectory(), &quot;lines.txt&quot;);</span>
<span class="fc" id="L2378">        FileUtils.writeStringToFile(file, &quot;This line was there before you...&quot;);</span>

<span class="fc" id="L2380">        FileUtils.writeByteArrayToFile(file, &quot;this is brand new data&quot;.getBytes(), false);</span>

<span class="fc" id="L2382">        final String expected = &quot;this is brand new data&quot;;</span>
<span class="fc" id="L2383">        final String actual = FileUtils.readFileToString(file);</span>
<span class="fc" id="L2384">        assertEquals(expected, actual);</span>
<span class="fc" id="L2385">    }</span>

    @Test
    public void testWriteByteArrayToFile_WithOffsetAndLength_WithAppendOptionTrue_ShouldNotDeletePreviousFileLines() throws Exception {
<span class="fc" id="L2389">        final File file = TestUtils.newFile(getTestDirectory(), &quot;lines.txt&quot;);</span>
<span class="fc" id="L2390">        FileUtils.writeStringToFile(file, &quot;This line was there before you...&quot;);</span>

<span class="fc" id="L2392">        final byte[] data = &quot;SKIP_THIS_this is brand new data_AND_SKIP_THIS&quot;.getBytes(Charsets.UTF_8);</span>
<span class="fc" id="L2393">        FileUtils.writeByteArrayToFile(file, data, 10, 22, true);</span>

<span class="fc" id="L2395">        final String expected = &quot;This line was there before you...&quot; + &quot;this is brand new data&quot;;</span>
<span class="fc" id="L2396">        final String actual = FileUtils.readFileToString(file, Charsets.UTF_8);</span>
<span class="fc" id="L2397">        assertEquals(expected, actual);</span>
<span class="fc" id="L2398">    }</span>

    @Test
    public void testWriteByteArrayToFile_WithOffsetAndLength_WithAppendOptionTrue_ShouldDeletePreviousFileLines() throws Exception {
<span class="fc" id="L2402">        final File file = TestUtils.newFile(getTestDirectory(), &quot;lines.txt&quot;);</span>
<span class="fc" id="L2403">        FileUtils.writeStringToFile(file, &quot;This line was there before you...&quot;);</span>

<span class="fc" id="L2405">        final byte[] data = &quot;SKIP_THIS_this is brand new data_AND_SKIP_THIS&quot;.getBytes(Charsets.UTF_8);</span>
<span class="fc" id="L2406">        FileUtils.writeByteArrayToFile(file, data, 10, 22, false);</span>

<span class="fc" id="L2408">        final String expected = &quot;this is brand new data&quot;;</span>
<span class="fc" id="L2409">        final String actual = FileUtils.readFileToString(file, Charsets.UTF_8);</span>
<span class="fc" id="L2410">        assertEquals(expected, actual);</span>
<span class="fc" id="L2411">    }</span>

    //-----------------------------------------------------------------------
    @Test
    public void testChecksumCRC32() throws Exception {
        // create a test file
<span class="fc" id="L2417">        final String text = &quot;Imagination is more important than knowledge - Einstein&quot;;</span>
<span class="fc" id="L2418">        final File file = new File(getTestDirectory(), &quot;checksum-test.txt&quot;);</span>
<span class="fc" id="L2419">        FileUtils.writeStringToFile(file, text, &quot;US-ASCII&quot;);</span>

        // compute the expected checksum
<span class="fc" id="L2422">        final Checksum expectedChecksum = new CRC32();</span>
<span class="fc" id="L2423">        expectedChecksum.update(text.getBytes(&quot;US-ASCII&quot;), 0, text.length());</span>
<span class="fc" id="L2424">        final long expectedValue = expectedChecksum.getValue();</span>

        // compute the checksum of the file
<span class="fc" id="L2427">        final long resultValue = FileUtils.checksumCRC32(file);</span>

<span class="fc" id="L2429">        assertEquals(expectedValue, resultValue);</span>
<span class="fc" id="L2430">    }</span>

    @Test
    public void testChecksum() throws Exception {
        // create a test file
<span class="fc" id="L2435">        final String text = &quot;Imagination is more important than knowledge - Einstein&quot;;</span>
<span class="fc" id="L2436">        final File file = new File(getTestDirectory(), &quot;checksum-test.txt&quot;);</span>
<span class="fc" id="L2437">        FileUtils.writeStringToFile(file, text, &quot;US-ASCII&quot;);</span>

        // compute the expected checksum
<span class="fc" id="L2440">        final Checksum expectedChecksum = new CRC32();</span>
<span class="fc" id="L2441">        expectedChecksum.update(text.getBytes(&quot;US-ASCII&quot;), 0, text.length());</span>
<span class="fc" id="L2442">        final long expectedValue = expectedChecksum.getValue();</span>

        // compute the checksum of the file
<span class="fc" id="L2445">        final Checksum testChecksum = new CRC32();</span>
<span class="fc" id="L2446">        final Checksum resultChecksum = FileUtils.checksum(file, testChecksum);</span>
<span class="fc" id="L2447">        final long resultValue = resultChecksum.getValue();</span>

<span class="fc" id="L2449">        assertSame(testChecksum, resultChecksum);</span>
<span class="fc" id="L2450">        assertEquals(expectedValue, resultValue);</span>
<span class="fc" id="L2451">    }</span>

    @Test
    public void testChecksumOnNullFile() throws Exception {
        try {
<span class="nc" id="L2456">            FileUtils.checksum(null, new CRC32());</span>
<span class="nc" id="L2457">            fail();</span>
<span class="fc" id="L2458">        } catch (final NullPointerException ex) {</span>
            // expected
<span class="nc" id="L2460">        }</span>
<span class="fc" id="L2461">    }</span>

    @Test
    public void testChecksumOnNullChecksum() throws Exception {
        // create a test file
<span class="fc" id="L2466">        final String text = &quot;Imagination is more important than knowledge - Einstein&quot;;</span>
<span class="fc" id="L2467">        final File file = new File(getTestDirectory(), &quot;checksum-test.txt&quot;);</span>
<span class="fc" id="L2468">        FileUtils.writeStringToFile(file, text, &quot;US-ASCII&quot;);</span>
        try {
<span class="nc" id="L2470">            FileUtils.checksum(file, null);</span>
<span class="nc" id="L2471">            fail();</span>
<span class="fc" id="L2472">        } catch (final NullPointerException ex) {</span>
            // expected
<span class="nc" id="L2474">        }</span>
<span class="fc" id="L2475">    }</span>

    @Test
    public void testChecksumOnDirectory() throws Exception {
        try {
<span class="nc" id="L2480">            FileUtils.checksum(new File(&quot;.&quot;), new CRC32());</span>
<span class="nc" id="L2481">            fail();</span>
<span class="fc" id="L2482">        } catch (final IllegalArgumentException ex) {</span>
            // expected
<span class="nc" id="L2484">        }</span>
<span class="fc" id="L2485">    }</span>

    @Test
    public void testChecksumDouble() throws Exception {
        // create a test file
<span class="fc" id="L2490">        final String text1 = &quot;Imagination is more important than knowledge - Einstein&quot;;</span>
<span class="fc" id="L2491">        final File file1 = new File(getTestDirectory(), &quot;checksum-test.txt&quot;);</span>
<span class="fc" id="L2492">        FileUtils.writeStringToFile(file1, text1, &quot;US-ASCII&quot;);</span>

        // create a second test file
<span class="fc" id="L2495">        final String text2 = &quot;To be or not to be - Shakespeare&quot;;</span>
<span class="fc" id="L2496">        final File file2 = new File(getTestDirectory(), &quot;checksum-test2.txt&quot;);</span>
<span class="fc" id="L2497">        FileUtils.writeStringToFile(file2, text2, &quot;US-ASCII&quot;);</span>

        // compute the expected checksum
<span class="fc" id="L2500">        final Checksum expectedChecksum = new CRC32();</span>
<span class="fc" id="L2501">        expectedChecksum.update(text1.getBytes(&quot;US-ASCII&quot;), 0, text1.length());</span>
<span class="fc" id="L2502">        expectedChecksum.update(text2.getBytes(&quot;US-ASCII&quot;), 0, text2.length());</span>
<span class="fc" id="L2503">        final long expectedValue = expectedChecksum.getValue();</span>

        // compute the checksum of the file
<span class="fc" id="L2506">        final Checksum testChecksum = new CRC32();</span>
<span class="fc" id="L2507">        FileUtils.checksum(file1, testChecksum);</span>
<span class="fc" id="L2508">        FileUtils.checksum(file2, testChecksum);</span>
<span class="fc" id="L2509">        final long resultValue = testChecksum.getValue();</span>

<span class="fc" id="L2511">        assertEquals(expectedValue, resultValue);</span>
<span class="fc" id="L2512">    }</span>

    @Test
    public void testDeleteDirectoryWithNonDirectory() throws Exception {
        try {
<span class="nc" id="L2517">            FileUtils.deleteDirectory(testFile1);</span>
<span class="nc" id="L2518">            fail();</span>
<span class="fc" id="L2519">        } catch (final IllegalArgumentException ex) {</span>
            // expected
<span class="nc" id="L2521">        }</span>
<span class="fc" id="L2522">    }</span>

    @Test
    public void testDeleteQuietlyForNull() {
        try {
<span class="fc" id="L2527">            FileUtils.deleteQuietly(null);</span>
<span class="nc" id="L2528">        } catch (final Exception ex) {</span>
<span class="nc" id="L2529">            fail(ex.getMessage());</span>
<span class="fc" id="L2530">        }</span>
<span class="fc" id="L2531">    }</span>

    @Test
    public void testDeleteQuietlyDir() throws IOException {
<span class="fc" id="L2535">        final File testDirectory = new File(getTestDirectory(), &quot;testDeleteQuietlyDir&quot;);</span>
<span class="fc" id="L2536">        final File testFile = new File(testDirectory, &quot;testDeleteQuietlyFile&quot;);</span>
<span class="fc" id="L2537">        testDirectory.mkdirs();</span>
<span class="pc bpc" id="L2538" title="1 of 2 branches missed.">        if (!testFile.getParentFile().exists()) {</span>
<span class="nc" id="L2539">            throw new IOException(&quot;Cannot create file &quot; + testFile</span>
                    + &quot; as the parent directory does not exist&quot;);
        }
<span class="fc" id="L2542">        final BufferedOutputStream output =</span>
                new BufferedOutputStream(new FileOutputStream(testFile));
        try {
<span class="fc" id="L2545">            TestUtils.generateTestData(output, 0);</span>
        } finally {
<span class="fc" id="L2547">            IOUtils.closeQuietly(output);</span>
        }

<span class="fc" id="L2550">        assertTrue(testDirectory.exists());</span>
<span class="fc" id="L2551">        assertTrue(testFile.exists());</span>
<span class="fc" id="L2552">        FileUtils.deleteQuietly(testDirectory);</span>
<span class="fc" id="L2553">        assertFalse(&quot;Check No Exist&quot;, testDirectory.exists());</span>
<span class="fc" id="L2554">        assertFalse(&quot;Check No Exist&quot;, testFile.exists());</span>
<span class="fc" id="L2555">    }</span>

    @Test
    public void testDeleteQuietlyFile() throws IOException {
<span class="fc" id="L2559">        final File testFile = new File(getTestDirectory(), &quot;testDeleteQuietlyFile&quot;);</span>
<span class="pc bpc" id="L2560" title="1 of 2 branches missed.">        if (!testFile.getParentFile().exists()) {</span>
<span class="nc" id="L2561">            throw new IOException(&quot;Cannot create file &quot; + testFile</span>
                    + &quot; as the parent directory does not exist&quot;);
        }
<span class="fc" id="L2564">        final BufferedOutputStream output =</span>
                new BufferedOutputStream(new FileOutputStream(testFile));
        try {
<span class="fc" id="L2567">            TestUtils.generateTestData(output, 0);</span>
        } finally {
<span class="fc" id="L2569">            IOUtils.closeQuietly(output);</span>
        }

<span class="fc" id="L2572">        assertTrue(testFile.exists());</span>
<span class="fc" id="L2573">        FileUtils.deleteQuietly(testFile);</span>
<span class="fc" id="L2574">        assertFalse(&quot;Check No Exist&quot;, testFile.exists());</span>
<span class="fc" id="L2575">    }</span>

    @Test
    public void testDeleteQuietlyNonExistent() {
<span class="fc" id="L2579">        final File testFile = new File(&quot;testDeleteQuietlyNonExistent&quot;);</span>
<span class="fc" id="L2580">        assertFalse(testFile.exists());</span>

        try {
<span class="fc" id="L2583">            FileUtils.deleteQuietly(testFile);</span>
<span class="nc" id="L2584">        } catch (final Exception ex) {</span>
<span class="nc" id="L2585">            fail(ex.getMessage());</span>
<span class="fc" id="L2586">        }</span>
<span class="fc" id="L2587">    }</span>

    @Test
    public void testMoveFile_Rename() throws Exception {
<span class="fc" id="L2591">        final File destination = new File(getTestDirectory(), &quot;move1.txt&quot;);</span>

<span class="fc" id="L2593">        FileUtils.moveFile(testFile1, destination);</span>
<span class="fc" id="L2594">        assertTrue(&quot;Check Exist&quot;, destination.exists());</span>
<span class="pc bpc" id="L2595" title="1 of 2 branches missed.">        assertTrue(&quot;Original deleted&quot;, !testFile1.exists());</span>
<span class="fc" id="L2596">    }</span>

    @Test
    public void testMoveFile_CopyDelete() throws Exception {
<span class="fc" id="L2600">        final File destination = new File(getTestDirectory(), &quot;move2.txt&quot;);</span>
<span class="fc" id="L2601">        final File src = new File(testFile1.getAbsolutePath()) {</span>
            private static final long serialVersionUID = 1L;

            // Force renameTo to fail, as if destination is on another
            // filesystem
            @Override
            public boolean renameTo(final File f) {
<span class="fc" id="L2608">                return false;</span>
            }
        };
<span class="fc" id="L2611">        FileUtils.moveFile(src, destination);</span>
<span class="fc" id="L2612">        assertTrue(&quot;Check Exist&quot;, destination.exists());</span>
<span class="pc bpc" id="L2613" title="1 of 2 branches missed.">        assertTrue(&quot;Original deleted&quot;, !src.exists());</span>
<span class="fc" id="L2614">    }</span>

    @Test
    public void testMoveFile_CopyDelete_Failed() throws Exception {
<span class="fc" id="L2618">        final File destination = new File(getTestDirectory(), &quot;move3.txt&quot;);</span>
<span class="fc" id="L2619">        final File src = new File(testFile1.getAbsolutePath()) {</span>
            private static final long serialVersionUID = 1L;

            // Force renameTo to fail, as if destination is on another
            // filesystem
            @Override
            public boolean renameTo(final File f) {
<span class="fc" id="L2626">                return false;</span>
            }

            // Force delete failure
            @Override
            public boolean delete() {
<span class="fc" id="L2632">                return false;</span>
            }

        };
        try {
<span class="nc" id="L2637">            FileUtils.moveFile(src, destination);</span>
<span class="nc" id="L2638">            fail(&quot;move should have failed as src has not been deleted&quot;);</span>
<span class="fc" id="L2639">        } catch (final IOException e) {</span>
            // exepected
<span class="pc bpc" id="L2641" title="1 of 2 branches missed.">            assertTrue(&quot;Check Rollback&quot;, !destination.exists());</span>
<span class="fc" id="L2642">            assertTrue(&quot;Original exists&quot;, src.exists());</span>
<span class="nc" id="L2643">        }</span>
<span class="fc" id="L2644">    }</span>

    @Test
    public void testMoveFile_Errors() throws Exception {
        try {
<span class="nc" id="L2649">            FileUtils.moveFile(null, new File(&quot;foo&quot;));</span>
<span class="nc" id="L2650">            fail(&quot;Expected NullPointerException when source is null&quot;);</span>
<span class="fc" id="L2651">        } catch (final NullPointerException e) {</span>
            // expected
<span class="nc" id="L2653">        }</span>
        try {
<span class="nc" id="L2655">            FileUtils.moveFile(new File(&quot;foo&quot;), null);</span>
<span class="nc" id="L2656">            fail(&quot;Expected NullPointerException when destination is null&quot;);</span>
<span class="fc" id="L2657">        } catch (final NullPointerException e) {</span>
            // expected
<span class="nc" id="L2659">        }</span>
        try {
<span class="nc" id="L2661">            FileUtils.moveFile(new File(&quot;nonexistant&quot;), new File(&quot;foo&quot;));</span>
<span class="nc" id="L2662">            fail(&quot;Expected FileNotFoundException for source&quot;);</span>
<span class="fc" id="L2663">        } catch (final FileNotFoundException e) {</span>
            // expected
<span class="nc" id="L2665">        }</span>
        try {
<span class="nc" id="L2667">            FileUtils.moveFile(getTestDirectory(), new File(&quot;foo&quot;));</span>
<span class="nc" id="L2668">            fail(&quot;Expected IOException when source is a directory&quot;);</span>
<span class="fc" id="L2669">        } catch (final IOException e) {</span>
            // expected
<span class="nc" id="L2671">        }</span>
<span class="fc" id="L2672">        final File testSourceFile = new File(getTestDirectory(), &quot;testMoveFileSource&quot;);</span>
<span class="fc" id="L2673">        final File testDestFile = new File(getTestDirectory(), &quot;testMoveFileSource&quot;);</span>
<span class="pc bpc" id="L2674" title="1 of 2 branches missed.">        if (!testSourceFile.getParentFile().exists()) {</span>
<span class="nc" id="L2675">            throw new IOException(&quot;Cannot create file &quot; + testSourceFile</span>
                    + &quot; as the parent directory does not exist&quot;);
        }
<span class="fc" id="L2678">        final BufferedOutputStream output1 =</span>
                new BufferedOutputStream(new FileOutputStream(testSourceFile));
        try {
<span class="fc" id="L2681">            TestUtils.generateTestData(output1, 0);</span>
        } finally {
<span class="fc" id="L2683">            IOUtils.closeQuietly(output1);</span>
        }
<span class="pc bpc" id="L2685" title="1 of 2 branches missed.">        if (!testDestFile.getParentFile().exists()) {</span>
<span class="nc" id="L2686">            throw new IOException(&quot;Cannot create file &quot; + testDestFile</span>
                    + &quot; as the parent directory does not exist&quot;);
        }
<span class="fc" id="L2689">        final BufferedOutputStream output =</span>
                new BufferedOutputStream(new FileOutputStream(testDestFile));
        try {
<span class="fc" id="L2692">            TestUtils.generateTestData(output, 0);</span>
        } finally {
<span class="fc" id="L2694">            IOUtils.closeQuietly(output);</span>
        }
        try {
<span class="nc" id="L2697">            FileUtils.moveFile(testSourceFile, testDestFile);</span>
<span class="nc" id="L2698">            fail(&quot;Expected FileExistsException when dest already exists&quot;);</span>
<span class="fc" id="L2699">        } catch (final FileExistsException e) {</span>
            // expected
<span class="nc" id="L2701">        }</span>
<span class="fc" id="L2702">    }</span>

    @Test
    public void testMoveFileToDirectory() throws Exception {
<span class="fc" id="L2706">        final File destDir = new File(getTestDirectory(), &quot;moveFileDestDir&quot;);</span>
<span class="fc" id="L2707">        final File movedFile = new File(destDir, testFile1.getName());</span>
<span class="fc" id="L2708">        assertFalse(&quot;Check Exist before&quot;, destDir.exists());</span>
<span class="fc" id="L2709">        assertFalse(&quot;Check Exist before&quot;, movedFile.exists());</span>

<span class="fc" id="L2711">        FileUtils.moveFileToDirectory(testFile1, destDir, true);</span>
<span class="fc" id="L2712">        assertTrue(&quot;Check Exist after&quot;, movedFile.exists());</span>
<span class="pc bpc" id="L2713" title="1 of 2 branches missed.">        assertTrue(&quot;Original deleted&quot;, !testFile1.exists());</span>
<span class="fc" id="L2714">    }</span>

    @Test
    public void testMoveFileToDirectory_Errors() throws Exception {
        try {
<span class="nc" id="L2719">            FileUtils.moveFileToDirectory(null, new File(&quot;foo&quot;), true);</span>
<span class="nc" id="L2720">            fail(&quot;Expected NullPointerException when source is null&quot;);</span>
<span class="fc" id="L2721">        } catch (final NullPointerException e) {</span>
            // expected
<span class="nc" id="L2723">        }</span>
        try {
<span class="nc" id="L2725">            FileUtils.moveFileToDirectory(new File(&quot;foo&quot;), null, true);</span>
<span class="nc" id="L2726">            fail(&quot;Expected NullPointerException when destination is null&quot;);</span>
<span class="fc" id="L2727">        } catch (final NullPointerException e) {</span>
            // expected
<span class="nc" id="L2729">        }</span>
<span class="fc" id="L2730">        final File testFile1 = new File(getTestDirectory(), &quot;testMoveFileFile1&quot;);</span>
<span class="fc" id="L2731">        final File testFile2 = new File(getTestDirectory(), &quot;testMoveFileFile2&quot;);</span>
<span class="pc bpc" id="L2732" title="1 of 2 branches missed.">        if (!testFile1.getParentFile().exists()) {</span>
<span class="nc" id="L2733">            throw new IOException(&quot;Cannot create file &quot; + testFile1</span>
                    + &quot; as the parent directory does not exist&quot;);
        }
<span class="fc" id="L2736">        final BufferedOutputStream output1 =</span>
                new BufferedOutputStream(new FileOutputStream(testFile1));
        try {
<span class="fc" id="L2739">            TestUtils.generateTestData(output1, 0);</span>
        } finally {
<span class="fc" id="L2741">            IOUtils.closeQuietly(output1);</span>
        }
<span class="pc bpc" id="L2743" title="1 of 2 branches missed.">        if (!testFile2.getParentFile().exists()) {</span>
<span class="nc" id="L2744">            throw new IOException(&quot;Cannot create file &quot; + testFile2</span>
                    + &quot; as the parent directory does not exist&quot;);
        }
<span class="fc" id="L2747">        final BufferedOutputStream output =</span>
                new BufferedOutputStream(new FileOutputStream(testFile2));
        try {
<span class="fc" id="L2750">            TestUtils.generateTestData(output, 0);</span>
        } finally {
<span class="fc" id="L2752">            IOUtils.closeQuietly(output);</span>
        }
        try {
<span class="nc" id="L2755">            FileUtils.moveFileToDirectory(testFile1, testFile2, true);</span>
<span class="nc" id="L2756">            fail(&quot;Expected IOException when dest not a directory&quot;);</span>
<span class="fc" id="L2757">        } catch (final IOException e) {</span>
            // expected
<span class="nc" id="L2759">        }</span>

<span class="fc" id="L2761">        final File nonexistant = new File(getTestDirectory(), &quot;testMoveFileNonExistant&quot;);</span>
        try {
<span class="nc" id="L2763">            FileUtils.moveFileToDirectory(testFile1, nonexistant, false);</span>
<span class="nc" id="L2764">            fail(&quot;Expected IOException when dest does not exist and create=false&quot;);</span>
<span class="fc" id="L2765">        } catch (final IOException e) {</span>
            // expected
<span class="nc" id="L2767">        }</span>
<span class="fc" id="L2768">    }</span>


    @Test
    public void testMoveDirectory_Rename() throws Exception {
<span class="fc" id="L2773">        final File dir = getTestDirectory();</span>
<span class="fc" id="L2774">        final File src = new File(dir, &quot;testMoveDirectory1Source&quot;);</span>
<span class="fc" id="L2775">        final File testDir = new File(src, &quot;foo&quot;);</span>
<span class="fc" id="L2776">        final File testFile = new File(testDir, &quot;bar&quot;);</span>
<span class="fc" id="L2777">        testDir.mkdirs();</span>
<span class="pc bpc" id="L2778" title="1 of 2 branches missed.">        if (!testFile.getParentFile().exists()) {</span>
<span class="nc" id="L2779">            throw new IOException(&quot;Cannot create file &quot; + testFile</span>
                    + &quot; as the parent directory does not exist&quot;);
        }
<span class="fc" id="L2782">        final BufferedOutputStream output =</span>
                new BufferedOutputStream(new FileOutputStream(testFile));
        try {
<span class="fc" id="L2785">            TestUtils.generateTestData(output, 0);</span>
        } finally {
<span class="fc" id="L2787">            IOUtils.closeQuietly(output);</span>
        }
<span class="fc" id="L2789">        final File destination = new File(dir, &quot;testMoveDirectory1Dest&quot;);</span>
<span class="fc" id="L2790">        FileUtils.deleteDirectory(destination);</span>

        // Move the directory
<span class="fc" id="L2793">        FileUtils.moveDirectory(src, destination);</span>

        // Check results
<span class="fc" id="L2796">        assertTrue(&quot;Check Exist&quot;, destination.exists());</span>
<span class="pc bpc" id="L2797" title="1 of 2 branches missed.">        assertTrue(&quot;Original deleted&quot;, !src.exists());</span>
<span class="fc" id="L2798">        final File movedDir = new File(destination, testDir.getName());</span>
<span class="fc" id="L2799">        final File movedFile = new File(movedDir, testFile.getName());</span>
<span class="fc" id="L2800">        assertTrue(&quot;Check dir moved&quot;, movedDir.exists());</span>
<span class="fc" id="L2801">        assertTrue(&quot;Check file moved&quot;, movedFile.exists());</span>
<span class="fc" id="L2802">    }</span>

    @Test
    public void testMoveDirectory_CopyDelete() throws Exception {

<span class="fc" id="L2807">        final File dir = getTestDirectory();</span>
<span class="fc" id="L2808">        final File src = new File(dir, &quot;testMoveDirectory2Source&quot;) {</span>
            private static final long serialVersionUID = 1L;

            // Force renameTo to fail
            @Override
            public boolean renameTo(final File dest) {
<span class="fc" id="L2814">                return false;</span>
            }
        };
<span class="fc" id="L2817">        final File testDir = new File(src, &quot;foo&quot;);</span>
<span class="fc" id="L2818">        final File testFile = new File(testDir, &quot;bar&quot;);</span>
<span class="fc" id="L2819">        testDir.mkdirs();</span>
<span class="pc bpc" id="L2820" title="1 of 2 branches missed.">        if (!testFile.getParentFile().exists()) {</span>
<span class="nc" id="L2821">            throw new IOException(&quot;Cannot create file &quot; + testFile</span>
                    + &quot; as the parent directory does not exist&quot;);
        }
<span class="fc" id="L2824">        final BufferedOutputStream output =</span>
                new BufferedOutputStream(new FileOutputStream(testFile));
        try {
<span class="fc" id="L2827">            TestUtils.generateTestData(output, 0);</span>
        } finally {
<span class="fc" id="L2829">            IOUtils.closeQuietly(output);</span>
        }
<span class="fc" id="L2831">        final File destination = new File(dir, &quot;testMoveDirectory1Dest&quot;);</span>
<span class="fc" id="L2832">        FileUtils.deleteDirectory(destination);</span>

        // Move the directory
<span class="fc" id="L2835">        FileUtils.moveDirectory(src, destination);</span>

        // Check results
<span class="fc" id="L2838">        assertTrue(&quot;Check Exist&quot;, destination.exists());</span>
<span class="pc bpc" id="L2839" title="1 of 2 branches missed.">        assertTrue(&quot;Original deleted&quot;, !src.exists());</span>
<span class="fc" id="L2840">        final File movedDir = new File(destination, testDir.getName());</span>
<span class="fc" id="L2841">        final File movedFile = new File(movedDir, testFile.getName());</span>
<span class="fc" id="L2842">        assertTrue(&quot;Check dir moved&quot;, movedDir.exists());</span>
<span class="fc" id="L2843">        assertTrue(&quot;Check file moved&quot;, movedFile.exists());</span>
<span class="fc" id="L2844">    }</span>

    @Test
    public void testMoveDirectory_Errors() throws Exception {
        try {
<span class="nc" id="L2849">            FileUtils.moveDirectory(null, new File(&quot;foo&quot;));</span>
<span class="nc" id="L2850">            fail(&quot;Expected NullPointerException when source is null&quot;);</span>
<span class="fc" id="L2851">        } catch (final NullPointerException e) {</span>
            // expected
<span class="nc" id="L2853">        }</span>
        try {
<span class="nc" id="L2855">            FileUtils.moveDirectory(new File(&quot;foo&quot;), null);</span>
<span class="nc" id="L2856">            fail(&quot;Expected NullPointerException when destination is null&quot;);</span>
<span class="fc" id="L2857">        } catch (final NullPointerException e) {</span>
            // expected
<span class="nc" id="L2859">        }</span>
        try {
<span class="nc" id="L2861">            FileUtils.moveDirectory(new File(&quot;nonexistant&quot;), new File(&quot;foo&quot;));</span>
<span class="nc" id="L2862">            fail(&quot;Expected FileNotFoundException for source&quot;);</span>
<span class="fc" id="L2863">        } catch (final FileNotFoundException e) {</span>
            // expected
<span class="nc" id="L2865">        }</span>
<span class="fc" id="L2866">        final File testFile = new File(getTestDirectory(), &quot;testMoveDirectoryFile&quot;);</span>
<span class="pc bpc" id="L2867" title="1 of 2 branches missed.">        if (!testFile.getParentFile().exists()) {</span>
<span class="nc" id="L2868">            throw new IOException(&quot;Cannot create file &quot; + testFile</span>
                    + &quot; as the parent directory does not exist&quot;);
        }
<span class="fc" id="L2871">        final BufferedOutputStream output =</span>
                new BufferedOutputStream(new FileOutputStream(testFile));
        try {
<span class="fc" id="L2874">            TestUtils.generateTestData(output, 0);</span>
        } finally {
<span class="fc" id="L2876">            IOUtils.closeQuietly(output);</span>
        }
        try {
<span class="nc" id="L2879">            FileUtils.moveDirectory(testFile, new File(&quot;foo&quot;));</span>
<span class="nc" id="L2880">            fail(&quot;Expected IOException when source is not a directory&quot;);</span>
<span class="fc" id="L2881">        } catch (final IOException e) {</span>
            // expected
<span class="nc" id="L2883">        }</span>
<span class="fc" id="L2884">        final File testSrcFile = new File(getTestDirectory(), &quot;testMoveDirectorySource&quot;);</span>
<span class="fc" id="L2885">        final File testDestFile = new File(getTestDirectory(), &quot;testMoveDirectoryDest&quot;);</span>
<span class="fc" id="L2886">        testSrcFile.mkdir();</span>
<span class="fc" id="L2887">        testDestFile.mkdir();</span>
        try {
<span class="nc" id="L2889">            FileUtils.moveDirectory(testSrcFile, testDestFile);</span>
<span class="nc" id="L2890">            fail(&quot;Expected FileExistsException when dest already exists&quot;);</span>
<span class="fc" id="L2891">        } catch (final FileExistsException e) {</span>
            // expected
<span class="nc" id="L2893">        }</span>
<span class="fc" id="L2894">    }</span>

    @Test
    public void testMoveDirectoryToDirectory() throws Exception {
<span class="fc" id="L2898">        final File dir = getTestDirectory();</span>
<span class="fc" id="L2899">        final File src = new File(dir, &quot;testMoveDirectory1Source&quot;);</span>
<span class="fc" id="L2900">        final File testChildDir = new File(src, &quot;foo&quot;);</span>
<span class="fc" id="L2901">        final File testFile = new File(testChildDir, &quot;bar&quot;);</span>
<span class="fc" id="L2902">        testChildDir.mkdirs();</span>
<span class="pc bpc" id="L2903" title="1 of 2 branches missed.">        if (!testFile.getParentFile().exists()) {</span>
<span class="nc" id="L2904">            throw new IOException(&quot;Cannot create file &quot; + testFile</span>
                    + &quot; as the parent directory does not exist&quot;);
        }
<span class="fc" id="L2907">        final BufferedOutputStream output =</span>
                new BufferedOutputStream(new FileOutputStream(testFile));
        try {
<span class="fc" id="L2910">            TestUtils.generateTestData(output, 0);</span>
        } finally {
<span class="fc" id="L2912">            IOUtils.closeQuietly(output);</span>
        }
<span class="fc" id="L2914">        final File destDir = new File(dir, &quot;testMoveDirectory1Dest&quot;);</span>
<span class="fc" id="L2915">        FileUtils.deleteDirectory(destDir);</span>
<span class="fc" id="L2916">        assertFalse(&quot;Check Exist before&quot;, destDir.exists());</span>

        // Move the directory
<span class="fc" id="L2919">        FileUtils.moveDirectoryToDirectory(src, destDir, true);</span>

        // Check results
<span class="fc" id="L2922">        assertTrue(&quot;Check Exist after&quot;, destDir.exists());</span>
<span class="pc bpc" id="L2923" title="1 of 2 branches missed.">        assertTrue(&quot;Original deleted&quot;, !src.exists());</span>
<span class="fc" id="L2924">        final File movedDir = new File(destDir, src.getName());</span>
<span class="fc" id="L2925">        final File movedChildDir = new File(movedDir, testChildDir.getName());</span>
<span class="fc" id="L2926">        final File movedFile = new File(movedChildDir, testFile.getName());</span>
<span class="fc" id="L2927">        assertTrue(&quot;Check dir moved&quot;, movedDir.exists());</span>
<span class="fc" id="L2928">        assertTrue(&quot;Check child dir moved&quot;, movedChildDir.exists());</span>
<span class="fc" id="L2929">        assertTrue(&quot;Check file moved&quot;, movedFile.exists());</span>
<span class="fc" id="L2930">    }</span>

    @Test
    public void testMoveDirectoryToDirectory_Errors() throws Exception {
        try {
<span class="nc" id="L2935">            FileUtils.moveDirectoryToDirectory(null, new File(&quot;foo&quot;), true);</span>
<span class="nc" id="L2936">            fail(&quot;Expected NullPointerException when source is null&quot;);</span>
<span class="fc" id="L2937">        } catch (final NullPointerException e) {</span>
            // expected
<span class="nc" id="L2939">        }</span>
        try {
<span class="nc" id="L2941">            FileUtils.moveDirectoryToDirectory(new File(&quot;foo&quot;), null, true);</span>
<span class="nc" id="L2942">            fail(&quot;Expected NullPointerException when destination is null&quot;);</span>
<span class="fc" id="L2943">        } catch (final NullPointerException e) {</span>
            // expected
<span class="nc" id="L2945">        }</span>
<span class="fc" id="L2946">        final File testFile1 = new File(getTestDirectory(), &quot;testMoveFileFile1&quot;);</span>
<span class="fc" id="L2947">        final File testFile2 = new File(getTestDirectory(), &quot;testMoveFileFile2&quot;);</span>
<span class="pc bpc" id="L2948" title="1 of 2 branches missed.">        if (!testFile1.getParentFile().exists()) {</span>
<span class="nc" id="L2949">            throw new IOException(&quot;Cannot create file &quot; + testFile1</span>
                    + &quot; as the parent directory does not exist&quot;);
        }
<span class="fc" id="L2952">        final BufferedOutputStream output1 =</span>
                new BufferedOutputStream(new FileOutputStream(testFile1));
        try {
<span class="fc" id="L2955">            TestUtils.generateTestData(output1, 0);</span>
        } finally {
<span class="fc" id="L2957">            IOUtils.closeQuietly(output1);</span>
        }
<span class="pc bpc" id="L2959" title="1 of 2 branches missed.">        if (!testFile2.getParentFile().exists()) {</span>
<span class="nc" id="L2960">            throw new IOException(&quot;Cannot create file &quot; + testFile2</span>
                    + &quot; as the parent directory does not exist&quot;);
        }
<span class="fc" id="L2963">        final BufferedOutputStream output =</span>
                new BufferedOutputStream(new FileOutputStream(testFile2));
        try {
<span class="fc" id="L2966">            TestUtils.generateTestData(output, 0);</span>
        } finally {
<span class="fc" id="L2968">            IOUtils.closeQuietly(output);</span>
        }
        try {
<span class="nc" id="L2971">            FileUtils.moveDirectoryToDirectory(testFile1, testFile2, true);</span>
<span class="nc" id="L2972">            fail(&quot;Expected IOException when dest not a directory&quot;);</span>
<span class="fc" id="L2973">        } catch (final IOException e) {</span>
            // expected
<span class="nc" id="L2975">        }</span>

<span class="fc" id="L2977">        final File nonexistant = new File(getTestDirectory(), &quot;testMoveFileNonExistant&quot;);</span>
        try {
<span class="nc" id="L2979">            FileUtils.moveDirectoryToDirectory(testFile1, nonexistant, false);</span>
<span class="nc" id="L2980">            fail(&quot;Expected IOException when dest does not exist and create=false&quot;);</span>
<span class="fc" id="L2981">        } catch (final IOException e) {</span>
            // expected
<span class="nc" id="L2983">        }</span>
<span class="fc" id="L2984">    }</span>

    @Test
    public void testMoveToDirectory() throws Exception {
<span class="fc" id="L2988">        final File destDir = new File(getTestDirectory(), &quot;testMoveToDirectoryDestDir&quot;);</span>
<span class="fc" id="L2989">        final File testDir = new File(getTestDirectory(), &quot;testMoveToDirectoryTestDir&quot;);</span>
<span class="fc" id="L2990">        final File testFile = new File(getTestDirectory(), &quot;testMoveToDirectoryTestFile&quot;);</span>
<span class="fc" id="L2991">        testDir.mkdirs();</span>
<span class="pc bpc" id="L2992" title="1 of 2 branches missed.">        if (!testFile.getParentFile().exists()) {</span>
<span class="nc" id="L2993">            throw new IOException(&quot;Cannot create file &quot; + testFile</span>
                    + &quot; as the parent directory does not exist&quot;);
        }
<span class="fc" id="L2996">        final BufferedOutputStream output =</span>
                new BufferedOutputStream(new FileOutputStream(testFile));
        try {
<span class="fc" id="L2999">            TestUtils.generateTestData(output, 0);</span>
        } finally {
<span class="fc" id="L3001">            IOUtils.closeQuietly(output);</span>
        }
<span class="fc" id="L3003">        final File movedFile = new File(destDir, testFile.getName());</span>
<span class="fc" id="L3004">        final File movedDir = new File(destDir, testFile.getName());</span>

<span class="fc" id="L3006">        assertFalse(&quot;Check File Doesnt exist&quot;, movedFile.exists());</span>
<span class="fc" id="L3007">        assertFalse(&quot;Check Dir Doesnt exist&quot;, movedDir.exists());</span>

        // Test moving a file
<span class="fc" id="L3010">        FileUtils.moveToDirectory(testFile, destDir, true);</span>
<span class="fc" id="L3011">        assertTrue(&quot;Check File exists&quot;, movedFile.exists());</span>
<span class="fc" id="L3012">        assertFalse(&quot;Check Original File doesn't exist&quot;, testFile.exists());</span>

        // Test moving a directory
<span class="fc" id="L3015">        FileUtils.moveToDirectory(testDir, destDir, true);</span>
<span class="fc" id="L3016">        assertTrue(&quot;Check Dir exists&quot;, movedDir.exists());</span>
<span class="fc" id="L3017">        assertFalse(&quot;Check Original Dir doesn't exist&quot;, testDir.exists());</span>
<span class="fc" id="L3018">    }</span>

    @Test
    public void testMoveToDirectory_Errors() throws Exception {
        try {
<span class="nc" id="L3023">            FileUtils.moveDirectoryToDirectory(null, new File(&quot;foo&quot;), true);</span>
<span class="nc" id="L3024">            fail(&quot;Expected NullPointerException when source is null&quot;);</span>
<span class="fc" id="L3025">        } catch (final NullPointerException e) {</span>
            // expected
<span class="nc" id="L3027">        }</span>
        try {
<span class="nc" id="L3029">            FileUtils.moveDirectoryToDirectory(new File(&quot;foo&quot;), null, true);</span>
<span class="nc" id="L3030">            fail(&quot;Expected NullPointerException when destination is null&quot;);</span>
<span class="fc" id="L3031">        } catch (final NullPointerException e) {</span>
            // expected
<span class="nc" id="L3033">        }</span>
<span class="fc" id="L3034">        final File nonexistant = new File(getTestDirectory(), &quot;nonexistant&quot;);</span>
<span class="fc" id="L3035">        final File destDir = new File(getTestDirectory(), &quot;MoveToDirectoryDestDir&quot;);</span>
        try {
<span class="nc" id="L3037">            FileUtils.moveToDirectory(nonexistant, destDir, true);</span>
<span class="nc" id="L3038">            fail(&quot;Expected IOException when source does not exist&quot;);</span>
<span class="fc" id="L3039">        } catch (final IOException e) {</span>
            // expected
<span class="nc" id="L3041">        }</span>
<span class="fc" id="L3042">    }</span>

    @Test
    public void testIO300() throws Exception {
<span class="fc" id="L3046">        final File testDirectory = getTestDirectory();</span>
<span class="fc" id="L3047">        final File src = new File(testDirectory, &quot;dir1&quot;);</span>
<span class="fc" id="L3048">        final File dest = new File(src, &quot;dir2&quot;);</span>
<span class="fc" id="L3049">        assertTrue(dest.mkdirs());</span>
<span class="fc" id="L3050">        assertTrue(src.exists());</span>
        try {
<span class="nc" id="L3052">            FileUtils.moveDirectoryToDirectory(src, dest, false);</span>
<span class="nc" id="L3053">            fail(&quot;expected IOException&quot;);</span>
<span class="fc" id="L3054">        } catch (final IOException ioe) {</span>
            // expected
<span class="nc" id="L3056">        }</span>
<span class="fc" id="L3057">        assertTrue(src.exists());</span>
<span class="fc" id="L3058">    }</span>

    @Test
    public void testIO276() throws Exception {
<span class="fc" id="L3062">        final File dir = new File(&quot;target&quot;, &quot;IO276&quot;);</span>
<span class="fc" id="L3063">        assertTrue(dir + &quot; should not be present&quot;, dir.mkdirs());</span>
<span class="fc" id="L3064">        final File file = new File(dir, &quot;IO276.txt&quot;);</span>
<span class="fc" id="L3065">        assertTrue(file + &quot; should not be present&quot;, file.createNewFile());</span>
<span class="fc" id="L3066">        FileUtils.forceDeleteOnExit(dir);</span>
        // If this does not work, test will fail next time (assuming target is not cleaned)
<span class="fc" id="L3068">    }</span>

    // Test helper class to pretend a file is shorter than it is
    private static class ShorterFile extends File {
        private static final long serialVersionUID = 1L;

        public ShorterFile(final String pathname) {
<span class="fc" id="L3075">            super(pathname);</span>
<span class="fc" id="L3076">        }</span>

        @Override
        public long length() {
<span class="fc" id="L3080">            return super.length() - 1;</span>
        }
    }

    // This test relies on FileUtils.copyFile using File.length to check the output size
    @Test
    public void testIncorrectOutputSize() throws Exception {
<span class="fc" id="L3087">        final File inFile = new File(&quot;pom.xml&quot;);</span>
<span class="fc" id="L3088">        final File outFile = new ShorterFile(&quot;target/pom.tmp&quot;); // it will report a shorter file</span>
        try {
<span class="nc" id="L3090">            FileUtils.copyFile(inFile, outFile);</span>
<span class="nc" id="L3091">            fail(&quot;Expected IOException&quot;);</span>
<span class="fc" id="L3092">        } catch (final Exception e) {</span>
<span class="fc" id="L3093">            final String msg = e.toString();</span>
<span class="fc" id="L3094">            assertTrue(msg, msg.contains(&quot;Failed to copy full contents&quot;));</span>
        } finally {
<span class="fc" id="L3096">            outFile.delete(); // tidy up</span>
        }
<span class="fc" id="L3098">    }</span>

    /**
     * DirectoryWalker implementation that recursively lists all files and directories.
     */
    static class ListDirectoryWalker extends DirectoryWalker&lt;File&gt; {
        ListDirectoryWalker() {
<span class="fc" id="L3105">            super();</span>
<span class="fc" id="L3106">        }</span>

        List&lt;File&gt; list(final File startDirectory) throws IOException {
<span class="fc" id="L3109">            final ArrayList&lt;File&gt; files = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L3110">            walk(startDirectory, files);</span>
<span class="fc" id="L3111">            return files;</span>
        }

        @Override
        protected void handleDirectoryStart(final File directory, final int depth, final Collection&lt;File&gt; results) throws IOException {
            // Add all directories except the starting directory
<span class="fc bfc" id="L3117" title="All 2 branches covered.">            if (depth &gt; 0) {</span>
<span class="fc" id="L3118">                results.add(directory);</span>
            }
<span class="fc" id="L3120">        }</span>

        @Override
        protected void handleFile(final File file, final int depth, final Collection&lt;File&gt; results) throws IOException {
<span class="fc" id="L3124">            results.add(file);</span>
<span class="fc" id="L3125">        }</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.2.201808211720</span></div></body></html>