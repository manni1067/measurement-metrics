<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>MUCPersistenceManager.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Core XMPP Server</a> &gt; <a href="index.source.html" class="el_package">org.jivesoftware.openfire.muc.spi</a> &gt; <span class="el_source">MUCPersistenceManager.java</span></div><h1>MUCPersistenceManager.java</h1><pre class="source lang-java linenums">/*
 * Copyright (C) 2004-2008 Jive Software. All rights reserved.
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package org.jivesoftware.openfire.muc.spi;

import java.math.BigInteger;
import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.util.*;
import java.util.concurrent.ConcurrentHashMap;

import org.jivesoftware.database.DbConnectionManager;
import org.jivesoftware.database.SequenceManager;
import org.jivesoftware.openfire.PacketRouter;
import org.jivesoftware.openfire.XMPPServer;
import org.jivesoftware.openfire.group.GroupJID;
import org.jivesoftware.openfire.muc.*;
import org.jivesoftware.util.JiveConstants;
import org.jivesoftware.util.JiveGlobals;
import org.jivesoftware.util.LinkedList;
import org.jivesoftware.util.StringUtils;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.xmpp.packet.JID;

/**
 * A manager responsible for ensuring room persistence. There are different ways to make a room
 * persistent. The first attempt will be to save the room in a relation database. If for some reason
 * the room can't be saved in the database an alternative repository will be used to save the room
 * such as XML files.&lt;p&gt;
 *
 * After the problem with the database has been solved, the information saved in the XML files will
 * be moved to the database.
 *
 * @author Gaston Dombiak
 */
<span class="nc" id="L52">public class MUCPersistenceManager {</span>

<span class="nc" id="L54">    private static final Logger Log = LoggerFactory.getLogger(MUCPersistenceManager.class);</span>
    
    // property name for optional number of days to limit persistent MUC history during reload (OF-764)
    private static final String MUC_HISTORY_RELOAD_LIMIT = &quot;xmpp.muc.history.reload.limit&quot;;

    private static final String GET_RESERVED_NAME =
        &quot;SELECT nickname FROM ofMucMember WHERE roomID=? AND jid=?&quot;;
    private static final String LOAD_ROOM =
        &quot;SELECT roomID, creationDate, modificationDate, naturalName, description, lockedDate, &quot; +
        &quot;emptyDate, canChangeSubject, maxUsers, publicRoom, moderated, membersOnly, canInvite, &quot; +
        &quot;roomPassword, canDiscoverJID, logEnabled, subject, rolesToBroadcast, useReservedNick, &quot; +
        &quot;canChangeNick, canRegister, allowpm FROM ofMucRoom WHERE serviceID=? AND name=?&quot;;
    private static final String LOAD_AFFILIATIONS =
        &quot;SELECT jid, affiliation FROM ofMucAffiliation WHERE roomID=?&quot;;
    private static final String LOAD_MEMBERS =
        &quot;SELECT jid, nickname FROM ofMucMember WHERE roomID=?&quot;;
    private static final String LOAD_HISTORY =
        &quot;SELECT sender, nickname, logTime, subject, body, stanza FROM ofMucConversationLog &quot; +
        &quot;WHERE logTime&gt;? AND roomID=? AND (nickname IS NOT NULL OR subject IS NOT NULL) ORDER BY logTime&quot;;
    private static final String LOAD_ALL_ROOMS =
        &quot;SELECT roomID, creationDate, modificationDate, name, naturalName, description, &quot; +
        &quot;lockedDate, emptyDate, canChangeSubject, maxUsers, publicRoom, moderated, membersOnly, &quot; +
        &quot;canInvite, roomPassword, canDiscoverJID, logEnabled, subject, rolesToBroadcast, &quot; +
        &quot;useReservedNick, canChangeNick, canRegister, allowpm &quot; +
        &quot;FROM ofMucRoom WHERE serviceID=? AND (emptyDate IS NULL or emptyDate &gt; ?)&quot;;
    private static final String LOAD_ALL_AFFILIATIONS =
        &quot;SELECT ofMucAffiliation.roomID,ofMucAffiliation.jid,ofMucAffiliation.affiliation &quot; +
        &quot;FROM ofMucAffiliation,ofMucRoom WHERE ofMucAffiliation.roomID = ofMucRoom.roomID AND ofMucRoom.serviceID=?&quot;;
    private static final String LOAD_ALL_MEMBERS =
        &quot;SELECT ofMucMember.roomID,ofMucMember.jid,ofMucMember.nickname FROM ofMucMember,ofMucRoom &quot; +
        &quot;WHERE ofMucMember.roomID = ofMucRoom.roomID AND ofMucRoom.serviceID=?&quot;;
    private static final String LOAD_ALL_HISTORY =
        &quot;SELECT ofMucConversationLog.roomID, ofMucConversationLog.sender, ofMucConversationLog.nickname, &quot; +
        &quot;ofMucConversationLog.logTime, ofMucConversationLog.subject, ofMucConversationLog.body, ofMucConversationLog.stanza FROM &quot; +
        &quot;ofMucConversationLog, ofMucRoom WHERE ofMucConversationLog.roomID = ofMucRoom.roomID AND &quot; +
        &quot;ofMucRoom.serviceID=? AND ofMucConversationLog.logTime&gt;? AND (ofMucConversationLog.nickname IS NOT NULL &quot; +
        &quot;OR ofMucConversationLog.subject IS NOT NULL) ORDER BY ofMucConversationLog.logTime&quot;;
    private static final String UPDATE_ROOM =
        &quot;UPDATE ofMucRoom SET modificationDate=?, naturalName=?, description=?, &quot; +
        &quot;canChangeSubject=?, maxUsers=?, publicRoom=?, moderated=?, membersOnly=?, &quot; +
        &quot;canInvite=?, roomPassword=?, canDiscoverJID=?, logEnabled=?, rolesToBroadcast=?, &quot; +
        &quot;useReservedNick=?, canChangeNick=?, canRegister=?, allowpm=? WHERE roomID=?&quot;;
    private static final String ADD_ROOM = 
        &quot;INSERT INTO ofMucRoom (serviceID, roomID, creationDate, modificationDate, name, naturalName, &quot; +
        &quot;description, lockedDate, emptyDate, canChangeSubject, maxUsers, publicRoom, moderated, &quot; +
        &quot;membersOnly, canInvite, roomPassword, canDiscoverJID, logEnabled, subject, &quot; +
        &quot;rolesToBroadcast, useReservedNick, canChangeNick, canRegister, allowpm) VALUES (?,?,?,?,?,?,?,?,?,&quot; +
            &quot;?,?,?,?,?,?,?,?,?,?,?,?,?,?,?)&quot;;
    private static final String UPDATE_SUBJECT =
        &quot;UPDATE ofMucRoom SET subject=? WHERE roomID=?&quot;;
    private static final String UPDATE_LOCK =
        &quot;UPDATE ofMucRoom SET lockedDate=? WHERE roomID=?&quot;;
    private static final String UPDATE_EMPTYDATE =
        &quot;UPDATE ofMucRoom SET emptyDate=? WHERE roomID=?&quot;;
    private static final String DELETE_ROOM =
        &quot;DELETE FROM ofMucRoom WHERE roomID=?&quot;;
    private static final String DELETE_AFFILIATIONS =
        &quot;DELETE FROM ofMucAffiliation WHERE roomID=?&quot;;
    private static final String DELETE_MEMBERS =
        &quot;DELETE FROM ofMucMember WHERE roomID=?&quot;;
    private static final String ADD_MEMBER =
        &quot;INSERT INTO ofMucMember (roomID,jid,nickname) VALUES (?,?,?)&quot;;
    private static final String UPDATE_MEMBER =
        &quot;UPDATE ofMucMember SET nickname=? WHERE roomID=? AND jid=?&quot;;
    private static final String DELETE_MEMBER =
        &quot;DELETE FROM ofMucMember WHERE roomID=? AND jid=?&quot;;
    private static final String ADD_AFFILIATION =
        &quot;INSERT INTO ofMucAffiliation (roomID,jid,affiliation) VALUES (?,?,?)&quot;;
    private static final String UPDATE_AFFILIATION =
        &quot;UPDATE ofMucAffiliation SET affiliation=? WHERE roomID=? AND jid=?&quot;;
    private static final String DELETE_AFFILIATION =
        &quot;DELETE FROM ofMucAffiliation WHERE roomID=? AND jid=?&quot;;
    private static final String DELETE_USER_MEMBER =
        &quot;DELETE FROM ofMucMember WHERE jid=?&quot;;
    private static final String DELETE_USER_MUCAFFILIATION =
        &quot;DELETE FROM ofMucAffiliation WHERE jid=?&quot;;
    private static final String ADD_CONVERSATION_LOG =
        &quot;INSERT INTO ofMucConversationLog (roomID,messageID,sender,nickname,logTime,subject,body,stanza) VALUES (?,?,?,?,?,?,?,?)&quot;;

    /* Map of subdomains to their associated properties */
<span class="nc" id="L134">    private static ConcurrentHashMap&lt;String,MUCServiceProperties&gt; propertyMaps = new ConcurrentHashMap&lt;&gt;();</span>

    /**
     * Returns the reserved room nickname for the bare JID in a given room or null if none.
     *
     * @param room the room where the user would like to obtain his reserved nickname. 
     * @param bareJID The bare jid of the user of which you'd like to obtain his reserved nickname.
     * @return the reserved room nickname for the bare JID or null if none.
     */
    public static String getReservedNickname(MUCRoom room, String bareJID) {
<span class="nc" id="L144">        Connection con = null;</span>
<span class="nc" id="L145">        PreparedStatement pstmt = null;</span>
<span class="nc" id="L146">        ResultSet rs = null;</span>
<span class="nc" id="L147">        String answer = null;</span>
        try {
<span class="nc" id="L149">            con = DbConnectionManager.getConnection();</span>
<span class="nc" id="L150">            pstmt = con.prepareStatement(GET_RESERVED_NAME);</span>
<span class="nc" id="L151">            pstmt.setLong(1, room.getID());</span>
<span class="nc" id="L152">            pstmt.setString(2, bareJID);</span>
<span class="nc" id="L153">            rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L154" title="All 2 branches missed.">            if (rs.next()) {</span>
<span class="nc" id="L155">                answer = rs.getString(1);</span>
            }
        }
<span class="nc" id="L158">        catch (SQLException sqle) {</span>
<span class="nc" id="L159">            Log.error(sqle.getMessage(), sqle);</span>
        }
        finally {
<span class="nc" id="L162">            DbConnectionManager.closeConnection(rs, pstmt, con);</span>
<span class="nc" id="L163">        }</span>
<span class="nc" id="L164">        return answer;</span>
    }

    /**
     * Loads the room configuration from the database if the room was persistent.
     * 
     * @param room the room to load from the database if persistent
     */
    public static void loadFromDB(LocalMUCRoom room) {
<span class="nc" id="L173">        Connection con = null;</span>
<span class="nc" id="L174">        PreparedStatement pstmt = null;</span>
<span class="nc" id="L175">        ResultSet rs = null;</span>
        try {
<span class="nc" id="L177">            Long serviceID = XMPPServer.getInstance().getMultiUserChatManager().getMultiUserChatServiceID(room.getMUCService().getServiceName());</span>
<span class="nc" id="L178">            con = DbConnectionManager.getConnection();</span>
<span class="nc" id="L179">            pstmt = con.prepareStatement(LOAD_ROOM);</span>
<span class="nc" id="L180">            pstmt.setLong(1, serviceID);</span>
<span class="nc" id="L181">            pstmt.setString(2, room.getName());</span>
<span class="nc" id="L182">            rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L183" title="All 2 branches missed.">            if (!rs.next()) {</span>
<span class="nc" id="L184">                throw new IllegalArgumentException(&quot;Room &quot; + room.getName() + &quot; was not found in the database.&quot;);</span>
            }
<span class="nc" id="L186">            room.setID(rs.getLong(1));</span>
<span class="nc" id="L187">            room.setCreationDate(new Date(Long.parseLong(rs.getString(2).trim()))); // creation date</span>
<span class="nc" id="L188">            room.setModificationDate(new Date(Long.parseLong(rs.getString(3).trim()))); // modification date</span>
<span class="nc" id="L189">            room.setNaturalLanguageName(rs.getString(4));</span>
<span class="nc" id="L190">            room.setDescription(rs.getString(5));</span>
<span class="nc" id="L191">            room.setLockedDate(new Date(Long.parseLong(rs.getString(6).trim())));</span>
<span class="nc bnc" id="L192" title="All 2 branches missed.">            if (rs.getString(7) != null) {</span>
<span class="nc" id="L193">                room.setEmptyDate(new Date(Long.parseLong(rs.getString(7).trim())));</span>
            }
            else {
<span class="nc" id="L196">                room.setEmptyDate(null);</span>
            }
<span class="nc bnc" id="L198" title="All 2 branches missed.">            room.setCanOccupantsChangeSubject(rs.getInt(8) == 1);</span>
<span class="nc" id="L199">            room.setMaxUsers(rs.getInt(9));</span>
<span class="nc bnc" id="L200" title="All 2 branches missed.">            room.setPublicRoom(rs.getInt(10) == 1);</span>
<span class="nc bnc" id="L201" title="All 2 branches missed.">            room.setModerated(rs.getInt(11) == 1);</span>
<span class="nc bnc" id="L202" title="All 2 branches missed.">            room.setMembersOnly(rs.getInt(12) == 1);</span>
<span class="nc bnc" id="L203" title="All 2 branches missed.">            room.setCanOccupantsInvite(rs.getInt(13) == 1);</span>
<span class="nc" id="L204">            room.setPassword(rs.getString(14));</span>
<span class="nc bnc" id="L205" title="All 2 branches missed.">            room.setCanAnyoneDiscoverJID(rs.getInt(15) == 1);</span>
<span class="nc bnc" id="L206" title="All 2 branches missed.">            room.setLogEnabled(rs.getInt(16) == 1);</span>
<span class="nc" id="L207">            room.setSubject(rs.getString(17));</span>
<span class="nc" id="L208">            List&lt;String&gt; rolesToBroadcast = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L209">            String roles = StringUtils.zeroPadString(Integer.toBinaryString(rs.getInt(18)), 3);</span>
<span class="nc bnc" id="L210" title="All 2 branches missed.">            if (roles.charAt(0) == '1') {</span>
<span class="nc" id="L211">                rolesToBroadcast.add(&quot;moderator&quot;);</span>
            }
<span class="nc bnc" id="L213" title="All 2 branches missed.">            if (roles.charAt(1) == '1') {</span>
<span class="nc" id="L214">                rolesToBroadcast.add(&quot;participant&quot;);</span>
            }
<span class="nc bnc" id="L216" title="All 2 branches missed.">            if (roles.charAt(2) == '1') {</span>
<span class="nc" id="L217">                rolesToBroadcast.add(&quot;visitor&quot;);</span>
            }
<span class="nc" id="L219">            room.setRolesToBroadcastPresence(rolesToBroadcast);</span>
<span class="nc bnc" id="L220" title="All 2 branches missed.">            room.setLoginRestrictedToNickname(rs.getInt(19) == 1);</span>
<span class="nc bnc" id="L221" title="All 2 branches missed.">            room.setChangeNickname(rs.getInt(20) == 1);</span>
<span class="nc bnc" id="L222" title="All 2 branches missed.">            room.setRegistrationEnabled(rs.getInt(21) == 1);</span>
<span class="nc bnc" id="L223" title="All 4 branches missed.">            switch (rs.getInt(22)) // null returns 0.</span>
            {
                default:
<span class="nc" id="L226">                case 0: room.setCanSendPrivateMessage( &quot;anyone&quot;       ); break;</span>
<span class="nc" id="L227">                case 1: room.setCanSendPrivateMessage( &quot;participants&quot; ); break;</span>
<span class="nc" id="L228">                case 2: room.setCanSendPrivateMessage( &quot;moderators&quot;   ); break;</span>
<span class="nc" id="L229">                case 3: room.setCanSendPrivateMessage( &quot;none&quot;         ); break;</span>
            }
<span class="nc" id="L231">            room.setPersistent(true);</span>
<span class="nc" id="L232">            DbConnectionManager.fastcloseStmt(rs, pstmt);</span>

            // Recreate the history only for the rooms that have the conversation logging
            // enabled
<span class="nc bnc" id="L236" title="All 2 branches missed.">            if (room.isLogEnabled()) {</span>
<span class="nc" id="L237">                pstmt = con.prepareStatement(LOAD_HISTORY);</span>
                // Reload the history, using &quot;muc.history.reload.limit&quot; (days); defaults to 2
<span class="nc" id="L239">                int reloadLimitDays = JiveGlobals.getIntProperty(MUC_HISTORY_RELOAD_LIMIT, 2);</span>
<span class="nc" id="L240">                long from = System.currentTimeMillis() - (BigInteger.valueOf(86400000).multiply(BigInteger.valueOf(reloadLimitDays))).longValue();</span>
<span class="nc" id="L241">                pstmt.setString(1, StringUtils.dateToMillis(new Date(from)));</span>
<span class="nc" id="L242">                pstmt.setLong(2, room.getID());</span>
<span class="nc" id="L243">                rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L244" title="All 2 branches missed.">                while (rs.next()) {</span>
<span class="nc" id="L245">                    String senderJID = rs.getString(1);</span>
<span class="nc" id="L246">                    String nickname = rs.getString(2);</span>
<span class="nc" id="L247">                    Date sentDate = new Date(Long.parseLong(rs.getString(3).trim()));</span>
<span class="nc" id="L248">                    String subject = rs.getString(4);</span>
<span class="nc" id="L249">                    String body = rs.getString(5);</span>
<span class="nc" id="L250">                    String stanza = rs.getString(6);</span>
<span class="nc" id="L251">                    room.getRoomHistory().addOldMessage(senderJID, nickname, sentDate, subject,</span>
                            body, stanza);
<span class="nc" id="L253">                }</span>
            }
<span class="nc" id="L255">            DbConnectionManager.fastcloseStmt(rs, pstmt);</span>

            // If the room does not include the last subject in the history then recreate one if
            // possible
<span class="nc bnc" id="L259" title="All 4 branches missed.">            if (!room.getRoomHistory().hasChangedSubject() &amp;&amp; room.getSubject() != null &amp;&amp;</span>
<span class="nc bnc" id="L260" title="All 2 branches missed.">                    room.getSubject().length() &gt; 0) {</span>
<span class="nc" id="L261">                room.getRoomHistory().addOldMessage(room.getRole().getRoleAddress().toString(),</span>
<span class="nc" id="L262">                        null, room.getModificationDate(), room.getSubject(), null, null);</span>
            }

<span class="nc" id="L265">            pstmt = con.prepareStatement(LOAD_AFFILIATIONS);</span>
<span class="nc" id="L266">            pstmt.setLong(1, room.getID());</span>
<span class="nc" id="L267">            rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L268" title="All 2 branches missed.">            while (rs.next()) {</span>
                // might be a group JID
<span class="nc" id="L270">                JID affiliationJID = GroupJID.fromString(rs.getString(1));</span>
<span class="nc" id="L271">                MUCRole.Affiliation affiliation = MUCRole.Affiliation.valueOf(rs.getInt(2));</span>
                try {
<span class="nc bnc" id="L273" title="All 4 branches missed.">                    switch (affiliation) {</span>
                        case owner:
<span class="nc" id="L275">                            room.addOwner(affiliationJID, room.getRole());</span>
<span class="nc" id="L276">                            break;</span>
                        case admin:
<span class="nc" id="L278">                            room.addAdmin(affiliationJID, room.getRole());</span>
<span class="nc" id="L279">                            break;</span>
                        case outcast:
<span class="nc" id="L281">                            room.addOutcast(affiliationJID, null, room.getRole());</span>
<span class="nc" id="L282">                            break;</span>
                        default:
<span class="nc" id="L284">                            Log.error(&quot;Unkown affiliation value &quot; + affiliation + &quot; for user &quot;</span>
<span class="nc" id="L285">                                    + affiliationJID.toBareJID() + &quot; in persistent room &quot; + room.getID());</span>
                    }
                }
<span class="nc" id="L288">                catch (Exception e) {</span>
<span class="nc" id="L289">                    Log.error(e.getMessage(), e);</span>
<span class="nc" id="L290">                }</span>
<span class="nc" id="L291">            }</span>
<span class="nc" id="L292">            DbConnectionManager.fastcloseStmt(rs, pstmt);</span>
            
<span class="nc" id="L294">            pstmt = con.prepareStatement(LOAD_MEMBERS);</span>
<span class="nc" id="L295">            pstmt.setLong(1, room.getID());</span>
<span class="nc" id="L296">            rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L297" title="All 2 branches missed.">            while (rs.next()) {</span>
                try {
<span class="nc" id="L299">                    room.addMember(new JID(rs.getString(1)), rs.getString(2), room.getRole());</span>
                }
<span class="nc" id="L301">                catch (Exception e) {</span>
<span class="nc" id="L302">                    Log.error(e.getMessage(), e);</span>
<span class="nc" id="L303">                }</span>
            }
            // Set now that the room's configuration is updated in the database. Note: We need to
            // set this now since otherwise the room's affiliations will be saved to the database
            // &quot;again&quot; while adding them to the room!
<span class="nc" id="L308">            room.setSavedToDB(true);</span>
<span class="nc bnc" id="L309" title="All 2 branches missed.">            if (room.getEmptyDate() == null) {</span>
                // The service process was killed somehow while the room was being used. Since
                // the room won't have occupants at this time we need to set the best date when
                // the last occupant left the room that we can
<span class="nc" id="L313">                room.setEmptyDate(new Date());</span>
            }
        }
<span class="nc" id="L316">        catch (SQLException sqle) {</span>
<span class="nc" id="L317">            Log.error(sqle.getMessage(), sqle);</span>
        }
        finally {
<span class="nc" id="L320">            DbConnectionManager.closeConnection(rs, pstmt, con);</span>
<span class="nc" id="L321">        }</span>
<span class="nc" id="L322">    }</span>

    /**
     * Save the room configuration to the DB.
     * 
     * @param room The room to save its configuration.
     */
    public static void saveToDB(LocalMUCRoom room) {
<span class="nc" id="L330">        Connection con = null;</span>
<span class="nc" id="L331">        PreparedStatement pstmt = null;</span>
        try {
<span class="nc" id="L333">            con = DbConnectionManager.getConnection();</span>
<span class="nc bnc" id="L334" title="All 2 branches missed.">            if (room.wasSavedToDB()) {</span>
<span class="nc" id="L335">                pstmt = con.prepareStatement(UPDATE_ROOM);</span>
<span class="nc" id="L336">                pstmt.setString(1, StringUtils.dateToMillis(room.getModificationDate()));</span>
<span class="nc" id="L337">                pstmt.setString(2, room.getNaturalLanguageName());</span>
<span class="nc" id="L338">                pstmt.setString(3, room.getDescription());</span>
<span class="nc bnc" id="L339" title="All 2 branches missed.">                pstmt.setInt(4, (room.canOccupantsChangeSubject() ? 1 : 0));</span>
<span class="nc" id="L340">                pstmt.setInt(5, room.getMaxUsers());</span>
<span class="nc bnc" id="L341" title="All 2 branches missed.">                pstmt.setInt(6, (room.isPublicRoom() ? 1 : 0));</span>
<span class="nc bnc" id="L342" title="All 2 branches missed.">                pstmt.setInt(7, (room.isModerated() ? 1 : 0));</span>
<span class="nc bnc" id="L343" title="All 2 branches missed.">                pstmt.setInt(8, (room.isMembersOnly() ? 1 : 0));</span>
<span class="nc bnc" id="L344" title="All 2 branches missed.">                pstmt.setInt(9, (room.canOccupantsInvite() ? 1 : 0));</span>
<span class="nc" id="L345">                pstmt.setString(10, room.getPassword());</span>
<span class="nc bnc" id="L346" title="All 2 branches missed.">                pstmt.setInt(11, (room.canAnyoneDiscoverJID() ? 1 : 0));</span>
<span class="nc bnc" id="L347" title="All 2 branches missed.">                pstmt.setInt(12, (room.isLogEnabled() ? 1 : 0));</span>
<span class="nc" id="L348">                pstmt.setInt(13, marshallRolesToBroadcast(room));</span>
<span class="nc bnc" id="L349" title="All 2 branches missed.">                pstmt.setInt(14, (room.isLoginRestrictedToNickname() ? 1 : 0));</span>
<span class="nc bnc" id="L350" title="All 2 branches missed.">                pstmt.setInt(15, (room.canChangeNickname() ? 1 : 0));</span>
<span class="nc bnc" id="L351" title="All 2 branches missed.">                pstmt.setInt(16, (room.isRegistrationEnabled() ? 1 : 0));</span>
<span class="nc bnc" id="L352" title="All 17 branches missed.">                switch (room.canSendPrivateMessage())</span>
                {
                    default:
<span class="nc" id="L355">                    case &quot;anyone&quot;:       pstmt.setInt(17, 0); break;</span>
<span class="nc" id="L356">                    case &quot;participants&quot;: pstmt.setInt(17, 1); break;</span>
<span class="nc" id="L357">                    case &quot;moderators&quot;:   pstmt.setInt(17, 2); break;</span>
<span class="nc" id="L358">                    case &quot;none&quot;:         pstmt.setInt(17, 3); break;</span>
                }
<span class="nc" id="L360">                pstmt.setLong(18, room.getID());</span>
<span class="nc" id="L361">                pstmt.executeUpdate();</span>
            }
            else {
<span class="nc" id="L364">                pstmt = con.prepareStatement(ADD_ROOM);</span>
<span class="nc" id="L365">                pstmt.setLong(1, XMPPServer.getInstance().getMultiUserChatManager().getMultiUserChatServiceID(room.getMUCService().getServiceName()));</span>
<span class="nc" id="L366">                pstmt.setLong(2, room.getID());</span>
<span class="nc" id="L367">                pstmt.setString(3, StringUtils.dateToMillis(room.getCreationDate()));</span>
<span class="nc" id="L368">                pstmt.setString(4, StringUtils.dateToMillis(room.getModificationDate()));</span>
<span class="nc" id="L369">                pstmt.setString(5, room.getName());</span>
<span class="nc" id="L370">                pstmt.setString(6, room.getNaturalLanguageName());</span>
<span class="nc" id="L371">                pstmt.setString(7, room.getDescription());</span>
<span class="nc" id="L372">                pstmt.setString(8, StringUtils.dateToMillis(room.getLockedDate()));</span>
<span class="nc" id="L373">                Date emptyDate = room.getEmptyDate();</span>
<span class="nc bnc" id="L374" title="All 2 branches missed.">                if (emptyDate == null) {</span>
<span class="nc" id="L375">                    pstmt.setString(9, null);</span>
                }
                else {
<span class="nc" id="L378">                    pstmt.setString(9, StringUtils.dateToMillis(emptyDate));</span>
                }
<span class="nc bnc" id="L380" title="All 2 branches missed.">                pstmt.setInt(10, (room.canOccupantsChangeSubject() ? 1 : 0));</span>
<span class="nc" id="L381">                pstmt.setInt(11, room.getMaxUsers());</span>
<span class="nc bnc" id="L382" title="All 2 branches missed.">                pstmt.setInt(12, (room.isPublicRoom() ? 1 : 0));</span>
<span class="nc bnc" id="L383" title="All 2 branches missed.">                pstmt.setInt(13, (room.isModerated() ? 1 : 0));</span>
<span class="nc bnc" id="L384" title="All 2 branches missed.">                pstmt.setInt(14, (room.isMembersOnly() ? 1 : 0));</span>
<span class="nc bnc" id="L385" title="All 2 branches missed.">                pstmt.setInt(15, (room.canOccupantsInvite() ? 1 : 0));</span>
<span class="nc" id="L386">                pstmt.setString(16, room.getPassword());</span>
<span class="nc bnc" id="L387" title="All 2 branches missed.">                pstmt.setInt(17, (room.canAnyoneDiscoverJID() ? 1 : 0));</span>
<span class="nc bnc" id="L388" title="All 2 branches missed.">                pstmt.setInt(18, (room.isLogEnabled() ? 1 : 0));</span>
<span class="nc" id="L389">                pstmt.setString(19, room.getSubject());</span>
<span class="nc" id="L390">                pstmt.setInt(20, marshallRolesToBroadcast(room));</span>
<span class="nc bnc" id="L391" title="All 2 branches missed.">                pstmt.setInt(21, (room.isLoginRestrictedToNickname() ? 1 : 0));</span>
<span class="nc bnc" id="L392" title="All 2 branches missed.">                pstmt.setInt(22, (room.canChangeNickname() ? 1 : 0));</span>
<span class="nc bnc" id="L393" title="All 2 branches missed.">                pstmt.setInt(23, (room.isRegistrationEnabled() ? 1 : 0));</span>
<span class="nc bnc" id="L394" title="All 17 branches missed.">                switch (room.canSendPrivateMessage())</span>
                {
                    default:
<span class="nc" id="L397">                    case &quot;anyone&quot;:       pstmt.setInt(24, 0); break;</span>
<span class="nc" id="L398">                    case &quot;participants&quot;: pstmt.setInt(24, 1); break;</span>
<span class="nc" id="L399">                    case &quot;moderators&quot;:   pstmt.setInt(24, 2); break;</span>
<span class="nc" id="L400">                    case &quot;none&quot;:         pstmt.setInt(24, 3); break;</span>
                }
<span class="nc" id="L402">                pstmt.executeUpdate();</span>
            }
        }
<span class="nc" id="L405">        catch (SQLException sqle) {</span>
<span class="nc" id="L406">            Log.error(sqle.getMessage(), sqle);</span>
        }
        finally {
<span class="nc" id="L409">            DbConnectionManager.closeConnection(pstmt, con);</span>
<span class="nc" id="L410">        }</span>
<span class="nc" id="L411">    }</span>

    /**
     * Removes the room configuration and its affiliates from the database.
     * 
     * @param room the room to remove from the database.
     */
    public static void deleteFromDB(MUCRoom room) {
<span class="nc bnc" id="L419" title="All 4 branches missed.">        if (!room.isPersistent() || !room.wasSavedToDB()) {</span>
<span class="nc" id="L420">            return;</span>
        }
<span class="nc" id="L422">        Connection con = null;</span>
<span class="nc" id="L423">        PreparedStatement pstmt = null;</span>
<span class="nc" id="L424">        boolean abortTransaction = false;</span>
        try {
<span class="nc" id="L426">            con = DbConnectionManager.getTransactionConnection();</span>
<span class="nc" id="L427">            pstmt = con.prepareStatement(DELETE_AFFILIATIONS);</span>
<span class="nc" id="L428">            pstmt.setLong(1, room.getID());</span>
<span class="nc" id="L429">            pstmt.executeUpdate();</span>
<span class="nc" id="L430">            DbConnectionManager.fastcloseStmt(pstmt);</span>

<span class="nc" id="L432">            pstmt = con.prepareStatement(DELETE_MEMBERS);</span>
<span class="nc" id="L433">            pstmt.setLong(1, room.getID());</span>
<span class="nc" id="L434">            pstmt.executeUpdate();</span>
<span class="nc" id="L435">            DbConnectionManager.fastcloseStmt(pstmt);</span>

<span class="nc" id="L437">            pstmt = con.prepareStatement(DELETE_ROOM);</span>
<span class="nc" id="L438">            pstmt.setLong(1, room.getID());</span>
<span class="nc" id="L439">            pstmt.executeUpdate();</span>

            // Update the room (in memory) to indicate the it's no longer in the database.
<span class="nc" id="L442">            room.setSavedToDB(false);</span>
        }
<span class="nc" id="L444">        catch (SQLException sqle) {</span>
<span class="nc" id="L445">            Log.error(sqle.getMessage(), sqle);</span>
<span class="nc" id="L446">            abortTransaction = true;</span>
        }
        finally {
<span class="nc" id="L449">            DbConnectionManager.closeStatement(pstmt);</span>
<span class="nc" id="L450">            DbConnectionManager.closeTransactionConnection(con, abortTransaction);</span>
<span class="nc" id="L451">        }</span>
<span class="nc" id="L452">    }</span>

    /**
     * Loads all the rooms that had occupants after a given date from the database. This query
     * will be executed only when the service is starting up.
     *
     * @param chatserver the chat server that will hold the loaded rooms.
     * @param emptyDate rooms that hadn't been used before this date won't be loaded.
     * @param packetRouter the PacketRouter that loaded rooms will use to send packets.
     * @return a collection with all the persistent rooms.
     */
    public static Collection&lt;LocalMUCRoom&gt; loadRoomsFromDB(MultiUserChatService chatserver, Date emptyDate, PacketRouter packetRouter) {
<span class="nc" id="L464">        Long serviceID = XMPPServer.getInstance().getMultiUserChatManager().getMultiUserChatServiceID(chatserver.getServiceName());</span>

        final Map&lt;Long, LocalMUCRoom&gt; rooms;
        try {
<span class="nc" id="L468">            rooms = loadRooms(serviceID, emptyDate, chatserver, packetRouter);</span>
<span class="nc" id="L469">            loadHistory(serviceID, rooms);</span>
<span class="nc" id="L470">            loadAffiliations(serviceID, rooms);</span>
<span class="nc" id="L471">            loadMembers(serviceID, rooms);</span>
        }
<span class="nc" id="L473">        catch (SQLException sqle) {</span>
<span class="nc" id="L474">            Log.error(&quot;A database error prevented MUC rooms to be loaded from the database.&quot;, sqle);</span>
<span class="nc" id="L475">            return Collections.emptyList();</span>
<span class="nc" id="L476">        }</span>

        // Set now that the room's configuration is updated in the database. Note: We need to
        // set this now since otherwise the room's affiliations will be saved to the database
        // &quot;again&quot; while adding them to the room!
<span class="nc bnc" id="L481" title="All 2 branches missed.">        for (final MUCRoom room : rooms.values()) {</span>
<span class="nc" id="L482">            room.setSavedToDB(true);</span>
<span class="nc bnc" id="L483" title="All 2 branches missed.">            if (room.getEmptyDate() == null) {</span>
                // The service process was killed somehow while the room was being used. Since
                // the room won't have occupants at this time we need to set the best date when
                // the last occupant left the room that we can
<span class="nc" id="L487">                room.setEmptyDate(new Date());</span>
            }
<span class="nc" id="L489">        }</span>

<span class="nc" id="L491">        return rooms.values();</span>
    }

    private static Map&lt;Long, LocalMUCRoom&gt; loadRooms(Long serviceID, Date emptyDate, MultiUserChatService chatserver, PacketRouter packetRouter) throws SQLException {
<span class="nc" id="L495">        final Map&lt;Long, LocalMUCRoom&gt; rooms = new HashMap&lt;&gt;();</span>

<span class="nc" id="L497">        Connection connection = null;</span>
<span class="nc" id="L498">        PreparedStatement statement = null;</span>
<span class="nc" id="L499">        ResultSet resultSet = null;</span>
        try {
<span class="nc" id="L501">            connection = DbConnectionManager.getConnection();</span>
<span class="nc" id="L502">            statement = connection.prepareStatement(LOAD_ALL_ROOMS);</span>
<span class="nc" id="L503">            statement.setLong(1, serviceID);</span>
<span class="nc" id="L504">            statement.setString(2, StringUtils.dateToMillis(emptyDate));</span>
<span class="nc" id="L505">            resultSet = statement.executeQuery();</span>

<span class="nc bnc" id="L507" title="All 2 branches missed.">            while (resultSet.next()) {</span>
                try {
<span class="nc" id="L509">                    LocalMUCRoom room = new LocalMUCRoom(chatserver, resultSet.getString(4), packetRouter);</span>
<span class="nc" id="L510">                    room.setID(resultSet.getLong(1));</span>
<span class="nc" id="L511">                    room.setCreationDate(new Date(Long.parseLong(resultSet.getString(2).trim()))); // creation date</span>
<span class="nc" id="L512">                    room.setModificationDate(new Date(Long.parseLong(resultSet.getString(3).trim()))); // modification date</span>
<span class="nc" id="L513">                    room.setNaturalLanguageName(resultSet.getString(5));</span>
<span class="nc" id="L514">                    room.setDescription(resultSet.getString(6));</span>
<span class="nc" id="L515">                    room.setLockedDate(new Date(Long.parseLong(resultSet.getString(7).trim())));</span>
<span class="nc bnc" id="L516" title="All 2 branches missed.">                    if (resultSet.getString(8) != null) {</span>
<span class="nc" id="L517">                        room.setEmptyDate(new Date(Long.parseLong(resultSet.getString(8).trim())));</span>
                    }
                    else {
<span class="nc" id="L520">                        room.setEmptyDate(null);</span>
                    }
<span class="nc bnc" id="L522" title="All 2 branches missed.">                    room.setCanOccupantsChangeSubject(resultSet.getInt(9) == 1);</span>
<span class="nc" id="L523">                    room.setMaxUsers(resultSet.getInt(10));</span>
<span class="nc bnc" id="L524" title="All 2 branches missed.">                    room.setPublicRoom(resultSet.getInt(11) == 1);</span>
<span class="nc bnc" id="L525" title="All 2 branches missed.">                    room.setModerated(resultSet.getInt(12) == 1);</span>
<span class="nc bnc" id="L526" title="All 2 branches missed.">                    room.setMembersOnly(resultSet.getInt(13) == 1);</span>
<span class="nc bnc" id="L527" title="All 2 branches missed.">                    room.setCanOccupantsInvite(resultSet.getInt(14) == 1);</span>
<span class="nc" id="L528">                    room.setPassword(resultSet.getString(15));</span>
<span class="nc bnc" id="L529" title="All 2 branches missed.">                    room.setCanAnyoneDiscoverJID(resultSet.getInt(16) == 1);</span>
<span class="nc bnc" id="L530" title="All 2 branches missed.">                    room.setLogEnabled(resultSet.getInt(17) == 1);</span>
<span class="nc" id="L531">                    room.setSubject(resultSet.getString(18));</span>
<span class="nc" id="L532">                    List&lt;String&gt; rolesToBroadcast = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L533">                    String roles = StringUtils.zeroPadString(Integer.toBinaryString(resultSet.getInt(19)), 3);</span>
<span class="nc bnc" id="L534" title="All 2 branches missed.">                    if (roles.charAt(0) == '1') {</span>
<span class="nc" id="L535">                        rolesToBroadcast.add(&quot;moderator&quot;);</span>
                    }
<span class="nc bnc" id="L537" title="All 2 branches missed.">                    if (roles.charAt(1) == '1') {</span>
<span class="nc" id="L538">                        rolesToBroadcast.add(&quot;participant&quot;);</span>
                    }
<span class="nc bnc" id="L540" title="All 2 branches missed.">                    if (roles.charAt(2) == '1') {</span>
<span class="nc" id="L541">                        rolesToBroadcast.add(&quot;visitor&quot;);</span>
                    }
<span class="nc" id="L543">                    room.setRolesToBroadcastPresence(rolesToBroadcast);</span>
<span class="nc bnc" id="L544" title="All 2 branches missed.">                    room.setLoginRestrictedToNickname(resultSet.getInt(20) == 1);</span>
<span class="nc bnc" id="L545" title="All 2 branches missed.">                    room.setChangeNickname(resultSet.getInt(21) == 1);</span>
<span class="nc bnc" id="L546" title="All 2 branches missed.">                    room.setRegistrationEnabled(resultSet.getInt(22) == 1);</span>
<span class="nc bnc" id="L547" title="All 4 branches missed.">                    switch (resultSet.getInt(23)) // null returns 0.</span>
                    {
                        default:
<span class="nc" id="L550">                        case 0: room.setCanSendPrivateMessage( &quot;anyone&quot;       ); break;</span>
<span class="nc" id="L551">                        case 1: room.setCanSendPrivateMessage( &quot;participants&quot; ); break;</span>
<span class="nc" id="L552">                        case 2: room.setCanSendPrivateMessage( &quot;moderators&quot;   ); break;</span>
<span class="nc" id="L553">                        case 3: room.setCanSendPrivateMessage( &quot;none&quot;         ); break;</span>
                    }
<span class="nc" id="L555">                    room.setPersistent(true);</span>
<span class="nc" id="L556">                    rooms.put(room.getID(), room);</span>
<span class="nc" id="L557">                } catch (SQLException e) {</span>
<span class="nc" id="L558">                    Log.error(&quot;A database exception prevented one particular MUC room to be loaded from the database.&quot;, e);</span>
<span class="nc" id="L559">                }</span>
            }
        } finally {
<span class="nc" id="L562">            DbConnectionManager.closeConnection(resultSet, statement, connection);</span>
<span class="nc" id="L563">        }</span>

<span class="nc" id="L565">        return rooms;</span>
    }

    private static void loadHistory(Long serviceID, Map&lt;Long, LocalMUCRoom&gt; rooms) throws SQLException {
<span class="nc" id="L569">        Connection connection = null;</span>
<span class="nc" id="L570">        PreparedStatement statement = null;</span>
<span class="nc" id="L571">        ResultSet resultSet = null;</span>
        try {
<span class="nc" id="L573">            connection = DbConnectionManager.getConnection();</span>
<span class="nc" id="L574">            statement = connection.prepareStatement(LOAD_ALL_HISTORY);</span>

            // Reload the history, using &quot;muc.history.reload.limit&quot; (days) if present
<span class="nc" id="L577">            long from = 0;</span>
<span class="nc" id="L578">            String reloadLimit = JiveGlobals.getProperty(MUC_HISTORY_RELOAD_LIMIT);</span>
<span class="nc bnc" id="L579" title="All 2 branches missed.">            if (reloadLimit != null) {</span>
                // if the property is defined, but not numeric, default to 2 (days)
<span class="nc" id="L581">                int reloadLimitDays = JiveGlobals.getIntProperty(MUC_HISTORY_RELOAD_LIMIT, 2);</span>
<span class="nc" id="L582">                Log.warn(&quot;MUC history reload limit set to &quot; + reloadLimitDays + &quot; days&quot;);</span>
<span class="nc" id="L583">                from = System.currentTimeMillis() - (BigInteger.valueOf(86400000).multiply(BigInteger.valueOf(reloadLimitDays))).longValue();</span>
            }
<span class="nc" id="L585">            statement.setLong(1, serviceID);</span>
<span class="nc" id="L586">            statement.setString(2, StringUtils.dateToMillis(new Date(from)));</span>
<span class="nc" id="L587">            resultSet = statement.executeQuery();</span>

<span class="nc bnc" id="L589" title="All 2 branches missed.">            while (resultSet.next()) {</span>
                try {
<span class="nc" id="L591">                    LocalMUCRoom room = rooms.get(resultSet.getLong(1));</span>
                    // Skip to the next position if the room does not exist or if history is disabled
<span class="nc bnc" id="L593" title="All 4 branches missed.">                    if (room == null || !room.isLogEnabled()) {</span>
<span class="nc" id="L594">                        continue;</span>
                    }
<span class="nc" id="L596">                    String senderJID = resultSet.getString(2);</span>
<span class="nc" id="L597">                    String nickname  = resultSet.getString(3);</span>
<span class="nc" id="L598">                    Date sentDate    = new Date(Long.parseLong(resultSet.getString(4).trim()));</span>
<span class="nc" id="L599">                    String subject   = resultSet.getString(5);</span>
<span class="nc" id="L600">                    String body      = resultSet.getString(6);</span>
<span class="nc" id="L601">                    String stanza = resultSet.getString(7);</span>
<span class="nc" id="L602">                    room.getRoomHistory().addOldMessage(senderJID, nickname, sentDate, subject, body, stanza);</span>
<span class="nc" id="L603">                } catch (SQLException e) {</span>
<span class="nc" id="L604">                    Log.warn(&quot;A database exception prevented the history for one particular MUC room to be loaded from the database.&quot;, e);</span>
<span class="nc" id="L605">                }</span>
            }
        } finally {
<span class="nc" id="L608">            DbConnectionManager.closeConnection(resultSet, statement, connection);</span>
<span class="nc" id="L609">        }</span>

        // Add the last known room subject to the room history only for those rooms that still
        // don't have in their histories the last room subject
<span class="nc bnc" id="L613" title="All 2 branches missed.">        for (MUCRoom loadedRoom : rooms.values())</span>
        {
<span class="nc bnc" id="L615" title="All 2 branches missed.">            if (!loadedRoom.getRoomHistory().hasChangedSubject()</span>
<span class="nc bnc" id="L616" title="All 2 branches missed.">                &amp;&amp; loadedRoom.getSubject() != null</span>
<span class="nc bnc" id="L617" title="All 2 branches missed.">                &amp;&amp; loadedRoom.getSubject().length() &gt; 0)</span>
            {
<span class="nc" id="L619">                loadedRoom.getRoomHistory().addOldMessage(  loadedRoom.getRole().getRoleAddress().toString(),</span>
                                                            null,
<span class="nc" id="L621">                                                            loadedRoom.getModificationDate(),</span>
<span class="nc" id="L622">                                                            loadedRoom.getSubject(),</span>
                                                            null,
                                                            null);
            }
<span class="nc" id="L626">        }</span>
<span class="nc" id="L627">    }</span>

    private static void loadAffiliations(Long serviceID, Map&lt;Long, LocalMUCRoom&gt; rooms) throws SQLException {
<span class="nc" id="L630">        Connection connection = null;</span>
<span class="nc" id="L631">        PreparedStatement statement = null;</span>
<span class="nc" id="L632">        ResultSet resultSet = null;</span>
        try {
<span class="nc" id="L634">            connection = DbConnectionManager.getConnection();</span>
<span class="nc" id="L635">            statement = connection.prepareStatement(LOAD_ALL_AFFILIATIONS);</span>
<span class="nc" id="L636">            statement.setLong(1, serviceID);</span>
<span class="nc" id="L637">            resultSet = statement.executeQuery();</span>

<span class="nc bnc" id="L639" title="All 2 branches missed.">            while (resultSet.next()) {</span>
                try {
<span class="nc" id="L641">                    long roomID = resultSet.getLong(1);</span>
<span class="nc" id="L642">                    LocalMUCRoom room = rooms.get(roomID);</span>
                    // Skip to the next position if the room does not exist
<span class="nc bnc" id="L644" title="All 2 branches missed.">                    if (room == null) {</span>
<span class="nc" id="L645">                        continue;</span>
                    }

<span class="nc" id="L648">                    final MUCRole.Affiliation affiliation = MUCRole.Affiliation.valueOf(resultSet.getInt(3));</span>

<span class="nc" id="L650">                    final String jidValue = resultSet.getString(2);</span>
                    final JID affiliationJID;
                    try {
                        // might be a group JID
<span class="nc" id="L654">                        affiliationJID = GroupJID.fromString(jidValue);</span>
<span class="nc" id="L655">                    } catch (IllegalArgumentException ex) {</span>
<span class="nc" id="L656">                        Log.warn(&quot;An illegal JID ({}) was found in the database, &quot;</span>
                                + &quot;while trying to load all affiliations for room &quot;
                                + &quot;{}. The JID is ignored.&quot;
<span class="nc" id="L659">                                , new Object[] { jidValue, roomID });</span>
<span class="nc" id="L660">                        continue;</span>
<span class="nc" id="L661">                    }</span>

                    try {
<span class="nc bnc" id="L664" title="All 4 branches missed.">                        switch (affiliation) {</span>
                            case owner:
<span class="nc" id="L666">                                room.addOwner(affiliationJID, room.getRole());</span>
<span class="nc" id="L667">                                break;</span>
                            case admin:
<span class="nc" id="L669">                                room.addAdmin(affiliationJID, room.getRole());</span>
<span class="nc" id="L670">                                break;</span>
                            case outcast:
<span class="nc" id="L672">                                room.addOutcast(affiliationJID, null, room.getRole());</span>
<span class="nc" id="L673">                                break;</span>
                            default:
<span class="nc" id="L675">                                Log.error(&quot;Unknown affiliation value &quot; + affiliation + &quot; for user &quot; + affiliationJID + &quot; in persistent room &quot; + room.getID());</span>
                        }
<span class="nc" id="L677">                    } catch (ForbiddenException | ConflictException | NotAllowedException e) {</span>
<span class="nc" id="L678">                        Log.warn(&quot;An exception prevented affiliations to be added to the room with id &quot; + roomID, e);</span>
<span class="nc" id="L679">                    }</span>
<span class="nc" id="L680">                } catch (SQLException e) {</span>
<span class="nc" id="L681">                    Log.error(&quot;A database exception prevented affiliations for one particular MUC room to be loaded from the database.&quot;, e);</span>
<span class="nc" id="L682">                }</span>
            }

        } finally {
<span class="nc" id="L686">            DbConnectionManager.closeConnection(resultSet, statement, connection);</span>
<span class="nc" id="L687">        }</span>
<span class="nc" id="L688">    }</span>

    private static void loadMembers(Long serviceID, Map&lt;Long, LocalMUCRoom&gt; rooms) throws SQLException {
<span class="nc" id="L691">        Connection connection = null;</span>
<span class="nc" id="L692">        PreparedStatement statement = null;</span>
<span class="nc" id="L693">        ResultSet resultSet = null;</span>
<span class="nc" id="L694">        JID affiliationJID = null;</span>
        try {
<span class="nc" id="L696">            connection = DbConnectionManager.getConnection();</span>
<span class="nc" id="L697">            statement = connection.prepareStatement(LOAD_ALL_MEMBERS);</span>
<span class="nc" id="L698">            statement.setLong(1, serviceID);</span>
<span class="nc" id="L699">            resultSet = statement.executeQuery();</span>

<span class="nc bnc" id="L701" title="All 2 branches missed.">            while (resultSet.next()) {</span>
                try {
<span class="nc" id="L703">                    LocalMUCRoom room = rooms.get(resultSet.getLong(1));</span>
                    // Skip to the next position if the room does not exist
<span class="nc bnc" id="L705" title="All 2 branches missed.">                    if (room == null) {</span>
<span class="nc" id="L706">                        continue;</span>
                    }
                    try {
                        // might be a group JID
<span class="nc" id="L710">                        affiliationJID = GroupJID.fromString(resultSet.getString(2));</span>
<span class="nc" id="L711">                        room.addMember(affiliationJID, resultSet.getString(3), room.getRole());</span>
<span class="nc" id="L712">                    } catch (ForbiddenException | ConflictException e) {</span>
<span class="nc" id="L713">                        Log.warn(&quot;Unable to add member to room.&quot;, e);</span>
<span class="nc" id="L714">                    }</span>
<span class="nc" id="L715">                } catch (SQLException e) {</span>
<span class="nc" id="L716">                    Log.error(&quot;A database exception prevented members for one particular MUC room to be loaded from the database.&quot;, e);</span>
<span class="nc" id="L717">                }</span>
            }
        } finally {
<span class="nc" id="L720">            DbConnectionManager.closeConnection(resultSet, statement, connection);</span>
<span class="nc" id="L721">        }</span>
<span class="nc" id="L722">    }</span>

    /**
     * Updates the room's subject in the database. 
     * 
     * @param room the room to update its subject in the database.
     */
    public static void updateRoomSubject(MUCRoom room) {
<span class="nc bnc" id="L730" title="All 4 branches missed.">        if (!room.isPersistent() || !room.wasSavedToDB()) {</span>
<span class="nc" id="L731">            return;</span>
        }

<span class="nc" id="L734">        Connection con = null;</span>
<span class="nc" id="L735">        PreparedStatement pstmt = null;</span>
        try {
<span class="nc" id="L737">            con = DbConnectionManager.getConnection();</span>
<span class="nc" id="L738">            pstmt = con.prepareStatement(UPDATE_SUBJECT);</span>
<span class="nc" id="L739">            pstmt.setString(1, room.getSubject());</span>
<span class="nc" id="L740">            pstmt.setLong(2, room.getID());</span>
<span class="nc" id="L741">            pstmt.executeUpdate();</span>
        }
<span class="nc" id="L743">        catch (SQLException sqle) {</span>
<span class="nc" id="L744">            Log.error(sqle.getMessage(), sqle);</span>
        }
        finally {
<span class="nc" id="L747">            DbConnectionManager.closeConnection(pstmt, con);</span>
<span class="nc" id="L748">        }</span>
<span class="nc" id="L749">    }</span>

    /**
     * Updates the room's lock status in the database.
     *
     * @param room the room to update its lock status in the database.
     */
    public static void updateRoomLock(LocalMUCRoom room) {
<span class="nc bnc" id="L757" title="All 4 branches missed.">        if (!room.isPersistent() || !room.wasSavedToDB()) {</span>
<span class="nc" id="L758">            return;</span>
        }

<span class="nc" id="L761">        Connection con = null;</span>
<span class="nc" id="L762">        PreparedStatement pstmt = null;</span>
        try {
<span class="nc" id="L764">            con = DbConnectionManager.getConnection();</span>
<span class="nc" id="L765">            pstmt = con.prepareStatement(UPDATE_LOCK);</span>
<span class="nc" id="L766">            pstmt.setString(1, StringUtils.dateToMillis(room.getLockedDate()));</span>
<span class="nc" id="L767">            pstmt.setLong(2, room.getID());</span>
<span class="nc" id="L768">            pstmt.executeUpdate();</span>
        }
<span class="nc" id="L770">        catch (SQLException sqle) {</span>
<span class="nc" id="L771">            Log.error(sqle.getMessage(), sqle);</span>
        }
        finally {
<span class="nc" id="L774">            DbConnectionManager.closeConnection(pstmt, con);</span>
<span class="nc" id="L775">        }</span>
<span class="nc" id="L776">    }</span>

    /**
     * Updates the room's lock status in the database.
     *
     * @param room the room to update its lock status in the database.
     */
    public static void updateRoomEmptyDate(MUCRoom room) {
<span class="nc bnc" id="L784" title="All 4 branches missed.">        if (!room.isPersistent() || !room.wasSavedToDB()) {</span>
<span class="nc" id="L785">            return;</span>
        }

<span class="nc" id="L788">        Connection con = null;</span>
<span class="nc" id="L789">        PreparedStatement pstmt = null;</span>
        try {
<span class="nc" id="L791">            con = DbConnectionManager.getConnection();</span>
<span class="nc" id="L792">            pstmt = con.prepareStatement(UPDATE_EMPTYDATE);</span>
<span class="nc" id="L793">            Date emptyDate = room.getEmptyDate();</span>
<span class="nc bnc" id="L794" title="All 2 branches missed.">            if (emptyDate == null) {</span>
<span class="nc" id="L795">                pstmt.setString(1, null);</span>
            }
            else {
<span class="nc" id="L798">                pstmt.setString(1, StringUtils.dateToMillis(emptyDate));</span>
            }
<span class="nc" id="L800">            pstmt.setLong(2, room.getID());</span>
<span class="nc" id="L801">            pstmt.executeUpdate();</span>
        }
<span class="nc" id="L803">        catch (SQLException sqle) {</span>
<span class="nc" id="L804">            Log.error(sqle.getMessage(), sqle);</span>
        }
        finally {
<span class="nc" id="L807">            DbConnectionManager.closeConnection(pstmt, con);</span>
<span class="nc" id="L808">        }</span>
<span class="nc" id="L809">    }</span>

    /**
     * Update the DB with the new affiliation of the user in the room. The new information will be
     * saved only if the room is_persistent and has already been saved to the database previously.
     * 
     * @param room The room where the affiliation of the user was updated.
     * @param jid The bareJID of the user to update this affiliation.
     * @param nickname The reserved nickname of the user in the room or null if none.
     * @param newAffiliation the new affiliation of the user in the room.
     * @param oldAffiliation the previous affiliation of the user in the room.
     */
    public static void saveAffiliationToDB(MUCRoom room, JID jid, String nickname,
            MUCRole.Affiliation newAffiliation, MUCRole.Affiliation oldAffiliation)
    {
<span class="nc" id="L824">        final String affiliationJid = jid.toBareJID();</span>
<span class="nc bnc" id="L825" title="All 4 branches missed.">        if (!room.isPersistent() || !room.wasSavedToDB()) {</span>
<span class="nc" id="L826">            return;</span>
        }
<span class="nc bnc" id="L828" title="All 2 branches missed.">        if (MUCRole.Affiliation.none == oldAffiliation) {</span>
<span class="nc bnc" id="L829" title="All 2 branches missed.">            if (MUCRole.Affiliation.member == newAffiliation) {</span>
                // Add the user to the members table
<span class="nc" id="L831">                Connection con = null;</span>
<span class="nc" id="L832">                PreparedStatement pstmt = null;</span>
                try {
<span class="nc" id="L834">                    con = DbConnectionManager.getConnection();</span>
<span class="nc" id="L835">                    pstmt = con.prepareStatement(ADD_MEMBER);</span>
<span class="nc" id="L836">                    pstmt.setLong(1, room.getID());</span>
<span class="nc" id="L837">                    pstmt.setString(2, affiliationJid);</span>
<span class="nc" id="L838">                    pstmt.setString(3, nickname);</span>
<span class="nc" id="L839">                    pstmt.executeUpdate();</span>
                }
<span class="nc" id="L841">                catch (SQLException sqle) {</span>
<span class="nc" id="L842">                    Log.error(sqle.getMessage(), sqle);</span>
                }
                finally {
<span class="nc" id="L845">                    DbConnectionManager.closeConnection(pstmt, con);</span>
<span class="nc" id="L846">                }</span>
<span class="nc" id="L847">            }</span>
            else {
                // Add the user to the generic affiliations table
<span class="nc" id="L850">                Connection con = null;</span>
<span class="nc" id="L851">                PreparedStatement pstmt = null;</span>
                try {
<span class="nc" id="L853">                    con = DbConnectionManager.getConnection();</span>
<span class="nc" id="L854">                    pstmt = con.prepareStatement(ADD_AFFILIATION);</span>
<span class="nc" id="L855">                    pstmt.setLong(1, room.getID());</span>
<span class="nc" id="L856">                    pstmt.setString(2, affiliationJid);</span>
<span class="nc" id="L857">                    pstmt.setInt(3, newAffiliation.getValue());</span>
<span class="nc" id="L858">                    pstmt.executeUpdate();</span>
                }
<span class="nc" id="L860">                catch (SQLException sqle) {</span>
<span class="nc" id="L861">                    Log.error(sqle.getMessage(), sqle);</span>
                }
                finally {
<span class="nc" id="L864">                    DbConnectionManager.closeConnection(pstmt, con);</span>
<span class="nc" id="L865">                }</span>
<span class="nc" id="L866">            }</span>
        }
        else {
<span class="nc bnc" id="L869" title="All 4 branches missed.">            if (MUCRole.Affiliation.member == newAffiliation &amp;&amp;</span>
                    MUCRole.Affiliation.member == oldAffiliation)
            {
                // Update the member's data in the member table.
<span class="nc" id="L873">                Connection con = null;</span>
<span class="nc" id="L874">                PreparedStatement pstmt = null;</span>
                try {
<span class="nc" id="L876">                    con = DbConnectionManager.getConnection();</span>
<span class="nc" id="L877">                    pstmt = con.prepareStatement(UPDATE_MEMBER);</span>
<span class="nc" id="L878">                    pstmt.setString(1, nickname);</span>
<span class="nc" id="L879">                    pstmt.setLong(2, room.getID());</span>
<span class="nc" id="L880">                    pstmt.setString(3, affiliationJid);</span>
<span class="nc" id="L881">                    pstmt.executeUpdate();</span>
                }
<span class="nc" id="L883">                catch (SQLException sqle) {</span>
<span class="nc" id="L884">                    Log.error(sqle.getMessage(), sqle);</span>
                }
                finally {
<span class="nc" id="L887">                    DbConnectionManager.closeConnection(pstmt, con);</span>
<span class="nc" id="L888">                }</span>
<span class="nc" id="L889">            }</span>
<span class="nc bnc" id="L890" title="All 2 branches missed.">            else if (MUCRole.Affiliation.member == newAffiliation) {</span>
<span class="nc" id="L891">                Connection con = null;</span>
<span class="nc" id="L892">                PreparedStatement pstmt = null;</span>
<span class="nc" id="L893">                boolean abortTransaction = false;</span>
                try {
                    // Remove the user from the generic affiliations table
<span class="nc" id="L896">                    con = DbConnectionManager.getTransactionConnection();</span>
<span class="nc" id="L897">                    pstmt = con.prepareStatement(DELETE_AFFILIATION);</span>
<span class="nc" id="L898">                    pstmt.setLong(1, room.getID());</span>
<span class="nc" id="L899">                    pstmt.setString(2, affiliationJid);</span>
<span class="nc" id="L900">                    pstmt.executeUpdate();</span>
<span class="nc" id="L901">                    DbConnectionManager.fastcloseStmt(pstmt);</span>

                    // Add them as a member.
<span class="nc" id="L904">                    pstmt = con.prepareStatement(ADD_MEMBER);</span>
<span class="nc" id="L905">                    pstmt.setLong(1, room.getID());</span>
<span class="nc" id="L906">                    pstmt.setString(2, affiliationJid);</span>
<span class="nc" id="L907">                    pstmt.setString(3, nickname);</span>
<span class="nc" id="L908">                    pstmt.executeUpdate();</span>
                }
<span class="nc" id="L910">                catch (SQLException sqle) {</span>
<span class="nc" id="L911">                    Log.error(sqle.getMessage(), sqle);</span>
<span class="nc" id="L912">                    abortTransaction = true;</span>
                }
                finally {
<span class="nc" id="L915">                    DbConnectionManager.closeStatement(pstmt);</span>
<span class="nc" id="L916">                    DbConnectionManager.closeTransactionConnection(con, abortTransaction);</span>
<span class="nc" id="L917">                }</span>
<span class="nc" id="L918">            }</span>
<span class="nc bnc" id="L919" title="All 2 branches missed.">            else if (MUCRole.Affiliation.member == oldAffiliation) {</span>
<span class="nc" id="L920">                Connection con = null;</span>
<span class="nc" id="L921">                PreparedStatement pstmt = null;</span>
<span class="nc" id="L922">                boolean abortTransaction = false;</span>
                try {
<span class="nc" id="L924">                    con = DbConnectionManager.getTransactionConnection();</span>
<span class="nc" id="L925">                    pstmt = con.prepareStatement(DELETE_MEMBER);</span>
<span class="nc" id="L926">                    pstmt.setLong(1, room.getID());</span>
<span class="nc" id="L927">                    pstmt.setString(2, affiliationJid);</span>
<span class="nc" id="L928">                    pstmt.executeUpdate();</span>
<span class="nc" id="L929">                    DbConnectionManager.fastcloseStmt(pstmt);</span>

<span class="nc" id="L931">                    pstmt = con.prepareStatement(ADD_AFFILIATION);</span>
<span class="nc" id="L932">                    pstmt.setLong(1, room.getID());</span>
<span class="nc" id="L933">                    pstmt.setString(2, affiliationJid);</span>
<span class="nc" id="L934">                    pstmt.setInt(3, newAffiliation.getValue());</span>
<span class="nc" id="L935">                    pstmt.executeUpdate();</span>
                }
<span class="nc" id="L937">                catch (SQLException sqle) {</span>
<span class="nc" id="L938">                    Log.error(sqle.getMessage(), sqle);</span>
<span class="nc" id="L939">                    abortTransaction = true;</span>
                }
                finally {
<span class="nc" id="L942">                    DbConnectionManager.closeStatement(pstmt);</span>
<span class="nc" id="L943">                    DbConnectionManager.closeTransactionConnection(con, abortTransaction);</span>
<span class="nc" id="L944">                }</span>
<span class="nc" id="L945">            }</span>
            else {
                // Update the user in the generic affiliations table.
<span class="nc" id="L948">                Connection con = null;</span>
<span class="nc" id="L949">                PreparedStatement pstmt = null;</span>
                try {
<span class="nc" id="L951">                    con = DbConnectionManager.getConnection();</span>
<span class="nc" id="L952">                    pstmt = con.prepareStatement(UPDATE_AFFILIATION);</span>
<span class="nc" id="L953">                    pstmt.setInt(1, newAffiliation.getValue());</span>
<span class="nc" id="L954">                    pstmt.setLong(2, room.getID());</span>
<span class="nc" id="L955">                    pstmt.setString(3, affiliationJid);</span>
<span class="nc" id="L956">                    pstmt.executeUpdate();</span>
                }
<span class="nc" id="L958">                catch (SQLException sqle) {</span>
<span class="nc" id="L959">                    Log.error(sqle.getMessage(), sqle);</span>
                }
                finally {
<span class="nc" id="L962">                    DbConnectionManager.closeConnection(pstmt, con);</span>
<span class="nc" id="L963">                }</span>
            }
        }
<span class="nc" id="L966">    }</span>

    /**
     * Removes the affiliation of the user from the DB if the room is persistent.
     * 
     * @param room The room where the affiliation of the user was removed.
     * @param jid The bareJID of the user to remove his affiliation.
     * @param oldAffiliation the previous affiliation of the user in the room.
     */
    public static void removeAffiliationFromDB(MUCRoom room, JID jid,
            MUCRole.Affiliation oldAffiliation)
    {
<span class="nc" id="L978">        final String affiliationJID = jid.toBareJID();</span>
<span class="nc bnc" id="L979" title="All 4 branches missed.">        if (room.isPersistent() &amp;&amp; room.wasSavedToDB()) {</span>
<span class="nc bnc" id="L980" title="All 2 branches missed.">            if (MUCRole.Affiliation.member == oldAffiliation) {</span>
                // Remove the user from the members table
<span class="nc" id="L982">                Connection con = null;</span>
<span class="nc" id="L983">                PreparedStatement pstmt = null;</span>
                try {
<span class="nc" id="L985">                    con = DbConnectionManager.getConnection();</span>
<span class="nc" id="L986">                    pstmt = con.prepareStatement(DELETE_MEMBER);</span>
<span class="nc" id="L987">                    pstmt.setLong(1, room.getID());</span>
<span class="nc" id="L988">                    pstmt.setString(2, affiliationJID);</span>
<span class="nc" id="L989">                    pstmt.executeUpdate();</span>
                }
<span class="nc" id="L991">                catch (SQLException sqle) {</span>
<span class="nc" id="L992">                    Log.error(sqle.getMessage(), sqle);</span>
                }
                finally {
<span class="nc" id="L995">                    DbConnectionManager.closeConnection(pstmt, con);</span>
<span class="nc" id="L996">                }</span>
<span class="nc" id="L997">            }</span>
            else {
                // Remove the user from the generic affiliations table
<span class="nc" id="L1000">                Connection con = null;</span>
<span class="nc" id="L1001">                PreparedStatement pstmt = null;</span>
                try {
<span class="nc" id="L1003">                    con = DbConnectionManager.getConnection();</span>
<span class="nc" id="L1004">                    pstmt = con.prepareStatement(DELETE_AFFILIATION);</span>
<span class="nc" id="L1005">                    pstmt.setLong(1, room.getID());</span>
<span class="nc" id="L1006">                    pstmt.setString(2, affiliationJID);</span>
<span class="nc" id="L1007">                    pstmt.executeUpdate();</span>
                }
<span class="nc" id="L1009">                catch (SQLException sqle) {</span>
<span class="nc" id="L1010">                    Log.error(sqle.getMessage(), sqle);</span>
                }
                finally {
<span class="nc" id="L1013">                    DbConnectionManager.closeConnection(pstmt, con);</span>
<span class="nc" id="L1014">                }</span>
            }
        }
<span class="nc" id="L1017">    }</span>

    /**
     * Removes the affiliation of the user from the DB if ANY room that is persistent.
     *
     * @param affiliationJID The bareJID of the user to remove his affiliation from ALL persistent rooms.
     */
    public static void removeAffiliationFromDB(JID affiliationJID)
    {
<span class="nc" id="L1026">        Connection con = null;</span>
<span class="nc" id="L1027">        PreparedStatement pstmt = null;</span>
        try {
<span class="nc" id="L1029">            con = DbConnectionManager.getConnection();</span>
            // Remove the user from the members table
<span class="nc" id="L1031">            pstmt = con.prepareStatement(DELETE_USER_MEMBER);</span>
<span class="nc" id="L1032">            pstmt.setString(1, affiliationJID.toBareJID());</span>
<span class="nc" id="L1033">            pstmt.executeUpdate();</span>
<span class="nc" id="L1034">            DbConnectionManager.fastcloseStmt(pstmt);</span>

            // Remove the user from the generic affiliations table
<span class="nc" id="L1037">            pstmt = con.prepareStatement(DELETE_USER_MUCAFFILIATION);</span>
<span class="nc" id="L1038">            pstmt.setString(1, affiliationJID.toBareJID());</span>
<span class="nc" id="L1039">            pstmt.executeUpdate();</span>
        }
<span class="nc" id="L1041">        catch (SQLException sqle) {</span>
<span class="nc" id="L1042">            Log.error(sqle.getMessage(), sqle);</span>
        }
        finally {
<span class="nc" id="L1045">            DbConnectionManager.closeConnection(pstmt, con);</span>
<span class="nc" id="L1046">        }</span>
<span class="nc" id="L1047">    }</span>

    /**
     * Saves the conversation log entry batch to the database.
     *
     * @param batch a list of ConversationLogEntry to save to the database.
     * @return true if the batch was saved successfully to the database.
     */
    public static boolean saveConversationLogBatch(List&lt;ConversationLogEntry&gt; batch) {
<span class="nc" id="L1056">        Connection con = null;</span>
<span class="nc" id="L1057">        PreparedStatement pstmt = null;</span>

        try {
<span class="nc" id="L1060">            con = DbConnectionManager.getConnection();</span>
<span class="nc" id="L1061">            pstmt = con.prepareStatement(ADD_CONVERSATION_LOG);</span>
<span class="nc" id="L1062">            con.setAutoCommit(false);</span>

<span class="nc bnc" id="L1064" title="All 2 branches missed.">            for(ConversationLogEntry entry : batch) {</span>
<span class="nc" id="L1065">                pstmt.setLong(1, entry.getRoomID());</span>
<span class="nc" id="L1066">                pstmt.setLong(2, SequenceManager.nextID(JiveConstants.MUC_MESSAGE_ID));</span>
<span class="nc" id="L1067">                pstmt.setString(3, entry.getSender().toString());</span>
<span class="nc" id="L1068">                pstmt.setString(4, entry.getNickname());</span>
<span class="nc" id="L1069">                pstmt.setString(5, StringUtils.dateToMillis(entry.getDate()));</span>
<span class="nc" id="L1070">                pstmt.setString(6, entry.getSubject());</span>
<span class="nc" id="L1071">                pstmt.setString(7, entry.getBody());</span>
<span class="nc" id="L1072">                pstmt.setString(8, entry.getStanza());</span>
<span class="nc" id="L1073">                pstmt.addBatch();</span>
<span class="nc" id="L1074">            }</span>

<span class="nc" id="L1076">            pstmt.executeBatch();</span>
<span class="nc" id="L1077">            con.commit();</span>
<span class="nc" id="L1078">            return true;</span>
        }
<span class="nc" id="L1080">        catch (SQLException sqle) {</span>
<span class="nc" id="L1081">            Log.error(&quot;Error saving conversation log batch&quot;, sqle);</span>
<span class="nc bnc" id="L1082" title="All 2 branches missed.">            if (con != null) {</span>
            	try {
<span class="nc" id="L1084">					con.rollback();</span>
<span class="nc" id="L1085">				} catch (SQLException ignore) {}</span>
            }
<span class="nc" id="L1087">            return false;</span>
        }
        finally {
<span class="nc" id="L1090">            DbConnectionManager.closeConnection(pstmt, con);</span>
<span class="nc" id="L1091">        }</span>
    }

    /**
     * Returns an integer based on the binary representation of the roles to broadcast.
     * 
     * @param room the room to marshall its roles to broadcast.
     * @return an integer based on the binary representation of the roles to broadcast.
     */
    private static int marshallRolesToBroadcast(MUCRoom room) {
<span class="nc" id="L1101">        StringBuilder buffer = new StringBuilder();</span>
<span class="nc bnc" id="L1102" title="All 2 branches missed.">        buffer.append((room.canBroadcastPresence(&quot;moderator&quot;) ? &quot;1&quot; : &quot;0&quot;));</span>
<span class="nc bnc" id="L1103" title="All 2 branches missed.">        buffer.append((room.canBroadcastPresence(&quot;participant&quot;) ? &quot;1&quot; : &quot;0&quot;));</span>
<span class="nc bnc" id="L1104" title="All 2 branches missed.">        buffer.append((room.canBroadcastPresence(&quot;visitor&quot;) ? &quot;1&quot; : &quot;0&quot;));</span>
<span class="nc" id="L1105">        return Integer.parseInt(buffer.toString(), 2);</span>
    }

    /**
     * Returns a Jive property.
     *
     * @param subdomain the subdomain of the service to retrieve a property from
     * @param name the name of the property to return.
     * @return the property value specified by name.
     */
    public static String getProperty(String subdomain, String name) {    	
<span class="nc" id="L1116">        final MUCServiceProperties newProps = new MUCServiceProperties(subdomain);</span>
<span class="nc" id="L1117">        final MUCServiceProperties oldProps = propertyMaps.putIfAbsent(subdomain, newProps);</span>
<span class="nc bnc" id="L1118" title="All 2 branches missed.">        if (oldProps != null) {</span>
<span class="nc" id="L1119">            return oldProps.get(name);</span>
        } else {
<span class="nc" id="L1121">            return newProps.get(name);</span>
        }
    }

    /**
     * Returns a Jive property. If the specified property doesn't exist, the
     * {@code defaultValue} will be returned.
     *
     * @param subdomain the subdomain of the service to retrieve a property from
     * @param name the name of the property to return.
     * @param defaultValue value returned if the property doesn't exist.
     * @return the property value specified by name.
     */
    public static String getProperty(String subdomain, String name, String defaultValue) {
<span class="nc" id="L1135">        final String value = getProperty(subdomain, name);</span>
<span class="nc bnc" id="L1136" title="All 2 branches missed.">        if (value != null) {</span>
<span class="nc" id="L1137">            return value;</span>
        } else {
<span class="nc" id="L1139">            return defaultValue;</span>
        }
    }

    /**
     * Returns an integer value Jive property. If the specified property doesn't exist, the
     * {@code defaultValue} will be returned.
     *
     * @param subdomain the subdomain of the service to retrieve a property from
     * @param name the name of the property to return.
     * @param defaultValue value returned if the property doesn't exist or was not
     *      a number.
     * @return the property value specified by name or {@code defaultValue}.
     */
    public static int getIntProperty(String subdomain, String name, int defaultValue) {
<span class="nc" id="L1154">        String value = getProperty(subdomain, name);</span>
<span class="nc bnc" id="L1155" title="All 2 branches missed.">        if (value != null) {</span>
            try {
<span class="nc" id="L1157">                return Integer.parseInt(value);</span>
            }
<span class="nc" id="L1159">            catch (NumberFormatException nfe) {</span>
                // Ignore.
            }
        }
<span class="nc" id="L1163">        return defaultValue;</span>
    }

    /**
     * Returns a long value Jive property. If the specified property doesn't exist, the
     * {@code defaultValue} will be returned.
     *
     * @param subdomain the subdomain of the service to retrieve a property from
     * @param name the name of the property to return.
     * @param defaultValue value returned if the property doesn't exist or was not
     *      a number.
     * @return the property value specified by name or {@code defaultValue}.
     */
    public static long getLongProperty(String subdomain, String name, long defaultValue) {
<span class="nc" id="L1177">        String value = getProperty(subdomain, name);</span>
<span class="nc bnc" id="L1178" title="All 2 branches missed.">        if (value != null) {</span>
            try {
<span class="nc" id="L1180">                return Long.parseLong(value);</span>
            }
<span class="nc" id="L1182">            catch (NumberFormatException nfe) {</span>
                // Ignore.
            }
        }
<span class="nc" id="L1186">        return defaultValue;</span>
    }

    /**
     * Returns a boolean value Jive property.
     *
     * @param subdomain the subdomain of the service to retrieve a property from
     * @param name the name of the property to return.
     * @return true if the property value exists and is set to {@code &quot;true&quot;} (ignoring case).
     *      Otherwise {@code false} is returned.
     */
    public static boolean getBooleanProperty(String subdomain, String name) {
<span class="nc" id="L1198">        return Boolean.valueOf(getProperty(subdomain, name));</span>
    }

    /**
     * Returns a boolean value Jive property. If the property doesn't exist, the {@code defaultValue}
     * will be returned.
     *
     * If the specified property can't be found, or if the value is not a number, the
     * {@code defaultValue} will be returned.
     *
     * @param subdomain the subdomain of the service to retrieve a property from
     * @param name the name of the property to return.
     * @param defaultValue value returned if the property doesn't exist.
     * @return true if the property value exists and is set to {@code &quot;true&quot;} (ignoring case).
     *      Otherwise {@code false} is returned.
     */
    public static boolean getBooleanProperty(String subdomain, String name, boolean defaultValue) {
<span class="nc" id="L1215">        String value = getProperty(subdomain, name);</span>
<span class="nc bnc" id="L1216" title="All 2 branches missed.">        if (value != null) {</span>
<span class="nc" id="L1217">            return Boolean.valueOf(value);</span>
        }
        else {
<span class="nc" id="L1220">            return defaultValue;</span>
        }
    }

    /**
     * Return all immediate children property names of a parent Jive property as a list of strings,
     * or an empty list if there are no children. For example, given
     * the properties {@code X.Y.A}, {@code X.Y.B}, {@code X.Y.C} and {@code X.Y.C.D}, then
     * the immediate child properties of {@code X.Y} are {@code A}, {@code B}, and
     * {@code C} ({@code C.D} would not be returned using this method).&lt;p&gt;
     *
     * @param subdomain the subdomain of the service to retrieve a property from
     * @param parent the root &quot;node&quot; of the properties to retrieve
     * @return a List of all immediate children property names (Strings).
     */
    public static List&lt;String&gt; getPropertyNames(String subdomain, String parent) {
<span class="nc" id="L1236">        MUCServiceProperties properties = new MUCServiceProperties(subdomain);</span>
<span class="nc" id="L1237">        final MUCServiceProperties oldProps = propertyMaps.putIfAbsent(subdomain, properties);</span>
<span class="nc bnc" id="L1238" title="All 2 branches missed.">        if (oldProps != null) {</span>
<span class="nc" id="L1239">            properties = oldProps;</span>
        } 
<span class="nc" id="L1241">        return new ArrayList&lt;&gt;(properties.getChildrenNames(parent));</span>
    }

    /**
     * Return all immediate children property values of a parent Jive property as a list of strings,
     * or an empty list if there are no children. For example, given
     * the properties {@code X.Y.A}, {@code X.Y.B}, {@code X.Y.C} and {@code X.Y.C.D}, then
     * the immediate child properties of {@code X.Y} are {@code X.Y.A}, {@code X.Y.B}, and
     * {@code X.Y.C} (the value of {@code X.Y.C.D} would not be returned using this method).&lt;p&gt;
     *
     * @param subdomain the subdomain of the service to retrieve a property from
     * @param parent the name of the parent property to return the children for.
     * @return all child property values for the given parent.
     */
    public static List&lt;String&gt; getProperties(String subdomain, String parent) {
<span class="nc" id="L1256">        MUCServiceProperties properties = new MUCServiceProperties(subdomain);</span>
<span class="nc" id="L1257">        final MUCServiceProperties oldProps = propertyMaps.putIfAbsent(subdomain, properties);</span>
<span class="nc bnc" id="L1258" title="All 2 branches missed.">        if (oldProps != null) {</span>
<span class="nc" id="L1259">            properties = oldProps;</span>
        } 

<span class="nc" id="L1262">        Collection&lt;String&gt; propertyNames = properties.getChildrenNames(parent);</span>
<span class="nc" id="L1263">        List&lt;String&gt; values = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L1264" title="All 2 branches missed.">        for (String propertyName : propertyNames) {</span>
<span class="nc" id="L1265">            String value = getProperty(subdomain, propertyName);</span>
<span class="nc bnc" id="L1266" title="All 2 branches missed.">            if (value != null) {</span>
<span class="nc" id="L1267">                values.add(value);</span>
            }
<span class="nc" id="L1269">        }</span>

<span class="nc" id="L1271">        return values;</span>
    }

    /**
     * Returns all MUC service property names.
     *
     * @param subdomain the subdomain of the service to retrieve a property from
     * @return a List of all property names (Strings).
     */
    public static List&lt;String&gt; getPropertyNames(String subdomain) {
<span class="nc" id="L1281">        MUCServiceProperties properties = new MUCServiceProperties(subdomain);</span>
<span class="nc" id="L1282">        final MUCServiceProperties oldProps = propertyMaps.putIfAbsent(subdomain, properties);</span>
<span class="nc bnc" id="L1283" title="All 2 branches missed.">        if (oldProps != null) {</span>
<span class="nc" id="L1284">            properties = oldProps;</span>
        } 
<span class="nc" id="L1286">        return new ArrayList&lt;&gt;(properties.getPropertyNames());</span>
    }

    /**
     * Sets a Jive property. If the property doesn't already exists, a new
     * one will be created.
     *
     * @param subdomain the subdomain of the service to set a property for
     * @param name the name of the property being set.
     * @param value the value of the property being set.
     */
    public static void setProperty(String subdomain, String name, String value) {
<span class="nc" id="L1298">        MUCServiceProperties properties = propertyMaps.get(subdomain);</span>
<span class="nc bnc" id="L1299" title="All 2 branches missed.">        if (properties == null) {</span>
<span class="nc" id="L1300">            properties = new MUCServiceProperties(subdomain);</span>
        }
<span class="nc" id="L1302">        properties.put(name, value);</span>
<span class="nc" id="L1303">        propertyMaps.put(subdomain, properties);</span>
<span class="nc" id="L1304">    }</span>

    public static void setLocalProperty(String subdomain, String name, String value) {
<span class="nc" id="L1307">        MUCServiceProperties properties = propertyMaps.get(subdomain);</span>
<span class="nc bnc" id="L1308" title="All 2 branches missed.">        if (properties == null) {</span>
<span class="nc" id="L1309">            properties = new MUCServiceProperties(subdomain);</span>
        }
<span class="nc" id="L1311">        properties.localPut(name, value);</span>
<span class="nc" id="L1312">        propertyMaps.put(subdomain, properties);</span>
<span class="nc" id="L1313">    }</span>

   /**
     * Sets multiple Jive properties at once. If a property doesn't already exists, a new
     * one will be created.
     *
    * @param subdomain the subdomain of the service to set properties for
     * @param propertyMap a map of properties, keyed on property name.
     */
    public static void setProperties(String subdomain, Map&lt;String, String&gt; propertyMap) {
<span class="nc" id="L1323">        MUCServiceProperties properties = propertyMaps.get(subdomain);</span>
<span class="nc bnc" id="L1324" title="All 2 branches missed.">        if (properties == null) {</span>
<span class="nc" id="L1325">            properties = new MUCServiceProperties(subdomain);</span>
        }
<span class="nc" id="L1327">        properties.putAll(propertyMap);</span>
<span class="nc" id="L1328">        propertyMaps.put(subdomain, properties);</span>
<span class="nc" id="L1329">    }</span>

    /**
     * Deletes a Jive property. If the property doesn't exist, the method
     * does nothing. All children of the property will be deleted as well.
     *
     * @param subdomain the subdomain of the service to delete a property from
     * @param name the name of the property to delete.
     */
    public static void deleteProperty(String subdomain, String name) {
<span class="nc" id="L1339">        MUCServiceProperties properties = propertyMaps.get(subdomain);</span>
<span class="nc bnc" id="L1340" title="All 2 branches missed.">        if (properties == null) {</span>
<span class="nc" id="L1341">            properties = new MUCServiceProperties(subdomain);</span>
        }
<span class="nc" id="L1343">        properties.remove(name);</span>
<span class="nc" id="L1344">        propertyMaps.put(subdomain, properties);</span>
<span class="nc" id="L1345">    }</span>

    public static void deleteLocalProperty(String subdomain, String name) {
<span class="nc" id="L1348">        MUCServiceProperties properties = propertyMaps.get(subdomain);</span>
<span class="nc bnc" id="L1349" title="All 2 branches missed.">        if (properties == null) {</span>
<span class="nc" id="L1350">            properties = new MUCServiceProperties(subdomain);</span>
        }
<span class="nc" id="L1352">        properties.localRemove(name);</span>
<span class="nc" id="L1353">        propertyMaps.put(subdomain, properties);</span>
<span class="nc" id="L1354">    }</span>

    /**
     * Resets (reloads) the properties for a specified subdomain.
     *
     * @param subdomain the subdomain of the service to reload properties for.
     */
    public static void refreshProperties(String subdomain) {
<span class="nc" id="L1362">        propertyMaps.replace(subdomain, new MUCServiceProperties(subdomain));</span>
<span class="nc" id="L1363">    }</span>
    
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>